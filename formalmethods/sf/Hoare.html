<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
<link href="coqdoc.css" rel="stylesheet" type="text/css"/>
<title>Hoare: Hoare Logic</title>
</head>

<script>
<!--
  function toggleDisplay(id)
  {
     var elt = document.getElementById(id);
     if (elt.style.display == 'none') {
       elt.style.display = 'block';
     } else {
       elt.style.display = 'none';
     }
  }
  function hideAll(cls)
  {
    var testClass = new RegExp("(^|s)" + cls + "(s|$)");
    var tag = tag || "*";
    var elements = document.getElementsByTagName("div");
    var current;
    var length = elements.length;
    for(var i=0; i<length; i++){
      current = elements[i];
      if(testClass.test(current.className)) {
        current.style.display = 'none';
      }
    }
  }
// --> 
</script>

<body onLoad="hideAll('proofscript')">
<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Hoare<span class="subtitle">Hoare Logic</span></h1>

<div class="code code-tight">
</div>

<div class="doc">

</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;$Date:&nbsp;2012-05-12&nbsp;10:20:28&nbsp;-0400&nbsp;(Sat,&nbsp;12&nbsp;May&nbsp;2012)&nbsp;$&nbsp;*)</span><br/>

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Export</span> <span class="id" type="var">Imp</span>.<br/>

<br/>
</div>

<div class="doc">
In the past couple of chapters, we've begun applying the
    mathematical tools developed in the first part of the course to
    studying the theory of a small programming language, Imp.

<div class="paragraph"> </div>

<ul class="doclist">
<li> We defined a type of <i>abstract syntax trees</i> for Imp, together
      with an <i>evaluation relation</i> (a partial function on states)
      that specifies the <i>operational semantics</i> of programs.

<div class="paragraph"> </div>

      The language we defined, though small, captures some of the key
      features of full-blown languages like C, C++, and Java,
      including the fundamental notion of mutable state and some
      common control structures.

<div class="paragraph"> </div>


</li>
<li> We proved a number of <i>metatheoretic properties</i> &mdash; "meta" in
      the sense that they are properties of the language as a whole,
      rather than properties of particular programs in the language.
      These included:

<div class="paragraph"> </div>

<ul class="doclist">
<li> determinism of evaluation

<div class="paragraph"> </div>


</li>
<li> equivalence of some different ways of writing down the
          definitions (e.g. functional and relational definitions of
          arithmetic expression evaluation)

<div class="paragraph"> </div>


</li>
<li> guaranteed termination of certain classes of programs

<div class="paragraph"> </div>


</li>
<li> correctness (in the sense of preserving meaning) of a number
          of useful program transformations

<div class="paragraph"> </div>


</li>
<li> behavioral equivalence of programs (in the optional chapter
          <span class="inlinecode"><span class="id" type="var">Equiv</span></span>).

<div class="paragraph"> </div>


</li>
</ul>
      If we stopped here, we would still have something useful: a set
      of tools for defining and discussing programming languages and
      language features that are mathematically precise, flexible, and
      easy to work with, applied to a set of key properties.  All of
      these properties are things that language designers, compiler
      writers, and users might care about knowing.  Indeed, many of
      them are so fundamental to our understanding of the programming
      languages we deal with that we might not consciously recognize
      them as "theorems."  But properties that seem intuitively
      obvious can sometimes be quite subtle &mdash; or, in some cases,
      actually even wrong!

<div class="paragraph"> </div>

      We'll return to this theme later in the course when we discuss
      <i>types</i> and <i>type soundness</i>.

<div class="paragraph"> </div>


</li>
<li> We saw a couple of examples of <i>program verification</i> &mdash; using
      the precise definition of Imp to prove formally that certain
      particular programs (e.g., factorial and slow subtraction)
      satisfied particular specifications of their behavior. 
</li>
</ul>

<div class="paragraph"> </div>

 In this chapter, we'll take this last idea further.  We'll
    develop a reasoning system called <i>Floyd-Hoare Logic</i> &mdash; commonly
    shortened to just <i>Hoare Logic</i> &mdash; in which each of the syntactic
    constructs of Imp is equipped with a single, generic "proof rule"
    that can be used to reason about programs involving this
    construct.

<div class="paragraph"> </div>

    Hoare Logic originates in the 1960s, and it continues to be the
    subject of intensive research right up to the present day.  It
    lies at the core of a huge variety of tools that are now being
    used to specify and verify real software systems. 
</div>
<div class="code code-tight">

<br/>

<br/>
</div>

<div class="doc">
<a name="lab394"></a><h1 class="section">Hoare Logic</h1>

<div class="paragraph"> </div>

 Hoare Logic combines two beautiful ideas: a natural way of
    writing down <i>specifications</i> of programs, and a <i>compositional
    proof technique</i> for proving that these specifications are met &mdash;
    where by "compositional" we mean that the structure of proofs
    directly mirrors the structure of the programs that they are
    about. 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab395"></a><h2 class="section">Assertions</h2>

<div class="paragraph"> </div>

 If we're going to talk about specifications of programs, the
    first thing we'll want is a way of making <i>assertions</i> about
    properties that hold at particular points during a program's
    execution &mdash; i.e., properties that may or may not be true of a
    given state of the memory. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">Assertion</span> := <span class="id" type="var">state</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab396"></a><h4 class="section">Exercise: 1 star (assertions)</h4>
 Paraphrase the following assertions in English.

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;1)&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;3<br/>
&nbsp;&nbsp;&nbsp;2)&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span><br/>
&nbsp;&nbsp;&nbsp;3)&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Y</span><br/>
&nbsp;&nbsp;&nbsp;4)&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;3&nbsp;<span style="font-family: arial;">&or;</span>&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Y</span><br/>
&nbsp;&nbsp;&nbsp;5)&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Z</span>&nbsp;*&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Z</span>&nbsp;&lt;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~&nbsp;(((<span class="id" type="var">S</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Z</span>))&nbsp;*&nbsp;(<span class="id" type="var">S</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Z</span>)))&nbsp;&lt;=&nbsp;<span class="id" type="var">x</span>)<br/>
&nbsp;&nbsp;&nbsp;6)&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;&nbsp;<span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;7)&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;&nbsp;<span class="id" type="var">False</span>
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

 This way of writing assertions is formally correct &mdash; it
    precisely captures what we mean, and it is exactly what we will
    use in Coq proofs.  We'll also want a lighter, less formal
    notation for discussing examples, since this one is a bit
    heavy: (1) every single assertion that we ever write is going to
    begin with <span class="inlinecode"><span class="id" type="keyword">fun</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode">=&gt;</span> <span class="inlinecode"></span>; and (2) this state <span class="inlinecode"><span class="id" type="var">st</span></span> is the only one that
    we ever use to look up variables (we will never need to talk about
    two different memory states at the same time). So, when writing down
    assertions informally, we'll make some simplifications:
    drop the initial <span class="inlinecode"><span class="id" type="keyword">fun</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode">=&gt;</span>, and write just <span class="inlinecode"><span class="id" type="var">X</span></span> instead of <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">X</span></span>.  Informally, instead of writing

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Z</span>)&nbsp;*&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Z</span>)&nbsp;&lt;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~&nbsp;((<span class="id" type="var">S</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Z</span>))&nbsp;*&nbsp;(<span class="id" type="var">S</span>&nbsp;(<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Z</span>))&nbsp;&lt;=&nbsp;<span class="id" type="var">x</span>)
<div class="paragraph"> </div>

</div>
    we'll write just

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;*&nbsp;<span class="id" type="var">Z</span>&nbsp;&lt;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~((<span class="id" type="var">S</span>&nbsp;<span class="id" type="var">Z</span>)&nbsp;*&nbsp;(<span class="id" type="var">S</span>&nbsp;<span class="id" type="var">Z</span>)&nbsp;&lt;=&nbsp;<span class="id" type="var">x</span>).
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab397"></a><h2 class="section">Hoare Triples</h2>

<div class="paragraph"> </div>

 Next, we need a way of specifying &mdash; making claims about &mdash; the
    behavior of commands. 
<div class="paragraph"> </div>

 Since we've defined assertions as a way of making claims about the
    properties of states, and since the behavior of a command is to
    transform one state to another, it is natural to express claims
    about commands in the following way:

<div class="paragraph"> </div>

<ul class="doclist">
<li> "If command <span class="inlinecode"><span class="id" type="var">c</span></span> is started in a state satisfying assertion
        <span class="inlinecode"><span class="id" type="var">P</span></span>, and if <span class="inlinecode"><span class="id" type="var">c</span></span> eventually terminates, then the final state is
        guaranteed to satisfy the assertion <span class="inlinecode"><span class="id" type="var">Q</span></span>."

</li>
</ul>

<div class="paragraph"> </div>

    Such a claim is called a <i>Hoare Triple</i>.  The property <span class="inlinecode"><span class="id" type="var">P</span></span> is
    called the <i>precondition</i> of <span class="inlinecode"><span class="id" type="var">c</span></span>, while <span class="inlinecode"><span class="id" type="var">Q</span></span> is the <i>postcondition</i>
    of <span class="inlinecode"><span class="id" type="var">c</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">hoare_triple</span> (<span class="id" type="var">P</span>:<span class="id" type="var">Assertion</span>) (<span class="id" type="var">c</span>:<span class="id" type="var">com</span>) (<span class="id" type="var">Q</span>:<span class="id" type="var">Assertion</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> <span class="id" type="var">st'</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span>  <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">P</span> <span class="id" type="var">st</span>  <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Q</span> <span class="id" type="var">st'</span>.<br/>

<br/>
</div>

<div class="doc">
Since we'll be working a lot with Hoare triples, it's useful to
    have a compact notation:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">P</span>}}&nbsp;&nbsp;<span class="id" type="var">c</span>&nbsp;&nbsp;{{<span class="id" type="var">Q</span>}}.
<div class="paragraph"> </div>

</div>
 (Traditionally, Hoare triples are written <span class="inlinecode">{<span class="id" type="var">P</span>}</span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode">{<span class="id" type="var">Q</span>}</span>, but single
    braces are already used for other things in Coq.)  
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Notation</span> "{{ P }}  c  {{ Q }}" := (<span class="id" type="var">hoare_triple</span> <span class="id" type="var">P</span> <span class="id" type="var">c</span> <span class="id" type="var">Q</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 90, <span class="id" type="var">c</span> <span class="id" type="tactic">at</span> <span class="id" type="var">next</span> <span class="id" type="var">level</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" type="var">hoare_spec_scope</span>.<br/>
<span class="id" type="keyword">Open</span> <span class="id" type="keyword">Scope</span> <span class="id" type="var">hoare_spec_scope</span>.<br/>

<br/>
</div>

<div class="doc">
(The <span class="inlinecode"><span class="id" type="var">hoare_spec_scope</span></span> annotation here tells Coq that this
    notation is not global but is intended to be used in particular
    contexts.  The <span class="inlinecode"><span class="id" type="keyword">Open</span></span> <span class="inlinecode"><span class="id" type="keyword">Scope</span></span> tells Coq that this file is one such
    context.  The first notation &mdash; with missing postcondition &mdash; will
    not actually be used for a while; it's just a placeholder for a
    notation that we'll want to define later, when we discuss
    decorated programs.) 
<div class="paragraph"> </div>

<a name="lab398"></a><h4 class="section">Exercise: 1 star (triples)</h4>
 Paraphrase the following Hoare triples in English.  

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;1)&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<span class="id" type="var">c</span>&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;5}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;2)&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>}}&nbsp;<span class="id" type="var">c</span>&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;+&nbsp;5)}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;3)&nbsp;{{<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;<span class="id" type="var">Y</span>}}&nbsp;<span class="id" type="var">c</span>&nbsp;{{<span class="id" type="var">Y</span>&nbsp;&lt;=&nbsp;<span class="id" type="var">X</span>}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;4)&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<span class="id" type="var">c</span>&nbsp;{{<span class="id" type="var">False</span>}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;5)&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">real_fact</span>&nbsp;<span class="id" type="var">x</span>}}.<br/>
<br/>
&nbsp;&nbsp;&nbsp;6)&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{(<span class="id" type="var">Z</span>&nbsp;*&nbsp;<span class="id" type="var">Z</span>)&nbsp;&lt;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~&nbsp;(((<span class="id" type="var">S</span>&nbsp;<span class="id" type="var">Z</span>)&nbsp;*&nbsp;(<span class="id" type="var">S</span>&nbsp;<span class="id" type="var">Z</span>))&nbsp;&lt;=&nbsp;<span class="id" type="var">x</span>)}}
<div class="paragraph"> </div>

</div>
 
</div>
<div class="code code-tight">
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab399"></a><h4 class="section">Exercise: 1 star (valid_triples)</h4>
 Which of the following Hoare triples are <i>valid</i> &mdash; i.e., the
    claimed relation between <span class="inlinecode"><span class="id" type="var">P</span></span>, <span class="inlinecode"><span class="id" type="var">c</span></span>, and <span class="inlinecode"><span class="id" type="var">Q</span></span> is true?  

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;1)&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;5&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;5}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;2)&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;2}}&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;3}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;3)&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;5;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;0&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;5}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;4)&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;2&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;3}}&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;5&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;0}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;5)&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<span class="id" type="var">SKIP</span>&nbsp;{{<span class="id" type="var">False</span>}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;6)&nbsp;{{<span class="id" type="var">False</span>}}&nbsp;<span class="id" type="var">SKIP</span>&nbsp;{{<span class="id" type="var">True</span>}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;7)&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">True</span>&nbsp;<span class="id" type="var">DO</span>&nbsp;<span class="id" type="var">SKIP</span>&nbsp;<span class="id" type="var">END</span>&nbsp;{{<span class="id" type="var">False</span>}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;8)&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;0}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">X</span>&nbsp;==&nbsp;0&nbsp;<span class="id" type="var">DO</span>&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;<span class="id" type="var">END</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;1}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;9)&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;1}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;<span class="id" type="var">DO</span>&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;<span class="id" type="var">END</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;100}}
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

 (Note that we're using informal mathematical notations for
   expressions inside of commands, for readability.  We'll continue
   doing so throughout the chapter.) 
<div class="paragraph"> </div>

 To get us warmed up, here are two simple facts about Hoare
    triples. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">hoare_post_true</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">P</span> <span class="id" type="var">Q</span> : <span class="id" type="var">Assertion</span>) <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span>, <span class="id" type="var">Q</span> <span class="id" type="var">st</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">c</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">hoare_triple</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">Heval</span> <span class="id" type="var">HP</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">hoare_pre_false</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">P</span> <span class="id" type="var">Q</span> : <span class="id" type="var">Assertion</span>) <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span>, ~(<span class="id" type="var">P</span> <span class="id" type="var">st</span>)) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">c</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">hoare_triple</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">Heval</span> <span class="id" type="var">HP</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">not</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">HP</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">HP</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab400"></a><h2 class="section">Weakest Preconditions</h2>

<div class="paragraph"> </div>

 Some Hoare triples are more interesting than others.
    For example,

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">False</span>&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;1&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5&nbsp;}}
<div class="paragraph"> </div>

</div>
    is <i>not</i> very interesting: it is perfectly valid, but it tells us
    nothing useful.  Since the precondition isn't satisfied by any
    state, it doesn't describe any situations where we can use the
    command <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">::=</span> <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode">+</span> <span class="inlinecode">1</span> to achieve the postcondition <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">&lt;=</span> <span class="inlinecode">5</span>.

<div class="paragraph"> </div>

    By contrast, 

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;&lt;=&nbsp;4&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Z</span>&nbsp;=&nbsp;0&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;1&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5&nbsp;}}
<div class="paragraph"> </div>

</div>
    is useful: it tells us that, if we can somehow create a situation
    in which we know that <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode">&lt;=</span> <span class="inlinecode">4</span> <span class="inlinecode"><span style="font-family: arial;">&and;</span></span> <span class="inlinecode"><span class="id" type="var">Z</span></span> <span class="inlinecode">=</span> <span class="inlinecode">0</span>, then running this command
    will produce a state satisfying the postcondition.  However, this
    triple is still not as useful as it could be, because the <span class="inlinecode"><span class="id" type="var">Z</span></span> <span class="inlinecode">=</span> <span class="inlinecode">0</span>
    clause in the precondition actually has nothing to do with the
    postcondition <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">&lt;=</span> <span class="inlinecode">5</span>.  The <i>most</i> useful triple (for a given
    command and postcondition) is this one:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;&lt;=&nbsp;4&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;1&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5&nbsp;}}
<div class="paragraph"> </div>

</div>
    In other words, <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode">&lt;=</span> <span class="inlinecode">4</span> is the <i>weakest</i> valid precondition of
    the command <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">::=</span> <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode">+</span> <span class="inlinecode">1</span> for the postcondition <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">&lt;=</span> <span class="inlinecode">5</span>. 
<div class="paragraph"> </div>

 In general, we say that "<span class="inlinecode"><span class="id" type="var">P</span></span> is the weakest precondition of
    command <span class="inlinecode"><span class="id" type="var">c</span></span> for postcondition <span class="inlinecode"><span class="id" type="var">Q</span></span>" if

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode">{{<span class="id" type="var">P</span>}}</span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode">{{<span class="id" type="var">Q</span>}}</span>, and

<div class="paragraph"> </div>


</li>
<li> whenever <span class="inlinecode"><span class="id" type="var">P'</span></span> is an assertion such that <span class="inlinecode">{{<span class="id" type="var">P'</span>}}</span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode">{{<span class="id" type="var">Q</span>}}</span>, we
      have <span class="inlinecode"><span class="id" type="var">P'</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> implies <span class="inlinecode"><span class="id" type="var">P</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> for all states <span class="inlinecode"><span class="id" type="var">st</span></span>.  
</li>
</ul>

<div class="paragraph"> </div>

 That is, <span class="inlinecode"><span class="id" type="var">P</span></span> is the weakest precondition of <span class="inlinecode"><span class="id" type="var">c</span></span> for <span class="inlinecode"><span class="id" type="var">Q</span></span>
    if (a) <span class="inlinecode"><span class="id" type="var">P</span></span> <i>is</i> a precondition for <span class="inlinecode"><span class="id" type="var">Q</span></span> and <span class="inlinecode"><span class="id" type="var">c</span></span>, and (b) <span class="inlinecode"><span class="id" type="var">P</span></span> is the
    <i>weakest</i> (easiest to satisfy) assertion that guarantees <span class="inlinecode"><span class="id" type="var">Q</span></span> after
    executing <span class="inlinecode"><span class="id" type="var">c</span></span>. 
<div class="paragraph"> </div>

 The second of the conditions above is essentially a form of
    logical implication at the level of assertions. Because of the
    frequency of its occurrence, it is useful to define a little
    notation: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">assert_implies</span> (<span class="id" type="var">P</span> <span class="id" type="var">Q</span> : <span class="id" type="var">Assertion</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span>, <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Q</span> <span class="id" type="var">st</span>.<br/>

<br/>
</div>

<div class="doc">
We will write <span class="inlinecode"><span class="id" type="var">P</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8669;</span></span> <span class="inlinecode"><span class="id" type="var">Q</span></span> (in ASCII, <span class="inlinecode"><span class="id" type="var">P</span></span> <span class="inlinecode">~</span><span class="inlinecode">~&gt;</span> <span class="inlinecode"><span class="id" type="var">Q</span></span>) for <span class="inlinecode"><span class="id" type="var">assert_implies</span></span>
    <span class="inlinecode"><span class="id" type="var">P</span></span> <span class="inlinecode"><span class="id" type="var">Q</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Notation</span> "P <span style="font-family: arial;">&#8669;</span> Q" := (<span class="id" type="var">assert_implies</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80).<br/>
<span class="id" type="keyword">Notation</span> "P <span style="font-family: arial;">&#8621;</span> Q" := (<span class="id" type="var">P</span> <span style="font-family: arial;">&#8669;</span> <span class="id" type="var">Q</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">Q</span> <span style="font-family: arial;">&#8669;</span> <span class="id" type="var">P</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80).<br/>

<br/>
</div>

<div class="doc">
<a name="lab401"></a><h4 class="section">Exercise: 1 star (wp)</h4>
 What are the weakest preconditions of the following commands
   for the following postconditions?

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;1)&nbsp;{{&nbsp;?&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">SKIP</span>&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;5&nbsp;}}<br/>
<br/>
&nbsp;&nbsp;2)&nbsp;{{&nbsp;?&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;<span class="id" type="var">Z</span>&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;5&nbsp;}}<br/>
<br/>
&nbsp;&nbsp;3)&nbsp;{{&nbsp;?&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">Y</span>&nbsp;}}<br/>
<br/>
&nbsp;&nbsp;4)&nbsp;{{&nbsp;?&nbsp;}}&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span>&nbsp;<span class="id" type="var">X</span>&nbsp;==&nbsp;0&nbsp;<span class="id" type="var">THEN</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">Z</span>&nbsp;+&nbsp;1&nbsp;<span class="id" type="var">ELSE</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">W</span>&nbsp;+&nbsp;2&nbsp;<span class="id" type="var">FI</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;5&nbsp;}}<br/>
<br/>
&nbsp;&nbsp;5)&nbsp;{{&nbsp;?&nbsp;}}&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;5<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;0&nbsp;}}<br/>
<br/>
&nbsp;&nbsp;6)&nbsp;{{&nbsp;?&nbsp;}}&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">True</span>&nbsp;<span class="id" type="var">DO</span>&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;0&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;0&nbsp;}}
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab402"></a><h4 class="section">Exercise: 3 stars, optional (is_wp_formal)</h4>
 Weakest preconditions can be defined formally as follows: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">is_wp</span> <span class="id" type="var">P</span> <span class="id" type="var">c</span> <span class="id" type="var">Q</span> :=<br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q</span>}} <span style="font-family: arial;">&and;</span><br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span><span class="id" type="var">P'</span>, {{<span class="id" type="var">P'</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q</span>}} <span style="font-family: arial;">&rarr;</span> (<span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span>, <span class="id" type="var">P'</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">P</span> <span class="id" type="var">st</span>).<br/>

<br/>
</div>

<div class="doc">
Prove formally using the definition of <span class="inlinecode"><span class="id" type="var">hoare_triple</span></span> that <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode">&lt;=</span> <span class="inlinecode">4</span>
   is indeed the weakest precondition of <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">::=</span> <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode">+</span> <span class="inlinecode">1</span> with respect to
   postcondition <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">&lt;=</span> <span class="inlinecode">5</span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">is_wp_example</span> :<br/>
&nbsp;&nbsp;<span class="id" type="var">is_wp</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">Y</span> &lt;= 4)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">X</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>) (<span class="id" type="var">ANum</span> 1)) (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> &lt;= 5).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab403"></a><h2 class="section">Proof Rules</h2>

<div class="paragraph"> </div>

 The goal of Hoare logic is to provide a <i>compositional</i>
    method for proving the validity of Hoare triples.  That is, the
    structure of a program's correctness proof should mirror the
    structure of the program itself.  To this end, in the sections
    below, we'll introduce one rule for reasoning about each of the
    different syntactic forms of commands in Imp &mdash; one for
    assignment, one for sequencing, one for conditionals, etc. &mdash; plus
    a couple of "structural" rules that are useful for gluing things
    together. We will prove programs correct using these proof rules,
    without ever unfolding the definition of <span class="inlinecode"><span class="id" type="var">hoare_triple</span></span>. 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab404"></a><h3 class="section">Assignment</h3>

<div class="paragraph"> </div>

 The rule for assignment is the most fundamental of the Hoare logic
    proof rules.  Here's how it works.

<div class="paragraph"> </div>

    Consider this (valid) Hoare triple:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;1&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;1&nbsp;}}
<div class="paragraph"> </div>

</div>
    In English: if we start out in a state where the value of <span class="inlinecode"><span class="id" type="var">Y</span></span>
    is <span class="inlinecode">1</span> and we assign <span class="inlinecode"><span class="id" type="var">Y</span></span> to <span class="inlinecode"><span class="id" type="var">X</span></span>, then we'll finish in a
    state where <span class="inlinecode"><span class="id" type="var">X</span></span> is <span class="inlinecode">1</span>.  That is, the property of being equal
    to <span class="inlinecode">1</span> gets transferred from <span class="inlinecode"><span class="id" type="var">Y</span></span> to <span class="inlinecode"><span class="id" type="var">X</span></span>.

<div class="paragraph"> </div>

    Similarly, in

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;<span class="id" type="var">Z</span>&nbsp;=&nbsp;1&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;<span class="id" type="var">Z</span>&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;1&nbsp;}}
<div class="paragraph"> </div>

</div>
    the same property (being equal to one) gets transferred to
    <span class="inlinecode"><span class="id" type="var">X</span></span> from the expression <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode">+</span> <span class="inlinecode"><span class="id" type="var">Z</span></span> on the right-hand side of
    the assignment.

<div class="paragraph"> </div>

    More generally, if <span class="inlinecode"><span class="id" type="var">a</span></span> is <i>any</i> arithmetic expression, then

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">a</span>&nbsp;=&nbsp;1&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">a</span>&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;1&nbsp;}}
<div class="paragraph"> </div>

</div>
    is a valid Hoare triple. 

<div class="paragraph"> </div>

    Even more generally, <span class="inlinecode"><span class="id" type="var">a</span></span> is <i>any</i> arithmetic expression and <span class="inlinecode"><span class="id" type="var">Q</span></span> is
    <i>any</i> property of numbers, then

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Q</span>(<span class="id" type="var">a</span>)&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">a</span>&nbsp;{{&nbsp;<span class="id" type="var">Q</span>(<span class="id" type="var">X</span>)&nbsp;}}
<div class="paragraph"> </div>

</div>
    is a valid Hoare triple.

<div class="paragraph"> </div>

    Rephrasing this a bit gives us the general Hoare rule for
    assignment:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Q</span>&nbsp;<span class="id" type="keyword">where</span>&nbsp;<span class="id" type="var">a</span>&nbsp;<span class="id" type="var">is</span>&nbsp;<span class="id" type="var">substituted</span>&nbsp;<span class="id" type="keyword">for</span>&nbsp;<span class="id" type="var">X</span>&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">a</span>&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Q</span>&nbsp;}}
<div class="paragraph"> </div>

</div>
    For example, these are valid applications of the assignment
    rule:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;(<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5)&nbsp;<span class="id" type="keyword">where</span>&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;<span class="id" type="var">is</span>&nbsp;<span class="id" type="var">substituted</span>&nbsp;<span class="id" type="keyword">for</span>&nbsp;<span class="id" type="var">X</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">i.e</span>.,&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;&lt;=&nbsp;5&nbsp;}}&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5&nbsp;}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;(<span class="id" type="var">X</span>&nbsp;=&nbsp;3)&nbsp;<span class="id" type="keyword">where</span>&nbsp;3&nbsp;<span class="id" type="var">is</span>&nbsp;<span class="id" type="var">substituted</span>&nbsp;<span class="id" type="keyword">for</span>&nbsp;<span class="id" type="var">X</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">i.e</span>.,&nbsp;3&nbsp;=&nbsp;3}}&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;3&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;3&nbsp;}}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;(0&nbsp;&lt;=&nbsp;<span class="id" type="var">X</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5)&nbsp;<span class="id" type="keyword">where</span>&nbsp;3&nbsp;<span class="id" type="var">is</span>&nbsp;<span class="id" type="var">substituted</span>&nbsp;<span class="id" type="keyword">for</span>&nbsp;<span class="id" type="var">X</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">i.e</span>.,&nbsp;(0&nbsp;&lt;=&nbsp;3&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;3&nbsp;&lt;=&nbsp;5)}}&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;3&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;0&nbsp;&lt;=&nbsp;<span class="id" type="var">X</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5&nbsp;}}
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

 To formalize the rule, we begin with the notion of "substitution
    in an assertion": 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">assn_sub</span> <span class="id" type="var">X</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span> : <span class="id" type="var">Assertion</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> (<span class="id" type="var">st</span> : <span class="id" type="var">state</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Q</span> (<span class="id" type="var">update</span> <span class="id" type="var">st</span> <span class="id" type="var">X</span> (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a</span>)).<br/>

<br/>
</div>

<div class="doc">
We ask that <span class="inlinecode"><span class="id" type="var">Q</span></span> holds for the state obtained by assigning <span class="inlinecode"><span class="id" type="var">a</span></span> to
    <span class="inlinecode"><span class="id" type="var">X</span></span>, i.e. the updated state in which <span class="inlinecode"><span class="id" type="var">X</span></span> is bound to the result of
    evaluating <span class="inlinecode"><span class="id" type="var">a</span></span>. Since we've chosen to represent assertions using
    Coq propositions, this is the only way we can "substitute" a
    variable inside an assertion. 
<div class="paragraph"> </div>

 Now the precise proof rule for assignment: 
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_asgn) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{assn_sub&nbsp;X&nbsp;a&nbsp;Q}}&nbsp;X::=a&nbsp;{{Q}}</td>
  <td></td>
</td>
</table></center>
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">hoare_asgn</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">Q</span> <span class="id" type="var">X</span> <span class="id" type="var">a</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="var">assn_sub</span> <span class="id" type="var">X</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span>}} (<span class="id" type="var">X</span> ::= <span class="id" type="var">a</span>) {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">hoare_triple</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">Q</span> <span class="id" type="var">X</span> <span class="id" type="var">a</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">HE</span> <span class="id" type="var">HQ</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">HE</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span> <span class="id" type="keyword">in</span> <span class="id" type="var">HQ</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Here's a first formal proof using this rule. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">assn_sub_example</span> : <br/>
&nbsp;&nbsp;{{<span class="id" type="var">assn_sub</span> <span class="id" type="var">X</span> (<span class="id" type="var">ANum</span> 3) (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = 3)}} <br/>
&nbsp;&nbsp;(<span class="id" type="var">X</span> ::= (<span class="id" type="var">ANum</span> 3)) <br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = 3}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_asgn</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab405"></a><h4 class="section">Exercise: 2 stars (hoare_asgn_examples)</h4>
 Translate these informal Hoare triples...

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">assn_sub</span>&nbsp;<span class="id" type="var">X</span>&nbsp;(<span class="id" type="var">X</span>&nbsp;+&nbsp;1)&nbsp;(<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5)&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">assn_sub</span>&nbsp;<span class="id" type="var">X</span>&nbsp;3&nbsp;(0&nbsp;&lt;=&nbsp;<span class="id" type="var">X</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5)&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;3&nbsp;&nbsp;{{&nbsp;0&nbsp;&lt;=&nbsp;<span class="id" type="var">X</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5&nbsp;}}
<div class="paragraph"> </div>

</div>
   ...into formal statements and use <span class="inlinecode"><span class="id" type="var">hoare_asgn</span></span> to prove them. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab406"></a><h4 class="section">Exercise: 2 stars (hoare_asgn_wrong)</h4>
 The assignment rule looks backward to almost everyone the first
    time they see it.  If it still seems backward to you, it may help
    to think a little about alternative "forward" rules.  Here is a
    seemingly natural one:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_asgn_wrong) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{&nbsp;True&nbsp;}}&nbsp;X&nbsp;::=&nbsp;a&nbsp;{{&nbsp;X&nbsp;=&nbsp;a&nbsp;}}</td>
  <td></td>
</td>
</table></center>    Give a counterexample showing that this rule is incorrect
    (informally). Hint: The rule universally quantifies over the
    arithmetic expression <span class="inlinecode"><span class="id" type="var">a</span></span>, and your counterexample needs to
    exhibit an <span class="inlinecode"><span class="id" type="var">a</span></span> for which the rule doesn't work. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab407"></a><h4 class="section">Exercise: 3 stars, optional (hoare_asgn_fwd)</h4>
 However, using an auxiliary variable <span class="inlinecode"><span class="id" type="var">x</span></span> to remember the original
    value of <span class="inlinecode"><span class="id" type="var">X</span></span> we can define a Hoare rule for assignment that does,
    intuitively, "work forwards" rather than backwards.
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_asgn_fwd) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{fun&nbsp;st&nbsp;=>&nbsp;Q&nbsp;st&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;st&nbsp;X&nbsp;=&nbsp;x}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">X&nbsp;::=&nbsp;a</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">{{fun&nbsp;st&nbsp;=>&nbsp;Q&nbsp;st'&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;st&nbsp;X&nbsp;=&nbsp;aeval&nbsp;st'&nbsp;a&nbsp;}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">(where&nbsp;st'&nbsp;=&nbsp;update&nbsp;st&nbsp;X&nbsp;x)</td>
  <td></td>
</td>
</table></center>    Note that we use the original value of <span class="inlinecode"><span class="id" type="var">X</span></span> to reconstruct the
    state <span class="inlinecode"><span class="id" type="var">st'</span></span> before the assignment took place. Prove that this rule
    is correct (the first hypothesis is the functional extensionality
    axiom, which you will need at some point). Also note that this
    rule is more complicated than <span class="inlinecode"><span class="id" type="var">hoare_asgn</span></span>.

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">hoare_asgn_fwd</span> :<br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&forall;</span>{<span class="id" type="var">X</span> <span class="id" type="var">Y</span>: <span class="id" type="keyword">Type</span>} {<span class="id" type="var">f</span> <span class="id" type="var">g</span> : <span class="id" type="var">X</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Y</span>}, (<span style="font-family: arial;">&forall;</span>(<span class="id" type="var">x</span>: <span class="id" type="var">X</span>), <span class="id" type="var">f</span> <span class="id" type="var">x</span> = <span class="id" type="var">g</span> <span class="id" type="var">x</span>) <span style="font-family: arial;">&rarr;</span>  <span class="id" type="var">f</span> = <span class="id" type="var">g</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">Q</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">x</span>}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">a</span><br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">Q</span> (<span class="id" type="var">update</span> <span class="id" type="var">st</span> <span class="id" type="var">X</span> <span class="id" type="var">x</span>) <span style="font-family: arial;">&and;</span> <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">aeval</span> (<span class="id" type="var">update</span> <span class="id" type="var">st</span> <span class="id" type="var">X</span> <span class="id" type="var">x</span>) <span class="id" type="var">a</span> }}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">functional_extensionality</span> <span class="id" type="var">v</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab408"></a><h4 class="section">Exercise: 2 stars (hoare_asgn_weakest)</h4>
 Show that the precondition in the rule <span class="inlinecode"><span class="id" type="var">hoare_asgn</span></span> is in fact the
    weakest precondition. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">hoare_asgn_weakest</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">P</span> <span class="id" type="var">X</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} (<span class="id" type="var">X</span> ::= <span class="id" type="var">a</span>) {{<span class="id" type="var">Q</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">P</span> <span style="font-family: arial;">&#8669;</span> <span class="id" type="var">assn_sub</span> <span class="id" type="var">X</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab409"></a><h3 class="section">Consequence</h3>

<div class="paragraph"> </div>

 Sometimes the preconditions and postconditions we get from the
    Hoare rules won't quite be the ones we want in the particular
    situation at hand &mdash; they may be logically equivalent but have a
    different syntactic form that fails to unify with the goal we are
    trying to prove, or they actually may be logically weaker (for
    preconditions) or stronger (for postconditions) than what we need.

<div class="paragraph"> </div>

    For instance, while

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">assn_sub</span>&nbsp;<span class="id" type="var">X</span>&nbsp;3&nbsp;(<span class="id" type="var">X</span>&nbsp;=&nbsp;3)}}&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;3&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;3}},
<div class="paragraph"> </div>

</div>
    follows directly from the assignment rule, 

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;3&nbsp;{{<span class="id" type="var">X</span>&nbsp;=&nbsp;3}}.
<div class="paragraph"> </div>

</div>
    does not.  This triple is also valid, but it is not an instance of
    <span class="inlinecode"><span class="id" type="var">hoare_asgn</span></span> because <span class="inlinecode"><span class="id" type="var">True</span></span> and <span class="inlinecode"><span class="id" type="var">assn_sub</span></span> <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">3</span> <span class="inlinecode">(<span class="id" type="var">X</span></span> <span class="inlinecode">=</span> <span class="inlinecode">3)</span> are not
    syntactically equal assertions.  However, they are logically
    equivalent, so if one triple is valid, then the other must
    certainly be as well.  We could capture this observation with the
    following rule:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P'}}&nbsp;c&nbsp;{{Q}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">P&nbsp;<span style="font-family: arial;">&#8621;</span>&nbsp;P'</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_consequence_pre_equiv) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;c&nbsp;{{Q}}</td>
  <td></td>
</td>
</table></center>    Generalizing this line of thought a bit further, if we can derive
    <span class="inlinecode">{{<span class="id" type="var">P</span>}}</span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode">{{<span class="id" type="var">Q</span>}}</span>, it is valid to change <span class="inlinecode"><span class="id" type="var">P</span></span> to <span class="inlinecode"><span class="id" type="var">P'</span></span> as long as <span class="inlinecode"><span class="id" type="var">P'</span></span>
    is strong enough to imply <span class="inlinecode"><span class="id" type="var">P</span></span>, and change <span class="inlinecode"><span class="id" type="var">Q</span></span> to <span class="inlinecode"><span class="id" type="var">Q'</span></span> as long as
    <span class="inlinecode"><span class="id" type="var">Q</span></span> implies <span class="inlinecode"><span class="id" type="var">Q'</span></span>.  This observation is captured by two <i>Rules of
    Consequence</i>.
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P'}}&nbsp;c&nbsp;{{Q}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">P&nbsp;<span style="font-family: arial;">&#8669;</span>&nbsp;P'</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_consequence_pre) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;c&nbsp;{{Q}}</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;c&nbsp;{{Q'}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">Q'&nbsp;<span style="font-family: arial;">&#8669;</span>&nbsp;Q</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_consequence_post) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;c&nbsp;{{Q}}</td>
  <td></td>
</td>
</table></center>
<div class="paragraph"> </div>

 Here are the formal versions: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">hoare_consequence_pre</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">P</span> <span class="id" type="var">P'</span> <span class="id" type="var">Q</span> : <span class="id" type="var">Assertion</span>) <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="var">P'</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">P</span> <span style="font-family: arial;">&#8669;</span> <span class="id" type="var">P'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">P'</span> <span class="id" type="var">Q</span> <span class="id" type="var">c</span> <span class="id" type="var">Hhoare</span> <span class="id" type="var">Himp</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">Hc</span> <span class="id" type="var">HP</span>. <span class="id" type="tactic">apply</span> (<span class="id" type="var">Hhoare</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Himp</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">hoare_consequence_post</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">Q'</span> : <span class="id" type="var">Assertion</span>) <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q'</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">Q'</span> <span style="font-family: arial;">&#8669;</span> <span class="id" type="var">Q</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">Q'</span> <span class="id" type="var">c</span> <span class="id" type="var">Hhoare</span> <span class="id" type="var">Himp</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">Hc</span> <span class="id" type="var">HP</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Himp</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">Hhoare</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
For example, we might use the first consequence rule like this:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;1&nbsp;=&nbsp;1&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;1&nbsp;}}
<div class="paragraph"> </div>

</div>
    Or, formally... 

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">hoare_asgn_example1</span> :<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">True</span>}} (<span class="id" type="var">X</span> ::= (<span class="id" type="var">ANum</span> 1)) {{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = 1}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_consequence_pre</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">with</span> (<span class="id" type="var">P'</span> := <span class="id" type="var">assn_sub</span> <span class="id" type="var">X</span> (<span class="id" type="var">ANum</span> 1) (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = 1)).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_asgn</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Finally, for convenience in some proofs, we can state a "combined"
    rule of consequence that allows us to vary both the precondition
    and the postcondition. 
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P'}}&nbsp;c&nbsp;{{Q'}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">P&nbsp;<span style="font-family: arial;">&#8669;</span>&nbsp;P'</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">Q'&nbsp;<span style="font-family: arial;">&#8669;</span>&nbsp;Q</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_consequence) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;c&nbsp;{{Q}}</td>
  <td></td>
</td>
</table></center>
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">hoare_consequence</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">P</span> <span class="id" type="var">P'</span> <span class="id" type="var">Q</span> <span class="id" type="var">Q'</span> : <span class="id" type="var">Assertion</span>) <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="var">P'</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q'</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">P</span> <span style="font-family: arial;">&#8669;</span> <span class="id" type="var">P'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">Q'</span> <span style="font-family: arial;">&#8669;</span> <span class="id" type="var">Q</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">P'</span> <span class="id" type="var">Q</span> <span class="id" type="var">Q'</span> <span class="id" type="var">c</span> <span class="id" type="var">Hht</span> <span class="id" type="var">HPP'</span> <span class="id" type="var">HQ'Q</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">Hc</span> <span class="id" type="var">HP</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">HQ'Q</span>. <span class="id" type="tactic">apply</span> (<span class="id" type="var">Hht</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>). <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">HPP'</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab410"></a><h3 class="section">Digression: The <span class="inlinecode"><span class="id" type="tactic">eapply</span></span> Tactic</h3>

<div class="paragraph"> </div>

 This is a good moment to introduce another convenient feature of
    Coq.  We had to write "<span class="inlinecode"><span class="id" type="keyword">with</span></span> <span class="inlinecode">(<span class="id" type="var">P'</span></span> <span class="inlinecode">:=</span> <span class="inlinecode">...)</span>" explicitly in the proof
    of <span class="inlinecode"><span class="id" type="var">hoare_asgn_example1</span></span> above, to make sure that all of the
    metavariables in the premises to the <span class="inlinecode"><span class="id" type="var">hoare_consequence_pre</span></span> rule
    would be set to specific values; since <span class="inlinecode"><span class="id" type="var">P'</span></span> doesn't appear in the
    conclusion of <span class="inlinecode"><span class="id" type="var">hoare_consequence_pre</span></span>, the process of unifying the
    conclusion with the current goal doesn't constrain <span class="inlinecode"><span class="id" type="var">P'</span></span> to a
    specific assertion.

<div class="paragraph"> </div>

    This is a little annoying, both because the assertion is a bit
    long and also because the very next thing we are going to do &mdash;
    applying the <span class="inlinecode"><span class="id" type="var">hoare_asgn</span></span> rule &mdash; will tell us exactly what it
    should be!  We can use <span class="inlinecode"><span class="id" type="tactic">eapply</span></span> instead of <span class="inlinecode"><span class="id" type="tactic">apply</span></span> to tell Coq,
    essentially, "Be patient: The missing part is going to be filled
    in soon." 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">hoare_asgn_example1'</span> :<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">True</span>}} <br/>
&nbsp;&nbsp;(<span class="id" type="var">X</span> ::= (<span class="id" type="var">ANum</span> 1)) <br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = 1}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_asgn</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
In general, <span class="inlinecode"><span class="id" type="tactic">eapply</span></span> <span class="inlinecode"><span class="id" type="var">H</span></span> tactic works just like <span class="inlinecode"><span class="id" type="tactic">apply</span></span> <span class="inlinecode"><span class="id" type="var">H</span></span>
    except that, instead of failing if unifying the goal with the
    conclusion of <span class="inlinecode"><span class="id" type="var">H</span></span> does not determine how to instantiate all
    of the variables appearing in the premises of <span class="inlinecode"><span class="id" type="var">H</span></span>, <span class="inlinecode"><span class="id" type="tactic">eapply</span></span> <span class="inlinecode"><span class="id" type="var">H</span></span>
    will replace these variables with <i>existential variables</i>
    (written <span class="inlinecode">?<span class="id" type="var">nnn</span></span>) as placeholders for expressions that will be
    determined (by further unification) later in the proof. 

<div class="paragraph"> </div>

    In order for <span class="inlinecode"><span class="id" type="keyword">Qed</span></span> to succeed, all existential variables need to
    be determined by the end of the proof. Otherwise Coq will
    (rightfully) refuse to accept the proof. Remember that the Coq
    tactics build proof objects, and proof objects containing
    existential variables are not complete. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">silly1</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">P</span> : <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span>) (<span class="id" type="var">Q</span> : <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span>),<br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">y</span> : <span class="id" type="var">nat</span>, <span class="id" type="var">P</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">y</span> : <span class="id" type="var">nat</span>, <span class="id" type="var">P</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Q</span> <span class="id" type="var">x</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">Q</span> 42.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">HP</span> <span class="id" type="var">HQ</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">HQ</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">HP</span>. <span class="id" type="var">Admitted</span>.<br/>

<br/>
</div>

<div class="doc">
Coq gives a warning after <span class="inlinecode"><span class="id" type="tactic">apply</span></span> <span class="inlinecode"><span class="id" type="var">HP</span></span>:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">No</span>&nbsp;<span class="id" type="var">more</span>&nbsp;<span class="id" type="var">subgoals</span>&nbsp;<span class="id" type="var">but</span>&nbsp;<span class="id" type="var">non</span>-<span class="id" type="var">instantiated</span>&nbsp;<span class="id" type="var">existential</span>&nbsp;<span class="id" type="var">variables</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Existential</span>&nbsp;1&nbsp;=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?171&nbsp;:&nbsp;[<span class="id" type="var">P</span>&nbsp;:&nbsp;<span class="id" type="var">nat</span>&nbsp;<span style="font-family: arial;">&rarr;</span>&nbsp;<span class="id" type="var">nat</span>&nbsp;<span style="font-family: arial;">&rarr;</span>&nbsp;<span class="id" type="keyword">Prop</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Q</span>&nbsp;:&nbsp;<span class="id" type="var">nat</span>&nbsp;<span style="font-family: arial;">&rarr;</span>&nbsp;<span class="id" type="keyword">Prop</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">HP</span>&nbsp;:&nbsp;<span style="font-family: arial;">&forall;</span>&nbsp;<span class="id" type="var">x</span>&nbsp;<span class="id" type="var">y</span>&nbsp;:&nbsp;<span class="id" type="var">nat</span>,&nbsp;<span class="id" type="var">P</span>&nbsp;<span class="id" type="var">x</span>&nbsp;<span class="id" type="var">y</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">HQ</span>&nbsp;:&nbsp;<span style="font-family: arial;">&forall;</span>&nbsp;<span class="id" type="var">x</span>&nbsp;<span class="id" type="var">y</span>&nbsp;:&nbsp;<span class="id" type="var">nat</span>,&nbsp;<span class="id" type="var">P</span>&nbsp;<span class="id" type="var">x</span>&nbsp;<span class="id" type="var">y</span>&nbsp;<span style="font-family: arial;">&rarr;</span>&nbsp;<span class="id" type="var">Q</span>&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;<span class="id" type="var">nat</span>]&nbsp;
<div class="paragraph"> </div>

</div>
   Trying to finish the proof with <span class="inlinecode"><span class="id" type="keyword">Qed</span></span> instead of <span class="inlinecode"><span class="id" type="var">Admitted</span></span> gives
   an error:
<pre>
    Error: Attempt to save a proof with existential variables still
    non-instantiated
</pre>

<div class="paragraph"> </div>

 An additional constraint is that existential variables cannot be
    instantiated with terms containing (normal) variables that did not
    exist at the time the existential variable was created. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">silly2</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">P</span> : <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span>) (<span class="id" type="var">Q</span> : <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span>),<br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&exist;</span><span class="id" type="var">y</span>, <span class="id" type="var">P</span> 42 <span class="id" type="var">y</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">y</span> : <span class="id" type="var">nat</span>, <span class="id" type="var">P</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Q</span> <span class="id" type="var">x</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">Q</span> 42.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">HP</span> <span class="id" type="var">HQ</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">HQ</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">HP</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">y</span> <span class="id" type="var">HP'</span>]. <span class="id" type="var">Admitted</span>.<br/>

<br/>
</div>

<div class="doc">
Doing <span class="inlinecode"><span class="id" type="tactic">apply</span></span> <span class="inlinecode"><span class="id" type="var">HP'</span></span> above fails with the following error:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Error</span>:&nbsp;<span class="id" type="var">Impossible</span>&nbsp;<span class="id" type="var">to</span>&nbsp;<span class="id" type="var">unify</span>&nbsp;"?175"&nbsp;<span class="id" type="keyword">with</span>&nbsp;"y".
<div class="paragraph"> </div>

</div>
    In this case there is an easy fix:
    doing <span class="inlinecode"><span class="id" type="tactic">destruct</span></span> <span class="inlinecode"><span class="id" type="var">HP</span></span> <i>before</i> doing <span class="inlinecode"><span class="id" type="tactic">eapply</span></span> <span class="inlinecode"><span class="id" type="var">HQ</span></span>.

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">silly2_fixed</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">P</span> : <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span>) (<span class="id" type="var">Q</span> : <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span>),<br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&exist;</span><span class="id" type="var">y</span>, <span class="id" type="var">P</span> 42 <span class="id" type="var">y</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">y</span> : <span class="id" type="var">nat</span>, <span class="id" type="var">P</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Q</span> <span class="id" type="var">x</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">Q</span> 42.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">HP</span> <span class="id" type="var">HQ</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">HP</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">y</span> <span class="id" type="var">HP'</span>]. <span class="id" type="tactic">eapply</span> <span class="id" type="var">HQ</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">HP'</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
In the last step we did <span class="inlinecode"><span class="id" type="tactic">apply</span></span> <span class="inlinecode"><span class="id" type="var">HP'</span></span> which unifies the existential
    variable in the goal with the variable <span class="inlinecode"><span class="id" type="var">y</span></span>. The <span class="inlinecode"><span class="id" type="tactic">assumption</span></span>
    tactic doesn't work in this case, since it cannot handle
    existential variables. However, Coq also provides an <span class="inlinecode"><span class="id" type="var">eassumption</span></span>
    tactic that solves the goal if one of the premises matches the
    goal up to instantiations of existential variables. We can use
    it instead of <span class="inlinecode"><span class="id" type="tactic">apply</span></span> <span class="inlinecode"><span class="id" type="var">HP'</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">silly2_eassumption</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">P</span> : <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span>) (<span class="id" type="var">Q</span> : <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span>),<br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&exist;</span><span class="id" type="var">y</span>, <span class="id" type="var">P</span> 42 <span class="id" type="var">y</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;(<span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">y</span> : <span class="id" type="var">nat</span>, <span class="id" type="var">P</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Q</span> <span class="id" type="var">x</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">Q</span> 42.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">HP</span> <span class="id" type="var">HQ</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">HP</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">y</span> <span class="id" type="var">HP'</span>]. <span class="id" type="tactic">eapply</span> <span class="id" type="var">HQ</span>. <span class="id" type="var">eassumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab411"></a><h4 class="section">Exercise: 2 stars (hoare_asgn_examples_2)</h4>
 Translate these informal Hoare triples...

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;&lt;=&nbsp;5&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;0&nbsp;&lt;=&nbsp;3&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;3&nbsp;&lt;=&nbsp;5&nbsp;}}&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;3&nbsp;&nbsp;{{&nbsp;0&nbsp;&lt;=&nbsp;<span class="id" type="var">X</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;5&nbsp;}}
<div class="paragraph"> </div>

</div>
   ...into formal statements and use <span class="inlinecode"><span class="id" type="var">hoare_asgn</span></span> and
   <span class="inlinecode"><span class="id" type="var">hoare_consequence_pre</span></span> to prove them. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab412"></a><h3 class="section">Skip</h3>

<div class="paragraph"> </div>

 Since <span class="inlinecode"><span class="id" type="var">SKIP</span></span> doesn't change the state, it preserves any
    property P:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_skip) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{&nbsp;P&nbsp;}}&nbsp;SKIP&nbsp;{{&nbsp;P&nbsp;}}</td>
  <td></td>
</td>
</table></center>
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">hoare_skip</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">P</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">SKIP</span> {{<span class="id" type="var">P</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">H</span> <span class="id" type="var">HP</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab413"></a><h3 class="section">Sequencing</h3>

<div class="paragraph"> </div>

 More interestingly, if the command <span class="inlinecode"><span class="id" type="var">c1</span></span> takes any state where
    <span class="inlinecode"><span class="id" type="var">P</span></span> holds to a state where <span class="inlinecode"><span class="id" type="var">Q</span></span> holds, and if <span class="inlinecode"><span class="id" type="var">c2</span></span> takes any
    state where <span class="inlinecode"><span class="id" type="var">Q</span></span> holds to one where <span class="inlinecode"><span class="id" type="var">R</span></span> holds, then doing <span class="inlinecode"><span class="id" type="var">c1</span></span>
    followed by <span class="inlinecode"><span class="id" type="var">c2</span></span> will take any state where <span class="inlinecode"><span class="id" type="var">P</span></span> holds to one
    where <span class="inlinecode"><span class="id" type="var">R</span></span> holds:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{&nbsp;P&nbsp;}}&nbsp;c1&nbsp;{{&nbsp;Q&nbsp;}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">{{&nbsp;Q&nbsp;}}&nbsp;c2&nbsp;{{&nbsp;R&nbsp;}}</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_seq) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{&nbsp;P&nbsp;}}&nbsp;c1;c2&nbsp;{{&nbsp;R&nbsp;}}</td>
  <td></td>
</td>
</table></center>
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">hoare_seq</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">R</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">Q</span>}} <span class="id" type="var">c2</span> {{<span class="id" type="var">R</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c1</span> {{<span class="id" type="var">Q</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">c1</span>;<span class="id" type="var">c2</span> {{<span class="id" type="var">R</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">R</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">H12</span> <span class="id" type="var">Pre</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H12</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">H1</span> <span class="id" type="var">st'0</span> <span class="id" type="var">st'</span>); <span class="id" type="tactic">try</span> <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">H2</span> <span class="id" type="var">st</span> <span class="id" type="var">st'0</span>); <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Note that, in the formal rule <span class="inlinecode"><span class="id" type="var">hoare_seq</span></span>, the premises are
    given in "backwards" order (<span class="inlinecode"><span class="id" type="var">c2</span></span> before <span class="inlinecode"><span class="id" type="var">c1</span></span>).  This matches the
    natural flow of information in many of the situations where we'll
    use the rule: the natural way to construct a Hoare-logic proof is
    to begin at the end of the program (with the final postcondition)
    and push postconditions backwards through commands until we reach
    the beginning. 
<div class="paragraph"> </div>

 Informally, a nice way of recording a proof using the sequencing
    rule is as a "decorated program" where the intermediate assertion
    <span class="inlinecode"><span class="id" type="var">Q</span></span> is written between <span class="inlinecode"><span class="id" type="var">c1</span></span> and <span class="inlinecode"><span class="id" type="var">c2</span></span>:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">a</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">a</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;----&nbsp;<span class="id" type="var">decoration</span>&nbsp;<span class="id" type="keyword">for</span>&nbsp;<span class="id" type="var">Q</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>&nbsp;}}
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">hoare_asgn_example3</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">a</span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a</span> = <span class="id" type="var">n</span>}} <br/>
&nbsp;&nbsp;(<span class="id" type="var">X</span> ::= <span class="id" type="var">a</span>; <span class="id" type="var">SKIP</span>) <br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">n</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">a</span> <span class="id" type="var">n</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_seq</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "right part of seq".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_skip</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "left part of seq".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_asgn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
You will most often use <span class="inlinecode"><span class="id" type="var">hoare_seq</span></span> and
    <span class="inlinecode"><span class="id" type="var">hoare_consequence_pre</span></span> in conjunction with the <span class="inlinecode"><span class="id" type="tactic">eapply</span></span> tactic,
    as done above. 
<div class="paragraph"> </div>

<a name="lab414"></a><h4 class="section">Exercise: 2 stars (hoare_asgn_example4)</h4>
 Translate this decorated program into a formal proof:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;1&nbsp;=&nbsp;1&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;1&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;1&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;2&nbsp;=&nbsp;2&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;2<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;1&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;2&nbsp;}}
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">hoare_asgn_example4</span> :<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">True</span>}} (<span class="id" type="var">X</span> ::= (<span class="id" type="var">ANum</span> 1); <span class="id" type="var">Y</span> ::= (<span class="id" type="var">ANum</span> 2)) <br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = 1 <span style="font-family: arial;">&and;</span> <span class="id" type="var">st</span> <span class="id" type="var">Y</span> = 2}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab415"></a><h4 class="section">Exercise: 3 stars (swap_exercise)</h4>
 Write an Imp program <span class="inlinecode"><span class="id" type="var">c</span></span> that swaps the values of <span class="inlinecode"><span class="id" type="var">X</span></span> and <span class="inlinecode"><span class="id" type="var">Y</span></span>
    and show (in Coq) that it satisfies the following
    specification:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;<span class="id" type="var">Y</span>}}&nbsp;<span class="id" type="var">c</span>&nbsp;{{<span class="id" type="var">Y</span>&nbsp;&lt;=&nbsp;<span class="id" type="var">X</span>}}
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab416"></a><h4 class="section">Exercise: 3 stars, optional (hoarestate1)</h4>
 Explain why the following proposition can't be proven:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span>&nbsp;(<span class="id" type="var">a</span>&nbsp;:&nbsp;<span class="id" type="var">aexp</span>)&nbsp;(<span class="id" type="var">n</span>&nbsp;:&nbsp;<span class="id" type="var">nat</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">a</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>}}&nbsp;(<span class="id" type="var">X</span>&nbsp;::=&nbsp;(<span class="id" type="var">ANum</span>&nbsp;3);&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">a</span>)&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">st</span>&nbsp;=&gt;&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">n</span>}}.
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab417"></a><h3 class="section">Conditionals</h3>

<div class="paragraph"> </div>

 What sort of rule do we want for reasoning about conditional
    commands?  Certainly, if the same assertion <span class="inlinecode"><span class="id" type="var">Q</span></span> holds after
    executing either branch, then it holds after the whole
    conditional.  So we might be tempted to write:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;c1&nbsp;{{Q}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;c2&nbsp;{{Q}}</td>
  <td class="infrulenamecol" rowspan="3">
    &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;IFB&nbsp;b&nbsp;THEN&nbsp;c1&nbsp;ELSE&nbsp;c2&nbsp;{{Q}}</td>
  <td></td>
</td>
</table></center>   However, this is rather weak. For example, using this rule,
   we cannot show that:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">True</span>}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span>&nbsp;<span class="id" type="var">X</span>&nbsp;==&nbsp;0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">THEN</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;2<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">FI</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;=&nbsp;<span class="id" type="var">Y</span>&nbsp;}}
<div class="paragraph"> </div>

</div>
   since the rule tells us nothing about the state in which the
   assignments take place in the "then" and "else" branches.

<div class="paragraph"> </div>

   But, actually, we can say something more precise.  In the "then"
   branch, we know that the boolean expression <span class="inlinecode"><span class="id" type="var">b</span></span> evaluates to
   <span class="inlinecode"><span class="id" type="var">true</span></span>, and in the "else" branch, we know it evaluates to <span class="inlinecode"><span class="id" type="var">false</span></span>.
   Making this information available in the premises of the rule
   gives us more information to work with when reasoning about the
   behavior of <span class="inlinecode"><span class="id" type="var">c1</span></span> and <span class="inlinecode"><span class="id" type="var">c2</span></span> (i.e., the reasons why they establish the
   postcondition <span class="inlinecode"><span class="id" type="var">Q</span></span>).
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;&nbsp;b}}&nbsp;c1&nbsp;{{Q}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">{{P&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~b}}&nbsp;c2&nbsp;{{Q}}</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_if) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;IFB&nbsp;b&nbsp;THEN&nbsp;c1&nbsp;ELSE&nbsp;c2&nbsp;FI&nbsp;{{Q}}</td>
  <td></td>
</td>
</table></center>
<div class="paragraph"> </div>

 To interpret this rule formally, we need to do a little work.

<div class="paragraph"> </div>

    Strictly speaking, the assertion we've written, <span class="inlinecode"><span class="id" type="var">P</span></span> <span class="inlinecode"><span style="font-family: arial;">&and;</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span>, is the
    conjunction of an assertion and a boolean expression, which
    doesn't typecheck.  To fix this, we need a way of formally
    "lifting" any bexp <span class="inlinecode"><span class="id" type="var">b</span></span> to an assertion.  We'll write <span class="inlinecode"><span class="id" type="var">bassn</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> for
    the assertion "the boolean expression <span class="inlinecode"><span class="id" type="var">b</span></span> evaluates to <span class="inlinecode"><span class="id" type="var">true</span></span> (in
    the given state)." 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">bassn</span> <span class="id" type="var">b</span> : <span class="id" type="var">Assertion</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; (<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b</span> = <span class="id" type="var">true</span>).<br/>

<br/>
</div>

<div class="doc">
A couple of useful facts about <span class="inlinecode"><span class="id" type="var">bassn</span></span>: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">bexp_eval_true</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">b</span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b</span> = <span class="id" type="var">true</span> <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">bassn</span> <span class="id" type="var">b</span>) <span class="id" type="var">st</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">b</span> <span class="id" type="var">st</span> <span class="id" type="var">Hbe</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">bexp_eval_false</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">b</span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b</span> = <span class="id" type="var">false</span> <span style="font-family: arial;">&rarr;</span> ~ ((<span class="id" type="var">bassn</span> <span class="id" type="var">b</span>) <span class="id" type="var">st</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">b</span> <span class="id" type="var">st</span> <span class="id" type="var">Hbe</span> <span class="id" type="var">contra</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span> <span class="id" type="keyword">in</span> <span class="id" type="var">contra</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">contra</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hbe</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hbe</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Now we can formalize the Hoare proof rule for conditionals
    and prove it correct. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">hoare_if</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">b</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">bassn</span> <span class="id" type="var">b</span> <span class="id" type="var">st</span>}} <span class="id" type="var">c1</span> {{<span class="id" type="var">Q</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> ~(<span class="id" type="var">bassn</span> <span class="id" type="var">b</span> <span class="id" type="var">st</span>)}} <span class="id" type="var">c2</span> {{<span class="id" type="var">Q</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} (<span class="id" type="var">IFB</span> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">b</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span> <span class="id" type="var">HTrue</span> <span class="id" type="var">HFalse</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">HE</span> <span class="id" type="var">HP</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">HE</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "b is true".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">HTrue</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">bexp_eval_true</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "b is false".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">HFalse</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">bexp_eval_false</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Here is a formal proof that the program we used to motivate the
    rule satisfies the specification we gave. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">if_example</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">True</span>}} <br/>
&nbsp;&nbsp;<span class="id" type="var">IFB</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">THEN</span> (<span class="id" type="var">Y</span> ::= (<span class="id" type="var">ANum</span> 2)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span> (<span class="id" type="var">Y</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1)) <br/>
&nbsp;&nbsp;<span class="id" type="var">FI</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> &lt;= <span class="id" type="var">st</span> <span class="id" type="var">Y</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;WORKED&nbsp;IN&nbsp;CLASS&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_if</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Then".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_asgn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span>, <span class="id" type="var">assn_sub</span>, <span class="id" type="var">update</span>, <span class="id" type="var">assert_implies</span>. <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [<span class="id" type="var">_</span> <span class="id" type="var">H</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">symmetry</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">beq_nat_eq</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Else".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_asgn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span>, <span class="id" type="var">update</span>, <span class="id" type="var">assert_implies</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">_</span>. <span class="id" type="tactic">omega</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab418"></a><h3 class="section">Exercise: One-sided conditionals</h3>

<div class="paragraph"> </div>

<a name="lab419"></a><h4 class="section">Exercise: 4 stars, recommended (if1_hoare)</h4>

<div class="paragraph"> </div>

 In this exercise we consider extending Imp with "one-sided
    conditionals" of the form <span class="inlinecode"><span class="id" type="var">IF1</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode"><span class="id" type="var">THEN</span></span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode"><span class="id" type="var">FI</span></span>. Here <span class="inlinecode"><span class="id" type="var">b</span></span> is a
    boolean expression, and <span class="inlinecode"><span class="id" type="var">c</span></span> is a command. If <span class="inlinecode"><span class="id" type="var">b</span></span> evaluates to
    <span class="inlinecode"><span class="id" type="var">true</span></span>, then command <span class="inlinecode"><span class="id" type="var">c</span></span> is evaluated. If <span class="inlinecode"><span class="id" type="var">b</span></span> evaluates to
    <span class="inlinecode"><span class="id" type="var">false</span></span>, then <span class="inlinecode"><span class="id" type="var">IF1</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode"><span class="id" type="var">THEN</span></span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode"><span class="id" type="var">FI</span></span> does nothing.

<div class="paragraph"> </div>

    We recommend that you do this exercise before the ones that
    follow, as it should help solidify your understanding of the
    material. 
<div class="paragraph"> </div>

 We first extend the syntax of commands, and introduce the usual
    notations. We use a separate module to prevent polluting the
    global name space. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">If1</span>.<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">com</span> : <span class="id" type="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">CSkip</span> : <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CAss</span> : <span class="id" type="var">id</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CSeq</span> : <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CIf</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CWhile</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CIf1</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span>.<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "com_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "SKIP" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "::=" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> ";"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "IFB" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "WHILE" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "CIF1" ].<br/>

<br/>
<span class="id" type="keyword">Notation</span> "'SKIP'" := <br/>
&nbsp;&nbsp;<span class="id" type="var">CSkip</span>.<br/>
<span class="id" type="keyword">Notation</span> "c1 ; c2" := <br/>
&nbsp;&nbsp;(<span class="id" type="var">CSeq</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "X '::=' a" := <br/>
&nbsp;&nbsp;(<span class="id" type="var">CAss</span> <span class="id" type="var">X</span> <span class="id" type="var">a</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 60).<br/>
<span class="id" type="keyword">Notation</span> "'WHILE' b 'DO' c 'END'" := <br/>
&nbsp;&nbsp;(<span class="id" type="var">CWhile</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'IFB' e1 'THEN' e2 'ELSE' e3 'FI'" := <br/>
&nbsp;&nbsp;(<span class="id" type="var">CIf</span> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span> <span class="id" type="var">e3</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'IF1' b 'THEN' c 'FI'" := <br/>
&nbsp;&nbsp;(<span class="id" type="var">CIf1</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>

<br/>
</div>

<div class="doc">
We now extend the evaluation relation to accommodate <span class="inlinecode"><span class="id" type="var">IF1</span></span>
    branches. What rule(s) need to be added to <span class="inlinecode"><span class="id" type="var">ceval</span></span> to evaluate
    one-sided conditionals? 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Reserved Notation</span> "c1 '/' st '<span style="font-family: arial;">&dArr;</span>' st'" (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 40, <span class="id" type="var">st</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39).<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">ceval</span> : <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">state</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">state</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Skip</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> : <span class="id" type="var">state</span>, <span class="id" type="var">SKIP</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Ass</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">a1</span> : <span class="id" type="var">aexp</span>) (<span class="id" type="var">n</span> : <span class="id" type="var">nat</span>) (<span class="id" type="var">X</span> : <span class="id" type="var">id</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a1</span> = <span class="id" type="var">n</span> <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">X</span> ::= <span class="id" type="var">a1</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">update</span> <span class="id" type="var">st</span> <span class="id" type="var">X</span> <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Seq</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">c1</span> <span class="id" type="var">c2</span> : <span class="id" type="var">com</span>) (<span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span> : <span class="id" type="var">state</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">c2</span> / <span class="id" type="var">st'</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span> <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">c1</span> ; <span class="id" type="var">c2</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_IfTrue</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span> <span class="id" type="var">st'</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">b1</span> : <span class="id" type="var">bexp</span>) (<span class="id" type="var">c1</span> <span class="id" type="var">c2</span> : <span class="id" type="var">com</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">true</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">IFB</span> <span class="id" type="var">b1</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_IfFalse</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span> <span class="id" type="var">st'</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">b1</span> : <span class="id" type="var">bexp</span>) (<span class="id" type="var">c1</span> <span class="id" type="var">c2</span> : <span class="id" type="var">com</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">false</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c2</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">IFB</span> <span class="id" type="var">b1</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_WhileEnd</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">b1</span> : <span class="id" type="var">bexp</span>) (<span class="id" type="var">st</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">c1</span> : <span class="id" type="var">com</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">false</span> <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_WhileLoop</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">b1</span> : <span class="id" type="var">bexp</span>) (<span class="id" type="var">c1</span> : <span class="id" type="var">com</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">true</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st'</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span><br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
<br/>
&nbsp;&nbsp;<span class="id" type="keyword">where</span> "c1 '/' st '<span style="font-family: arial;">&dArr;</span>' st'" := (<span class="id" type="var">ceval</span> <span class="id" type="var">c1</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>).<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "ceval_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Skip" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Ass" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Seq"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_IfTrue" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_IfFalse"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_WhileEnd" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_WhileLoop"<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
&nbsp;&nbsp;].<br/>

<br/>
</div>

<div class="doc">
We repeat the definition and notation of Hoare triples. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">hoare_triple</span> (<span class="id" type="var">P</span>:<span class="id" type="var">Assertion</span>) (<span class="id" type="var">c</span>:<span class="id" type="var">com</span>) (<span class="id" type="var">Q</span>:<span class="id" type="var">Assertion</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> <span class="id" type="var">st'</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span>  <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">P</span> <span class="id" type="var">st</span>  <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Q</span> <span class="id" type="var">st'</span>.<br/>

<br/>
<span class="id" type="keyword">Notation</span> "{{ P }}  c  {{ Q }}" := (<span class="id" type="var">hoare_triple</span> <span class="id" type="var">P</span> <span class="id" type="var">c</span> <span class="id" type="var">Q</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 90, <span class="id" type="var">c</span> <span class="id" type="tactic">at</span> <span class="id" type="var">next</span> <span class="id" type="var">level</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" type="var">hoare_spec_scope</span>.<br/>

<br/>
</div>

<div class="doc">
Now state and prove a theorem, <span class="inlinecode"><span class="id" type="var">hoare_if1</span></span>, that expresses an
    appropriate Hoare logic proof rule for one-sided conditionals. Try
    to come up with a rule that is both sound and as precise as
    possible. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>

<br/>
</div>

<div class="doc">
For full credit, prove formally that your rule is precise enough
    to show the following valid Hoare triple:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">Z</span>&nbsp;}}<br/>
&nbsp;&nbsp;<span class="id" type="var">IF1</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;<span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;<span class="id" type="var">Y</span><br/>
&nbsp;&nbsp;<span class="id" type="var">FI</span><br/>
&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">Z</span>&nbsp;}}
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

 Hint: Your proof of this triple may need to use the other proof
    rules also. Because we're working in a separate module, you'll
    need to copy here the rules you find necessary. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">hoare_if1_good</span> :<br/>
&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> + <span class="id" type="var">st</span> <span class="id" type="var">Y</span> = <span class="id" type="var">st</span> <span class="id" type="var">Z</span> }}<br/>
&nbsp;&nbsp;<span class="id" type="var">IF1</span> <span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>) (<span class="id" type="var">ANum</span> 0)) <span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>)<br/>
&nbsp;&nbsp;<span class="id" type="var">FI</span><br/>
&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">st</span> <span class="id" type="var">Z</span> }}.<br/>
<span class="id" type="keyword">Proof</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">If1</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab420"></a><h3 class="section">Loops</h3>

<div class="paragraph"> </div>

 Finally, we need a rule for reasoning about while loops.  Suppose
    we have a loop

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">b</span>&nbsp;<span class="id" type="var">DO</span>&nbsp;<span class="id" type="var">c</span>&nbsp;<span class="id" type="var">END</span>
<div class="paragraph"> </div>

</div>
    and we want to find a pre-condition <span class="inlinecode"><span class="id" type="var">P</span></span> and a post-condition
    <span class="inlinecode"><span class="id" type="var">Q</span></span> such that

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">P</span>}}&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">b</span>&nbsp;<span class="id" type="var">DO</span>&nbsp;<span class="id" type="var">c</span>&nbsp;<span class="id" type="var">END</span>&nbsp;{{<span class="id" type="var">Q</span>}}&nbsp;
<div class="paragraph"> </div>

</div>
    is a valid triple. 
<div class="paragraph"> </div>

 First of all, let's think about the case where <span class="inlinecode"><span class="id" type="var">b</span></span> is false at the
    beginning &mdash; i.e., let's assume that the loop body never executes
    at all.  In this case, the loop behaves like <span class="inlinecode"><span class="id" type="var">SKIP</span></span>, so we might
    be tempted to write

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">P</span>}}&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">b</span>&nbsp;<span class="id" type="var">DO</span>&nbsp;<span class="id" type="var">c</span>&nbsp;<span class="id" type="var">END</span>&nbsp;{{<span class="id" type="var">P</span>}}.
<div class="paragraph"> </div>

</div>
    But, as we remarked above for the conditional, we know a
    little more at the end &mdash; not just <span class="inlinecode"><span class="id" type="var">P</span></span>, but also the fact
    that <span class="inlinecode"><span class="id" type="var">b</span></span> is false in the current state.  So we can enrich the
    postcondition a little:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">P</span>}}&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">b</span>&nbsp;<span class="id" type="var">DO</span>&nbsp;<span class="id" type="var">c</span>&nbsp;<span class="id" type="var">END</span>&nbsp;{{<span class="id" type="var">P</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~<span class="id" type="var">b</span>}}
<div class="paragraph"> </div>

</div>
    What about the case where the loop body <i>does</i> get executed?
    In order to ensure that <span class="inlinecode"><span class="id" type="var">P</span></span> holds when the loop finally
    exits, we certainly need to make sure that the command <span class="inlinecode"><span class="id" type="var">c</span></span>
    guarantees that <span class="inlinecode"><span class="id" type="var">P</span></span> holds whenever <span class="inlinecode"><span class="id" type="var">c</span></span> is finished.
    Moreover, since <span class="inlinecode"><span class="id" type="var">P</span></span> holds at the beginning of the first
    execution of <span class="inlinecode"><span class="id" type="var">c</span></span>, and since each execution of <span class="inlinecode"><span class="id" type="var">c</span></span>
    re-establishes <span class="inlinecode"><span class="id" type="var">P</span></span> when it finishes, we can always assume
    that <span class="inlinecode"><span class="id" type="var">P</span></span> holds at the beginning of <span class="inlinecode"><span class="id" type="var">c</span></span>.  This leads us to the
    following rule:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;c&nbsp;{{P}}</td>
  <td class="infrulenamecol" rowspan="3">
    &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;WHILE&nbsp;b&nbsp;DO&nbsp;c&nbsp;END&nbsp;{{P&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~b}}</td>
  <td></td>
</td>
</table></center>    The proposition <span class="inlinecode"><span class="id" type="var">P</span></span> is called an <i>invariant</i>.

<div class="paragraph"> </div>

    This is almost the rule we want, but again it can be improved a
    little: at the beginning of the loop body, we know not only that
    <span class="inlinecode"><span class="id" type="var">P</span></span> holds, but also that the guard <span class="inlinecode"><span class="id" type="var">b</span></span> is true in the current
    state.  This gives us a little more information to use in
    reasoning about <span class="inlinecode"><span class="id" type="var">c</span></span> (showing that it establishes the invariant by
    the time it finishes).  This gives us the final version of the rule:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;b}}&nbsp;c&nbsp;{{P}}</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_while) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;WHILE&nbsp;b&nbsp;DO&nbsp;c&nbsp;END&nbsp;{{P&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~b}}</td>
  <td></td>
</td>
</table></center>
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">hoare_while</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">P</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">bassn</span> <span class="id" type="var">b</span> <span class="id" type="var">st</span>}} <span class="id" type="var">c</span> {{<span class="id" type="var">P</span>}} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">WHILE</span> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <span class="id" type="var">c</span> <span class="id" type="var">END</span> {{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> ~ (<span class="id" type="var">bassn</span> <span class="id" type="var">b</span> <span class="id" type="var">st</span>)}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span> <span class="id" type="var">Hhoare</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">He</span> <span class="id" type="var">HP</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Like&nbsp;we've&nbsp;seen&nbsp;before,&nbsp;we&nbsp;need&nbsp;to&nbsp;reason&nbsp;by&nbsp;induction&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on&nbsp;He,&nbsp;because,&nbsp;in&nbsp;the&nbsp;"keep&nbsp;looping"&nbsp;case,&nbsp;its&nbsp;hypotheses&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;talk&nbsp;about&nbsp;the&nbsp;whole&nbsp;loop&nbsp;instead&nbsp;of&nbsp;just&nbsp;c&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <span class="id" type="var">c</span> <span class="id" type="var">END</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">wcom</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">ceval_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">He</span>) <span class="id" type="var">Case</span>; <span class="id" type="tactic">try</span> (<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heqwcom</span>); <span class="id" type="tactic">subst</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "E_WhileEnd".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">bexp_eval_false</span>. <span class="id" type="tactic">assumption</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "E_WhileLoop".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHHe2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">Hhoare</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>). <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">bexp_eval_true</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">while_example</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> &lt;= 3}}<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> (<span class="id" type="var">BLe</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 2))<br/>
&nbsp;&nbsp;<span class="id" type="var">DO</span> <span class="id" type="var">X</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1) <span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = 3}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_post</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_while</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_asgn</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span>, <span class="id" type="var">assn_sub</span>, <span class="id" type="var">assert_implies</span>, <span class="id" type="var">update</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]. <span class="id" type="tactic">apply</span> <span class="id" type="var">ble_nat_true</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>. <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span>, <span class="id" type="var">assert_implies</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [<span class="id" type="var">Hle</span> <span class="id" type="var">Hb</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hb</span>. <span class="id" type="var">remember</span> (<span class="id" type="var">ble_nat</span> (<span class="id" type="var">st</span> <span class="id" type="var">X</span>) 2) <span class="id" type="keyword">as</span> <span class="id" type="var">le</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">le</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ex_falso_quodlibet</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Hb</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">symmetry</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqle</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">ble_nat_false</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqle</span>. <span class="id" type="tactic">omega</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
We can also use the while rule to prove the following Hoare
    triple, which may seem surprising at first... 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">always_loop_hoare</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">P</span> <span class="id" type="var">Q</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">WHILE</span> <span class="id" type="var">BTrue</span> <span class="id" type="var">DO</span> <span class="id" type="var">SKIP</span> <span class="id" type="var">END</span> {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_consequence_pre</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">P'</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">state</span> =&gt; <span class="id" type="var">True</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_post</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_while</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Loop body preserves invariant".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_post_true</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">I</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Loop invariant and negated guard imply postcondition".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [<span class="id" type="var">Hinv</span> <span class="id" type="var">Hguard</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ex_falso_quodlibet</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Hguard</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Precondition implies invariant".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>. <span class="id" type="var">constructor</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Actually, this result shouldn't be surprising.  If we look back at
    the definition of <span class="inlinecode"><span class="id" type="var">hoare_triple</span></span>, we can see that it asserts
    something meaningful <i>only</i> when the command terminates. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Print</span> <span class="id" type="var">hoare_triple</span>.<br/>

<br/>
</div>

<div class="doc">
If the command doesn't terminate, we can prove anything we like
    about the post-condition.  Here's a more direct proof of the same
    fact: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">always_loop_hoare'</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">P</span> <span class="id" type="var">Q</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="var">P</span>}} <span class="id" type="var">WHILE</span> <span class="id" type="var">BTrue</span> <span class="id" type="var">DO</span> <span class="id" type="var">SKIP</span> <span class="id" type="var">END</span> {{<span class="id" type="var">Q</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">hoare_triple</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Q</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">contra</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">loop_never_stops</span> <span class="id" type="keyword">in</span> <span class="id" type="var">contra</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">contra</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Hoare rules that only talk about terminating commands are often
    said to describe a logic of "partial" correctness.  It is also
    possible to give Hoare rules for "total" correctness, which build
    in the fact that the commands terminate. However, in this course
    we will focus only on partial correctness. 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab421"></a><h3 class="section">Exercise: <span class="inlinecode"><span class="id" type="var">REPEAT</span></span></h3>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">RepeatExercise</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab422"></a><h4 class="section">Exercise: 4 stars (hoare_repeat)</h4>
 In this exercise, we'll add a new command to our language of
    commands: <span class="inlinecode"><span class="id" type="var">REPEAT</span></span> c <span class="inlinecode"><span class="id" type="var">UNTIL</span></span> a <span class="inlinecode"><span class="id" type="var">END</span></span>. You will write the
    evaluation rule for <span class="inlinecode"><span class="id" type="tactic">repeat</span></span> and add a new Hoare rule to
    the language for programs involving it. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">com</span> : <span class="id" type="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">CSkip</span> : <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CAsgn</span> : <span class="id" type="var">id</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CSeq</span> : <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CIf</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CWhile</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CRepeat</span> : <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span>.<br/>

<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" type="var">REPEAT</span></span> behaves like <span class="inlinecode"><span class="id" type="var">WHILE</span></span>, except that the loop guard is
    checked <i>after</i> each execution of the body, with the loop
    repeating as long as the guard stays <i>false</i>.  Because of this,
    the body will always execute at least once. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Tactic Notation</span> "com_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "SKIP" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "::=" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> ";"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "IFB" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "WHILE" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "CRepeat" ].<br/>

<br/>
<span class="id" type="keyword">Notation</span> "'SKIP'" := <br/>
&nbsp;&nbsp;<span class="id" type="var">CSkip</span>.<br/>
<span class="id" type="keyword">Notation</span> "c1 ; c2" := <br/>
&nbsp;&nbsp;(<span class="id" type="var">CSeq</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "X '::=' a" := <br/>
&nbsp;&nbsp;(<span class="id" type="var">CAsgn</span> <span class="id" type="var">X</span> <span class="id" type="var">a</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 60).<br/>
<span class="id" type="keyword">Notation</span> "'WHILE' b 'DO' c 'END'" := <br/>
&nbsp;&nbsp;(<span class="id" type="var">CWhile</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'IFB' e1 'THEN' e2 'ELSE' e3 'FI'" := <br/>
&nbsp;&nbsp;(<span class="id" type="var">CIf</span> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span> <span class="id" type="var">e3</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'REPEAT' e1 'UNTIL' b2 'END'" := <br/>
&nbsp;&nbsp;(<span class="id" type="var">CRepeat</span> <span class="id" type="var">e1</span> <span class="id" type="var">b2</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>

<br/>
</div>

<div class="doc">
Add new rules for <span class="inlinecode"><span class="id" type="var">REPEAT</span></span> to <span class="inlinecode"><span class="id" type="var">ceval</span></span> below.  You can use the rules
    for <span class="inlinecode"><span class="id" type="var">WHILE</span></span> as a guide, but remember that the body of a <span class="inlinecode"><span class="id" type="var">REPEAT</span></span>
    should always execute at least once, and that the loop ends when
    the guard becomes true.  Then update the <span class="inlinecode"><span class="id" type="var">ceval_cases</span></span> tactic to
    handle these added cases.  
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">ceval</span> : <span class="id" type="var">state</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">state</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Skip</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ceval</span> <span class="id" type="var">st</span> <span class="id" type="var">SKIP</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Ass</span>  : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> <span class="id" type="var">a1</span> <span class="id" type="var">n</span> <span class="id" type="var">X</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a1</span> = <span class="id" type="var">n</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ceval</span> <span class="id" type="var">st</span> (<span class="id" type="var">X</span> ::= <span class="id" type="var">a1</span>) (<span class="id" type="var">update</span> <span class="id" type="var">st</span> <span class="id" type="var">X</span> <span class="id" type="var">n</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Seq</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">c1</span> <span class="id" type="var">c2</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ceval</span> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ceval</span> <span class="id" type="var">st'</span> <span class="id" type="var">c2</span> <span class="id" type="var">st''</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ceval</span> <span class="id" type="var">st</span> (<span class="id" type="var">c1</span> ; <span class="id" type="var">c2</span>) <span class="id" type="var">st''</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_IfTrue</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">b1</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">true</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ceval</span> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ceval</span> <span class="id" type="var">st</span> (<span class="id" type="var">IFB</span> <span class="id" type="var">b1</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) <span class="id" type="var">st'</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_IfFalse</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">b1</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">false</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ceval</span> <span class="id" type="var">st</span> <span class="id" type="var">c2</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ceval</span> <span class="id" type="var">st</span> (<span class="id" type="var">IFB</span> <span class="id" type="var">b1</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) <span class="id" type="var">st'</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_WhileEnd</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">b1</span> <span class="id" type="var">st</span> <span class="id" type="var">c1</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">false</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ceval</span> <span class="id" type="var">st</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_WhileLoop</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span> <span class="id" type="var">b1</span> <span class="id" type="var">c1</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">true</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ceval</span> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ceval</span> <span class="id" type="var">st'</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) <span class="id" type="var">st''</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ceval</span> <span class="id" type="var">st</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) <span class="id" type="var">st''</span><br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
.<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "ceval_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Skip" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Ass" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Seq"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_IfTrue" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_IfFalse"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_WhileEnd" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_WhileLoop" <br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
].<br/>

<br/>
</div>

<div class="doc">
A couple of definitions from above, copied here so they use the
    new <span class="inlinecode"><span class="id" type="var">ceval</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Notation</span> "c1 '/' st '<span style="font-family: arial;">&dArr;</span>' st'" := (<span class="id" type="var">ceval</span> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="var">st'</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 40, <span class="id" type="var">st</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">hoare_triple</span> (<span class="id" type="var">P</span>:<span class="id" type="var">Assertion</span>) (<span class="id" type="var">c</span>:<span class="id" type="var">com</span>) (<span class="id" type="var">Q</span>:<span class="id" type="var">Assertion</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> <span class="id" type="var">st'</span>, (<span class="id" type="var">c</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span>) <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Q</span> <span class="id" type="var">st'</span>.<br/>

<br/>
<span class="id" type="keyword">Notation</span> "{{ P }}  c  {{ Q }}" :=<br/>
&nbsp;&nbsp;(<span class="id" type="var">hoare_triple</span> <span class="id" type="var">P</span> <span class="id" type="var">c</span> <span class="id" type="var">Q</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 90, <span class="id" type="var">c</span> <span class="id" type="tactic">at</span> <span class="id" type="var">next</span> <span class="id" type="var">level</span>).<br/>

<br/>
</div>

<div class="doc">
To make sure you've got the evaluation rules for <span class="inlinecode"><span class="id" type="var">REPEAT</span></span> right,
    prove that <span class="inlinecode"><span class="id" type="var">ex1_repeat</span></span> <span class="inlinecode"><span class="id" type="var">evaluates</span></span> <span class="inlinecode"><span class="id" type="var">correctly</span>.</span> <span class="inlinecode"></span>
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">ex1_repeat</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">REPEAT</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">ANum</span> 1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>) (<span class="id" type="var">ANum</span> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">UNTIL</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1)) <span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">ex1_repeat_works</span> :<br/>
&nbsp;&nbsp;<span class="id" type="var">ex1_repeat</span> / <span class="id" type="var">empty_state</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">update</span> (<span class="id" type="var">update</span> <span class="id" type="var">empty_state</span> <span class="id" type="var">X</span> 1) <span class="id" type="var">Y</span> 1.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>

<br/>
</div>

<div class="doc">
Now state and prove a theorem, <span class="inlinecode"><span class="id" type="var">hoare_repeat</span></span>, that expresses an
    appropriate proof rule for <span class="inlinecode"><span class="id" type="tactic">repeat</span></span> commands.  Use <span class="inlinecode"><span class="id" type="var">hoare_while</span></span>
    as a model, and try to make your rule as precise as possible. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>

<br/>
</div>

<div class="doc">
For full credit, make sure (informally) that your rule can be used
    to prove the following <i>valid</i> Hoare triple:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;&gt;&nbsp;0&nbsp;}}<br/>
&nbsp;&nbsp;<span class="id" type="var">REPEAT</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;-&nbsp;1<br/>
&nbsp;&nbsp;<span class="id" type="var">UNTIL</span>&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;0&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;0&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;&gt;&nbsp;0&nbsp;}}
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">RepeatExercise</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab423"></a><h2 class="section">Exercise: <span class="inlinecode"><span class="id" type="var">HAVOC</span></span></h2>

<div class="paragraph"> </div>

<a name="lab424"></a><h4 class="section">Exercise: 3 stars (himp_hoare)</h4>

<div class="paragraph"> </div>

 In this exercise, we will derive proof rules for the <span class="inlinecode"><span class="id" type="var">HAVOC</span></span> command
    which we studied in the last chapter. First, we enclose this work
    in a separate module, and recall the syntax and big-step semantics
    of Himp commands. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">Himp</span>.<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">com</span> : <span class="id" type="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">CSkip</span> : <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CAsgn</span> : <span class="id" type="var">id</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CSeq</span> : <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CIf</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CWhile</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CHavoc</span> : <span class="id" type="var">id</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span>.<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "com_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "SKIP" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "::=" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> ";"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "IFB" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "WHILE" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "HAVOC" ].<br/>

<br/>
<span class="id" type="keyword">Notation</span> "'SKIP'" :=<br/>
&nbsp;&nbsp;<span class="id" type="var">CSkip</span>.<br/>
<span class="id" type="keyword">Notation</span> "X '::=' a" :=<br/>
&nbsp;&nbsp;(<span class="id" type="var">CAsgn</span> <span class="id" type="var">X</span> <span class="id" type="var">a</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 60).<br/>
<span class="id" type="keyword">Notation</span> "c1 ; c2" :=<br/>
&nbsp;&nbsp;(<span class="id" type="var">CSeq</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'WHILE' b 'DO' c 'END'" :=<br/>
&nbsp;&nbsp;(<span class="id" type="var">CWhile</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'IFB' e1 'THEN' e2 'ELSE' e3 'FI'" :=<br/>
&nbsp;&nbsp;(<span class="id" type="var">CIf</span> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span> <span class="id" type="var">e3</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'HAVOC' X" := (<span class="id" type="var">CHavoc</span> <span class="id" type="var">X</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 60).<br/>

<br/>
<span class="id" type="keyword">Reserved Notation</span> "c1 '/' st '<span style="font-family: arial;">&dArr;</span>' st'" (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 40, <span class="id" type="var">st</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39).<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">ceval</span> : <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">state</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">state</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Skip</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> : <span class="id" type="var">state</span>, <span class="id" type="var">SKIP</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Ass</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">a1</span> : <span class="id" type="var">aexp</span>) (<span class="id" type="var">n</span> : <span class="id" type="var">nat</span>) (<span class="id" type="var">X</span> : <span class="id" type="var">id</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a1</span> = <span class="id" type="var">n</span> <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">X</span> ::= <span class="id" type="var">a1</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">update</span> <span class="id" type="var">st</span> <span class="id" type="var">X</span> <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Seq</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">c1</span> <span class="id" type="var">c2</span> : <span class="id" type="var">com</span>) (<span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span> : <span class="id" type="var">state</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">c2</span> / <span class="id" type="var">st'</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span> <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">c1</span> ; <span class="id" type="var">c2</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_IfTrue</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span> <span class="id" type="var">st'</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">b1</span> : <span class="id" type="var">bexp</span>) (<span class="id" type="var">c1</span> <span class="id" type="var">c2</span> : <span class="id" type="var">com</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">true</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">IFB</span> <span class="id" type="var">b1</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_IfFalse</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span> <span class="id" type="var">st'</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">b1</span> : <span class="id" type="var">bexp</span>) (<span class="id" type="var">c1</span> <span class="id" type="var">c2</span> : <span class="id" type="var">com</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">false</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c2</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">IFB</span> <span class="id" type="var">b1</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_WhileEnd</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">b1</span> : <span class="id" type="var">bexp</span>) (<span class="id" type="var">st</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">c1</span> : <span class="id" type="var">com</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">false</span> <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_WhileLoop</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">b1</span> : <span class="id" type="var">bexp</span>) (<span class="id" type="var">c1</span> : <span class="id" type="var">com</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">true</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st'</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Havoc</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">X</span> : <span class="id" type="var">id</span>) (<span class="id" type="var">n</span> : <span class="id" type="var">nat</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">HAVOC</span> <span class="id" type="var">X</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">update</span> <span class="id" type="var">st</span> <span class="id" type="var">X</span> <span class="id" type="var">n</span><br/>
<br/>
&nbsp;&nbsp;<span class="id" type="keyword">where</span> "c1 '/' st '<span style="font-family: arial;">&dArr;</span>' st'" := (<span class="id" type="var">ceval</span> <span class="id" type="var">c1</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>).<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "ceval_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Skip" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Ass" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Seq"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_IfTrue" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_IfFalse"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_WhileEnd" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_WhileLoop"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Havoc" ].<br/>

<br/>
</div>

<div class="doc">
The definition of Hoare triples is exactly as before. Unlike our
    notion of equivalence, which had subtle consequences with
    occassionally nonterminating commands (exercise <span class="inlinecode"><span class="id" type="var">havoc_diverge</span></span>),
    this definition is still fully satisfactory. Convince yourself of
    this before proceeding. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">hoare_triple</span> (<span class="id" type="var">P</span>:<span class="id" type="var">Assertion</span>) (<span class="id" type="var">c</span>:<span class="id" type="var">com</span>) (<span class="id" type="var">Q</span>:<span class="id" type="var">Assertion</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> <span class="id" type="var">st'</span>, <span class="id" type="var">c</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Q</span> <span class="id" type="var">st'</span>.<br/>

<br/>
<span class="id" type="keyword">Notation</span> "{{ P }}  c  {{ Q }}" := (<span class="id" type="var">hoare_triple</span> <span class="id" type="var">P</span> <span class="id" type="var">c</span> <span class="id" type="var">Q</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 90, <span class="id" type="var">c</span> <span class="id" type="tactic">at</span> <span class="id" type="var">next</span> <span class="id" type="var">level</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" type="var">hoare_spec_scope</span>.<br/>

<br/>
</div>

<div class="doc">
Complete the Hoare rule for <span class="inlinecode"><span class="id" type="var">HAVOC</span></span> commands below by defining
    <span class="inlinecode"><span class="id" type="var">havoc_pre</span></span> and prove that the resulting rule is correct. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">havoc_pre</span> (<span class="id" type="var">X</span> : <span class="id" type="var">id</span>) (<span class="id" type="var">Q</span> : <span class="id" type="var">Assertion</span>) : <span class="id" type="var">Assertion</span> :=<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">admit</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">hoare_havoc</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">Q</span> : <span class="id" type="var">Assertion</span>) (<span class="id" type="var">X</span> : <span class="id" type="var">id</span>),<br/>
&nbsp;&nbsp;{{ <span class="id" type="var">havoc_pre</span> <span class="id" type="var">X</span> <span class="id" type="var">Q</span> }} <span class="id" type="var">HAVOC</span> <span class="id" type="var">X</span> {{ <span class="id" type="var">Q</span> }}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>

<br/>
</div>

<div class="doc">
Like in the <span class="inlinecode"><span class="id" type="var">hoare_asgn_weakest</span></span> exercise above, show that your
    <span class="inlinecode"><span class="id" type="var">havoc_pre</span></span> returns the weakest precondition. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">hoare_havoc_weakest</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">P</span> <span class="id" type="var">Q</span> : <span class="id" type="var">Assertion</span>) (<span class="id" type="var">X</span> : <span class="id" type="var">id</span>),<br/>
&nbsp;&nbsp;{{ <span class="id" type="var">P</span> }} <span class="id" type="var">HAVOC</span> <span class="id" type="var">X</span> {{ <span class="id" type="var">Q</span> }} <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">P</span> <span style="font-family: arial;">&#8669;</span> <span class="id" type="var">havoc_pre</span> <span class="id" type="var">X</span> <span class="id" type="var">Q</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>

<br/>
<span class="comment">(*&nbsp;/SOLUTION&nbsp;*)</span><br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">Himp</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab425"></a><h1 class="section">Review of Hoare Logic</h1>

<div class="paragraph"> </div>

 Above, we've introduced Hoare Logic as a tool to reasoning
    about Imp programs. In the reminder of this chapter we will
    explore a systematic way to use Hoare Logic to prove properties
    about programs. The rules of Hoare Logic are the following: 
<div class="paragraph"> </div>


<div class="paragraph"> </div>

<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_asgn) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{assn_sub&nbsp;X&nbsp;a&nbsp;Q}}&nbsp;X::=a&nbsp;{{Q}}</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_skip) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{&nbsp;P&nbsp;}}&nbsp;SKIP&nbsp;{{&nbsp;P&nbsp;}}</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{&nbsp;P&nbsp;}}&nbsp;c1&nbsp;{{&nbsp;Q&nbsp;}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">{{&nbsp;Q&nbsp;}}&nbsp;c2&nbsp;{{&nbsp;R&nbsp;}}</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_seq) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{&nbsp;P&nbsp;}}&nbsp;c1;c2&nbsp;{{&nbsp;R&nbsp;}}</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;&nbsp;b}}&nbsp;c1&nbsp;{{Q}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">{{P&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~b}}&nbsp;c2&nbsp;{{Q}}</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_if) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;IFB&nbsp;b&nbsp;THEN&nbsp;c1&nbsp;ELSE&nbsp;c2&nbsp;FI&nbsp;{{Q}}</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;b}}&nbsp;c&nbsp;{{P}}</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_while) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;WHILE&nbsp;b&nbsp;DO&nbsp;c&nbsp;END&nbsp;{{P&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~b}}</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">{{P'}}&nbsp;c&nbsp;{{Q'}}</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">P&nbsp;<span style="font-family: arial;">&#8669;</span>&nbsp;P'</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">Q'&nbsp;<span style="font-family: arial;">&#8669;</span>&nbsp;Q</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_consequence) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">{{P}}&nbsp;c&nbsp;{{Q}}</td>
  <td></td>
</td>
</table></center>
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab426"></a><h1 class="section">Decorated Programs</h1>

<div class="paragraph"> </div>

 The beauty of Hoare Logic is that it is <i>compositional</i> &mdash; the
    structure of proofs exactly follows the structure of programs.
    This fact suggests that we could record the essential ideas of
    a proof informally (leaving out some low-level calculational
    details) by decorating programs with appropriate assertions around
    each statement.  Such a <i>decorated program</i> carries with it
    an (informal) proof of its own correctness. 
<div class="paragraph"> </div>

 For example, here is a complete decorated program: 
<div class="paragraph"> </div>


<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">x</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">x</span>;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;=&gt;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">z</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">z</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Z</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;(<span class="id" type="var">Z</span>&nbsp;-&nbsp;1)&nbsp;-&nbsp;(<span class="id" type="var">X</span>&nbsp;-&nbsp;1)&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;(<span class="id" type="var">X</span>&nbsp;-&nbsp;1)&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;-&nbsp;1&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~&nbsp;(<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0)&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;+&nbsp;1&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;+&nbsp;1&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">Z</span>&nbsp;+&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;+&nbsp;1&nbsp;}}
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

 Concretely, a decorated program consists of the program text
    interleaved with assertions.  To check that a decorated program
    represents a valid proof, we check that each individual command is
    <i>locally</i> consistent with its accompanying assertions in the
    following sense: 
<div class="paragraph"> </div>


<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" type="var">SKIP</span></span> is locally consistent if its precondition and
      postcondition are the same:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;}}&nbsp;
<div class="paragraph"> </div>

</div>

</li>
<li> The sequential composition of commands <span class="inlinecode"><span class="id" type="var">c1</span></span> and <span class="inlinecode"><span class="id" type="var">c2</span></span> is locally
      consistent (with respect to assertions <span class="inlinecode"><span class="id" type="var">P</span></span> and <span class="inlinecode"><span class="id" type="var">R</span></span>) if <span class="inlinecode"><span class="id" type="var">c1</span></span> is
      locally consistent (with respect to <span class="inlinecode"><span class="id" type="var">P</span></span> and <span class="inlinecode"><span class="id" type="var">Q</span></span>) and <span class="inlinecode"><span class="id" type="var">c2</span></span> is
      locally consistent (with respect to <span class="inlinecode"><span class="id" type="var">Q</span></span> and <span class="inlinecode"><span class="id" type="var">R</span></span>):

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Q</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">R</span>&nbsp;}}
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>


</li>
<li> An assignment is locally consistent if its precondition is
      the appropriate substitution of its postcondition:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;<span class="id" type="keyword">where</span>&nbsp;<span class="id" type="var">a</span>&nbsp;<span class="id" type="var">is</span>&nbsp;<span class="id" type="var">substituted</span>&nbsp;<span class="id" type="keyword">for</span>&nbsp;<span class="id" type="var">X</span>&nbsp;}}&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">a</span>&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;}}
<div class="paragraph"> </div>

</div>

</li>
<li> A conditional is locally consistent (with respect to assertions
      <span class="inlinecode"><span class="id" type="var">P</span></span> and <span class="inlinecode"><span class="id" type="var">Q</span></span>) if the assertions at the top of its "then" and
      "else" branches are exactly <span class="inlinecode"><span class="id" type="var">P</span><span style="font-family: arial;">&and;</span><span class="id" type="var">b</span></span> and <span class="inlinecode"><span class="id" type="var">P</span>/\~<span class="id" type="var">b</span></span> and if its "then"
      branch is locally consistent (with respect to <span class="inlinecode"><span class="id" type="var">P</span><span style="font-family: arial;">&and;</span><span class="id" type="var">b</span></span> and <span class="inlinecode"><span class="id" type="var">Q</span></span>)
      and its "else" branch is locally consistent (with respect to
      <span class="inlinecode"><span class="id" type="var">P</span>/\~<span class="id" type="var">b</span></span> and <span class="inlinecode"><span class="id" type="var">Q</span></span>):

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span>&nbsp;<span class="id" type="var">b</span>&nbsp;<span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">b</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Q</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~<span class="id" type="var">b</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Q</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">FI</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Q</span>&nbsp;}}
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>


</li>
<li> A while loop is locally consistent if its postcondition is
      <span class="inlinecode"><span class="id" type="var">P</span>/\~<span class="id" type="var">b</span></span> (where <span class="inlinecode"><span class="id" type="var">P</span></span> is its precondition) and if the pre- and
      postconditions of its body are exactly <span class="inlinecode"><span class="id" type="var">P</span><span style="font-family: arial;">&and;</span><span class="id" type="var">b</span></span> and <span class="inlinecode"><span class="id" type="var">P</span></span>:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">b</span>&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">b</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~<span class="id" type="var">b</span>&nbsp;}}&nbsp;
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>


</li>
<li> A pair of assertions separated by <span class="inlinecode">=&gt;</span> is locally consistent if
      the first implies the second (in all states):

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P</span>&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">P'</span>&nbsp;}}&nbsp;
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

      This corresponds to the application of <span class="inlinecode"><span class="id" type="var">hoare_consequence</span></span> and
      is the only place in a decorated program where checking if the
      decorations are correct is not fully mechanical and syntactic,
      but it involves logical and maybe arithmetic reasoning.

</li>
</ul>

</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab427"></a><h1 class="section">Sample Hoare Logic Proofs</h1>

</div>
<div class="code code-space">

<br/>
</div>

<div class="doc">
<a name="lab428"></a><h2 class="section">Example: Slow Subtraction</h2>

<div class="paragraph"> </div>

 We've seen an Imp program for subtracting one number from another by 
    repeatedly subtracting one from each number until the one being 
    subtracted reaches zero.

<div class="paragraph"> </div>

    Here is a full proof &mdash; presented as a decorated program &mdash; that this 
    program meets a natural specification:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;(1)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Z</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;}}&nbsp;=&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(2)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;<span class="id" type="var">DO</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(3)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;}}&nbsp;=&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(4)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;(<span class="id" type="var">Z</span>&nbsp;-&nbsp;1)&nbsp;-&nbsp;(<span class="id" type="var">X</span>&nbsp;-&nbsp;1)&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(5)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;(<span class="id" type="var">X</span>&nbsp;-&nbsp;1)&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;-&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(6)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(7)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~&nbsp;(<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0)&nbsp;}}&nbsp;=&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(8)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Z</span>&nbsp;=&nbsp;<span class="id" type="var">z</span>&nbsp;-&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<div class="paragraph"> </div>

</div>
    The decorations were constructed as follows:

<div class="paragraph"> </div>

<ul class="doclist">
<li> Begin with the undecorated program (the unnumbered lines).

</li>
<li> Add the specification &mdash; i.e., the outer precondition (1) and
        postcondition (8).

</li>
<li> Write down the invariant of the loop (6).

</li>
<li> Following the format dictated by the <span class="inlinecode"><span class="id" type="var">hoare_while</span></span> rule, add
        the final use of the rule of consequence &mdash; the assertion in
        line (7) and the check that (7) implies (8).

</li>
<li> Check that the loop invariant <i>is</i> an invariant of the loop
        body by using the assignment rule twice to push the invariant
        backwards from the end of the loop body to the
        beginning (line (5) and then line (4)), and then filling in
        the rule of consequence asserting that the invariant plus the
        fact that the loop guard is true (line (3)) implies line (4).

</li>
<li> Check that the invariant is established at the beginning of
        the loop verifying that line (2) is implied by line (1).

</li>
</ul>

<div class="paragraph"> </div>

    As in most Hoare Logic proofs, the only challenging part of this
    process is finding the right loop invariant.  There is no
    foolproof procedure for this, but a helpful heuristic is to begin
    by assumimng that the loop invariant is exactly the desired
    postcondition (i.e., that lines (6) and (8) are the same) and then
    calculating a bit to find out why this assertion is <i>not</i> an
    invariant of the loop body.  

<div class="paragraph"> </div>

    In this case, it quickly becomes clear that assertion (8) is not
    an invariant of the loop body because the loop body changes the
    variable <span class="inlinecode"><span class="id" type="var">Z</span></span>, but (obviously) not the global constants <span class="inlinecode"><span class="id" type="var">x</span></span> and
    <span class="inlinecode"><span class="id" type="var">z</span></span>.  So we need to generalize (8) to some statement that is
    equivalent to (8) when <span class="inlinecode"><span class="id" type="var">X</span></span> is <span class="inlinecode">0</span>, since this will be the case
    when the loop terminates, and that "fills the gap" in some
    appropriate way when <span class="inlinecode"><span class="id" type="var">X</span></span> is nonzero. 
<div class="paragraph"> </div>

 From this informal proof, it is now easy to read off a formal
    proof in terms of the Hoare rules: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">subtract_slowly</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span> ::= <span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>) (<span class="id" type="var">ANum</span> 1);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">subtract_slowly_invariant</span> <span class="id" type="var">x</span> <span class="id" type="var">z</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">minus</span> (<span class="id" type="var">st</span> <span class="id" type="var">Z</span>) (<span class="id" type="var">st</span> <span class="id" type="var">X</span>) = <span class="id" type="var">minus</span> <span class="id" type="var">z</span> <span class="id" type="var">x</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">subtract_slowly_correct</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">z</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">x</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">st</span> <span class="id" type="var">Z</span> = <span class="id" type="var">z</span>}} <br/>
&nbsp;&nbsp;<span class="id" type="var">subtract_slowly</span> <br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">Z</span> = <span class="id" type="var">minus</span> <span class="id" type="var">z</span> <span class="id" type="var">x</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Note&nbsp;that&nbsp;we&nbsp;do&nbsp;NOT&nbsp;unfold&nbsp;the&nbsp;definition&nbsp;of&nbsp;hoare_triple<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anywhere&nbsp;in&nbsp;this&nbsp;proof!&nbsp;&nbsp;The&nbsp;goal&nbsp;is&nbsp;to&nbsp;use&nbsp;only&nbsp;the&nbsp;Hoare<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rules.&nbsp;Your&nbsp;proofs&nbsp;should&nbsp;do&nbsp;the&nbsp;same.&nbsp;*)</span><br/>

<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">z</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">subtract_slowly</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;First&nbsp;we&nbsp;need&nbsp;to&nbsp;transform&nbsp;the&nbsp;pre&nbsp;and&nbsp;postconditions&nbsp;so<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;that&nbsp;hoare_while&nbsp;will&nbsp;apply.&nbsp;&nbsp;In&nbsp;particular,&nbsp;the<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;precondition&nbsp;should&nbsp;be&nbsp;the&nbsp;loop&nbsp;invariant.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">P'</span> := <span class="id" type="var">subtract_slowly_invariant</span> <span class="id" type="var">x</span> <span class="id" type="var">z</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_while</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Loop body preserves invariant".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Split&nbsp;up&nbsp;the&nbsp;two&nbsp;assignments&nbsp;with&nbsp;hoare_seq&nbsp;-&nbsp;using&nbsp;eapply&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lets&nbsp;us&nbsp;solve&nbsp;the&nbsp;second&nbsp;one&nbsp;immediately&nbsp;with&nbsp;hoare_asgn&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_seq</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_asgn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Now&nbsp;for&nbsp;the&nbsp;first&nbsp;assignment,&nbsp;transform&nbsp;the&nbsp;precondition<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;hoare_asgn&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_asgn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Finally,&nbsp;we&nbsp;need&nbsp;to&nbsp;justify&nbsp;the&nbsp;implication&nbsp;generated&nbsp;by<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hoare_consequence_pre&nbsp;(this&nbsp;bit&nbsp;of&nbsp;reasoning&nbsp;is&nbsp;elided&nbsp;in&nbsp;the<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;informal&nbsp;proof)&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">subtract_slowly_invariant</span>, <span class="id" type="var">assn_sub</span>, <span class="id" type="var">update</span>, <span class="id" type="var">bassn</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [<span class="id" type="var">Inv</span> <span class="id" type="var">GuardTrue</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Could&nbsp;alternatively&nbsp;do&nbsp;case&nbsp;analysis&nbsp;on&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;negb&nbsp;(beq_nat&nbsp;(st&nbsp;X)&nbsp;0)&nbsp;here;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;but&nbsp;SearchAbout&nbsp;reveals&nbsp;some&nbsp;nice&nbsp;lemmas&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Search</span><span class="id" type="var">About</span> [<span class="id" type="var">negb</span> <span class="id" type="var">true</span>]. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">negb_true_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">GuardTrue</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Search</span><span class="id" type="var">About</span> [<span class="id" type="var">beq_nat</span> <span class="id" type="var">false</span>]. <span class="id" type="tactic">apply</span> <span class="id" type="var">beq_nat_false</span> <span class="id" type="keyword">in</span> <span class="id" type="var">GuardTrue</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">omega</span>. <span class="comment">(*&nbsp;slow&nbsp;but&nbsp;effective!&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Faster&nbsp;variant:&nbsp;rewrite&nbsp;&lt;-&nbsp;Inv.&nbsp;clear&nbsp;Inv.&nbsp;omega.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Initial state satisfies invariant".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;This&nbsp;is&nbsp;the&nbsp;subgoal&nbsp;generated&nbsp;by&nbsp;the&nbsp;precondition&nbsp;part&nbsp;of&nbsp;our<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first&nbsp;use&nbsp;of&nbsp;hoare_consequence.&nbsp;&nbsp;It's&nbsp;the&nbsp;first&nbsp;implication<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;written&nbsp;in&nbsp;the&nbsp;decorated&nbsp;program&nbsp;(though&nbsp;we&nbsp;elided&nbsp;the&nbsp;actual<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proof&nbsp;there).&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">subtract_slowly_invariant</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [<span class="id" type="var">HX</span> <span class="id" type="var">HZ</span>]. <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Invariant and negated guard imply postcondition".<br/>
&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;This&nbsp;is&nbsp;the&nbsp;subgoal&nbsp;generated&nbsp;by&nbsp;the&nbsp;postcondition&nbsp;part&nbsp;of<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out&nbsp;first&nbsp;use&nbsp;of&nbsp;hoare_consequence.&nbsp;&nbsp;This&nbsp;implication&nbsp;is<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;one&nbsp;written&nbsp;after&nbsp;the&nbsp;while&nbsp;loop&nbsp;in&nbsp;the&nbsp;informal&nbsp;proof.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [<span class="id" type="var">Inv</span> <span class="id" type="var">GuardFalse</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">subtract_slowly_invariant</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Inv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span> <span class="id" type="keyword">in</span> <span class="id" type="var">GuardFalse</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">GuardFalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;SearchAbout&nbsp;helps&nbsp;again&nbsp;to&nbsp;find&nbsp;the&nbsp;right&nbsp;lemmas&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Search</span><span class="id" type="var">About</span> [<span class="id" type="var">not</span> <span class="id" type="var">true</span>]. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">not_true_iff_false</span> <span class="id" type="keyword">in</span> <span class="id" type="var">GuardFalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Search</span><span class="id" type="var">About</span> [<span class="id" type="var">negb</span> <span class="id" type="var">false</span>]. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">negb_false_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">GuardFalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Search</span><span class="id" type="var">About</span> [<span class="id" type="var">beq_nat</span> <span class="id" type="var">true</span>]. <span class="id" type="tactic">apply</span> <span class="id" type="var">beq_nat_true</span> <span class="id" type="keyword">in</span> <span class="id" type="var">GuardFalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">omega</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab429"></a><h2 class="section">Exercise: Reduce to Zero</h2>

<div class="paragraph"> </div>

<a name="lab430"></a><h4 class="section">Exercise: 2 stars (reduce_to_zero_correct)</h4>
 Here is a while loop that is so simple it needs no invariant: 

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;-&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;0&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;0&nbsp;}}
<div class="paragraph"> </div>

</div>
   Your job is to translate this proof to Coq.  Refer to the
   <span class="inlinecode"><span class="id" type="var">slow_subtraction</span></span> example for ideas.

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">reduce_to_zero</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">reduce_to_zero_correct</span> : <br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">True</span>}}<br/>
&nbsp;&nbsp;<span class="id" type="var">reduce_to_zero</span><br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = 0}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab431"></a><h2 class="section">Exercise: Slow Addition</h2>

<div class="paragraph"> </div>

 The following program adds the variable X into the variable Z
    by repeatedly decrementing X and incrementing Z. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">add_slowly</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>) (<span class="id" type="var">ANum</span> 1);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab432"></a><h4 class="section">Exercise: 3 stars (add_slowly_decoration)</h4>
 Following the pattern of the <span class="inlinecode"><span class="id" type="var">subtract_slowly</span></span> example above, pick
    a precondition and postcondition that give an appropriate
    specification of <span class="inlinecode"><span class="id" type="var">add_slowly</span></span>; then (informally) decorate the
    program accordingly. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab433"></a><h4 class="section">Exercise: 3 stars (add_slowly_formal)</h4>
 Now write down your specification of <span class="inlinecode"><span class="id" type="var">add_slowly</span></span> formally, as a
    Coq <span class="inlinecode"><span class="id" type="var">Hoare_triple</span></span>, and prove it valid. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab434"></a><h2 class="section">Example: Parity</h2>

<div class="paragraph"> </div>

 Here's another, slightly trickier example.  Make sure you
    understand the decorated program completely.  You may find it
    instructive to start with the bare program and try to fill in the
    decorations yourself.  Notice exactly where the condition <span class="inlinecode"><span class="id" type="var">X</span>&lt;=<span class="id" type="var">x</span></span>
    comes up. 
<div class="paragraph"> </div>


<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;0&nbsp;=&nbsp;0&nbsp;}}<br/>
&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;0&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;(<span class="id" type="var">Y</span>=0&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">ev</span>&nbsp;(<span class="id" type="var">x</span>-<span class="id" type="var">X</span>))&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&lt;=<span class="id" type="var">x</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;(<span class="id" type="var">Y</span>=0&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">ev</span>&nbsp;(<span class="id" type="var">x</span>-<span class="id" type="var">X</span>))&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&lt;=<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&lt;&gt;0&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;(1-<span class="id" type="var">Y</span>)=0&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">ev</span>&nbsp;(<span class="id" type="var">x</span>-(<span class="id" type="var">X</span>-1))&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>-1&lt;=<span class="id" type="var">x</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;1&nbsp;-&nbsp;<span class="id" type="var">Y</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>=0&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">ev</span>&nbsp;(<span class="id" type="var">x</span>-(<span class="id" type="var">X</span>-1))&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>-1&lt;=<span class="id" type="var">x</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;-&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>=0&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">ev</span>&nbsp;(<span class="id" type="var">x</span>-<span class="id" type="var">X</span>)&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&lt;=<span class="id" type="var">x</span>&nbsp;}}&nbsp;<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;(<span class="id" type="var">Y</span>=0&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">ev</span>&nbsp;(<span class="id" type="var">x</span>-<span class="id" type="var">X</span>))&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&lt;=<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;~(<span class="id" type="var">X</span>&lt;&gt;0)&nbsp;}}&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>=0&nbsp;<span style="font-family: arial;">&harr;</span>&nbsp;<span class="id" type="var">ev</span>&nbsp;<span class="id" type="var">x</span>&nbsp;}}
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

 And here is the formal version of this proof.  Skim them,
    but you do not need to understand every detail (though the details
    are not actually very hard), since all the important ideas are
    already in the informal version. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">find_parity</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= (<span class="id" type="var">ANum</span> 0);<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> (<span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0))) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">AMinus</span> (<span class="id" type="var">ANum</span> 1) (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">find_parity_invariant</span> <span class="id" type="var">x</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st</span> <span class="id" type="var">X</span> &lt;= <span class="id" type="var">x</span> <span style="font-family: arial;">&and;</span> ((<span class="id" type="var">st</span> <span class="id" type="var">Y</span> = 0 <span style="font-family: arial;">&and;</span> <span class="id" type="var">ev</span> (<span class="id" type="var">x</span> - <span class="id" type="var">st</span> <span class="id" type="var">X</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&or;</span> (<span class="id" type="var">st</span> <span class="id" type="var">Y</span> = 1 <span style="font-family: arial;">&and;</span> ~<span class="id" type="var">ev</span> (<span class="id" type="var">x</span> - <span class="id" type="var">st</span> <span class="id" type="var">X</span>))).<br/>

<br/>
</div>

<div class="doc">
We'll need the following lemma... 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">not_ev_ev_S_gen</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;(~ <span class="id" type="var">ev</span> <span class="id" type="var">n</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">ev</span> (<span class="id" type="var">S</span> <span class="id" type="var">n</span>)) <span style="font-family: arial;">&and;</span><br/>
&nbsp;&nbsp;(~ <span class="id" type="var">ev</span> (<span class="id" type="var">S</span> <span class="id" type="var">n</span>) <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">ev</span> (<span class="id" type="var">S</span> (<span class="id" type="var">S</span> <span class="id" type="var">n</span>))).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">n</span> <span class="id" type="keyword">as</span> [| <span class="id" type="var">n'</span>].<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "n = 0".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "<span style="font-family: arial;">&rarr;</span>".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ex_falso_quodlibet</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">ev_0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "<span style="font-family: arial;">&larr;</span>".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ev_SS</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">ev_0</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "n = S n'".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">IHn'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">Hn</span> <span class="id" type="var">HSn</span>]. <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "<span style="font-family: arial;">&rarr;</span>".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">HSn</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "<span style="font-family: arial;">&larr;</span>".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ev_SS</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Hn</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">contra</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">ev_SS</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">contra</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">not_ev_ev_S</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;~ <span class="id" type="var">ev</span> <span class="id" type="var">n</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">ev</span> (<span class="id" type="var">S</span> <span class="id" type="var">n</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">n</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">not_ev_ev_S_gen</span> <span class="id" type="var">n</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H</span> <span class="id" type="var">_</span>].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">find_parity_correct</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">x</span>}} <br/>
&nbsp;&nbsp;<span class="id" type="var">find_parity</span><br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">Y</span> = 0 <span style="font-family: arial;">&harr;</span> <span class="id" type="var">ev</span> <span class="id" type="var">x</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">find_parity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_seq</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Q</span> := <span class="id" type="var">find_parity_invariant</span> <span class="id" type="var">x</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_while</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">P</span> := <span class="id" type="var">find_parity_invariant</span> <span class="id" type="var">x</span>).<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Loop body preserves invariant".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_seq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_asgn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_asgn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [[<span class="id" type="var">Inv1</span> <span class="id" type="var">Inv2</span>] <span class="id" type="var">GuardTrue</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">find_parity_invariant</span>, <span class="id" type="var">bassn</span>, <span class="id" type="var">assn_sub</span>, <span class="id" type="var">aeval</span> <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">update_eq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">update_neq</span> <span class="id" type="var">Y</span> <span class="id" type="var">X</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">update_neq</span> <span class="id" type="var">X</span> <span class="id" type="var">Y</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">update_eq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">GuardTrue</span>. <span class="id" type="tactic">destruct</span> (<span class="id" type="var">st</span> <span class="id" type="var">X</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">GuardTrue</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Inv2</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>] | [<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id" type="var">right</span>|<span class="id" type="var">left</span>]; (<span class="id" type="tactic">split</span>; <span class="id" type="tactic">simpl</span>; [<span class="id" type="tactic">omega</span> |]).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ev_not_ev_S</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">S</span> (<span class="id" type="var">x</span> - <span class="id" type="var">S</span> <span class="id" type="var">n</span>)) <span class="id" type="keyword">with</span> (<span class="id" type="var">x</span>-<span class="id" type="var">n</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span> <span class="id" type="tactic">by</span> <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">minus_n_O</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">not_ev_ev_S</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">S</span> (<span class="id" type="var">x</span> - <span class="id" type="var">S</span> <span class="id" type="var">n</span>)) <span class="id" type="keyword">with</span> (<span class="id" type="var">x</span> - <span class="id" type="var">n</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span> <span class="id" type="tactic">by</span> <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">minus_n_O</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Precondition implies invariant".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Invariant implies postcondition".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span>, <span class="id" type="var">find_parity_invariant</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> [[<span class="id" type="var">Inv1</span> <span class="id" type="var">Inv2</span>] <span class="id" type="var">GuardFalse</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">st</span> <span class="id" type="var">X</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Inv2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> <span class="id" type="var">H1</span>]. <span class="id" type="tactic">replace</span> (<span class="id" type="var">x</span>-0) <span class="id" type="keyword">with</span> <span class="id" type="var">x</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span> <span class="id" type="tactic">by</span> <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H0'</span> <span class="id" type="var">_</span>]. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0'</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H0'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Inv2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> <span class="id" type="var">H1</span>]. <span class="id" type="tactic">replace</span> (<span class="id" type="var">x</span>-0) <span class="id" type="keyword">with</span> <span class="id" type="var">x</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span> <span class="id" type="tactic">by</span> <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ex_falso_quodlibet</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H1</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ex_falso_quodlibet</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">GuardFalse</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "invariant established before loop".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_asgn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span>, <span class="id" type="var">find_parity_invariant</span>, <span class="id" type="var">update</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">st</span> <span class="id" type="var">X</span> - <span class="id" type="var">st</span> <span class="id" type="var">X</span>) <span class="id" type="keyword">with</span> 0 <span class="id" type="tactic">by</span> <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>. <span class="id" type="tactic">split</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ev_0</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab435"></a><h4 class="section">Exercise: 2 stars (wrong_find_parity_invariant)</h4>
 A plausible first attempt at stating an invariant for <span class="inlinecode"><span class="id" type="var">find_parity</span></span>
    is the following. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">find_parity_invariant'</span> <span class="id" type="var">x</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">st</span> <span class="id" type="var">Y</span>) = 0 <span style="font-family: arial;">&harr;</span> <span class="id" type="var">ev</span> (<span class="id" type="var">x</span> - <span class="id" type="var">st</span> <span class="id" type="var">X</span>).<br/>

<br/>
</div>

<div class="doc">
Why doesn't this work?  (Hint: Don't waste time trying to answer
    this exercise by attempting a formal proof and seeing where it
    goes wrong.  Just think about whether the loop body actually
    preserves the property.) 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab436"></a><h2 class="section">Example: Finding Square Roots</h2>

<div class="paragraph"> </div>

 Here's another example, starting with the formal version this
    time. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">sqrt_loop</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <span class="id" type="var">BLe</span> (<span class="id" type="var">AMult</span> (<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 1) (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 1) (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>))) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 1) (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">sqrt_com</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">Z</span> ::= <span class="id" type="var">ANum</span> 0;<br/>
&nbsp;&nbsp;<span class="id" type="var">sqrt_loop</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">sqrt_spec</span> (<span class="id" type="var">x</span> : <span class="id" type="var">nat</span>) : <span class="id" type="var">Assertion</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">st</span> <span class="id" type="var">Z</span>) * (<span class="id" type="var">st</span> <span class="id" type="var">Z</span>)) &lt;= <span class="id" type="var">x</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> ~ (((<span class="id" type="var">S</span> (<span class="id" type="var">st</span> <span class="id" type="var">Z</span>)) * (<span class="id" type="var">S</span> (<span class="id" type="var">st</span> <span class="id" type="var">Z</span>))) &lt;= <span class="id" type="var">x</span>).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">sqrt_inv</span> (<span class="id" type="var">x</span> : <span class="id" type="var">nat</span>) : <span class="id" type="var">Assertion</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> ((<span class="id" type="var">st</span> <span class="id" type="var">Z</span>) * (<span class="id" type="var">st</span> <span class="id" type="var">Z</span>)) &lt;= <span class="id" type="var">x</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">random_fact_1</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">S</span> (<span class="id" type="var">st</span> <span class="id" type="var">Z</span>)) * (<span class="id" type="var">S</span> (<span class="id" type="var">st</span> <span class="id" type="var">Z</span>)) &lt;= <span class="id" type="var">st</span> <span class="id" type="var">X</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">bassn</span> (<span class="id" type="var">BLe</span> (<span class="id" type="var">AMult</span> (<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 1) (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 1) (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>))) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">AId</span> <span class="id" type="var">X</span>)) <span class="id" type="var">st</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">Hle</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">st</span> <span class="id" type="var">X</span>) <span class="id" type="keyword">as</span> [|<span class="id" type="var">x'</span>].<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "st X = 0".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hle</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "st X = S x'".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hle</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">le_S_n</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hle</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">ble_nat</span> (<span class="id" type="var">plus</span> (<span class="id" type="var">st</span> <span class="id" type="var">Z</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">st</span> <span class="id" type="var">Z</span>) * (<span class="id" type="var">S</span> (<span class="id" type="var">st</span> <span class="id" type="var">Z</span>)))) <span class="id" type="var">x'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">as</span> <span class="id" type="var">ble</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">ble</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">symmetry</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqble</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">ble_nat_false</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqble</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">not</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqble</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Heqble</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hle</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hle</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">random_fact_2</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">bassn</span> (<span class="id" type="var">BLe</span> (<span class="id" type="var">AMult</span> (<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 1) (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 1) (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>))) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">AId</span> <span class="id" type="var">X</span>)) <span class="id" type="var">st</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> (<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 1) (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id" type="var">aeval</span> <span class="id" type="var">st</span> (<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 1) (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;= <span class="id" type="var">st</span> <span class="id" type="var">X</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">Hble</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hble</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">st</span> <span class="id" type="var">X</span>) <span class="id" type="keyword">as</span> [| <span class="id" type="var">x'</span>].<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "st X = 0".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hble</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "st X = S x'".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ble_nat_true</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hble</span>. <span class="id" type="tactic">omega</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">sqrt_com_correct</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">True</span>}} (<span class="id" type="var">X</span> ::= <span class="id" type="var">ANum</span> <span class="id" type="var">x</span>; <span class="id" type="var">sqrt_com</span>) {{<span class="id" type="var">sqrt_spec</span> <span class="id" type="var">x</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_seq</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Q</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">x</span>).<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "sqrt_com".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">sqrt_com</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_seq</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Q</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">x</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <span class="id" type="var">st</span> <span class="id" type="var">Z</span> = 0).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "sqrt_loop".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">sqrt_loop</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_while</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">P</span> := <span class="id" type="var">sqrt_inv</span> <span class="id" type="var">x</span>).<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "loop preserves invariant".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_asgn</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">sqrt_inv</span> <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">HX</span> <span class="id" type="var">HZ</span>] <span class="id" type="var">HP</span>]. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSSCase</span> "X is preserved".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">update_neq</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">assumption</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSSCase</span> "Z is updated correctly".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">update_eq</span> (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> (<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 1) (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>))) <span class="id" type="var">Z</span> <span class="id" type="var">st</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">random_fact_2</span>. <span class="id" type="tactic">assumption</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "invariant is true initially".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">HX</span> <span class="id" type="var">HZ</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">sqrt_inv</span>. <span class="id" type="tactic">split</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">HZ</span>. <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">omega</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "after loop, spec is satisfied".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">sqrt_spec</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">HX</span> <span class="id" type="var">HP</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">sqrt_inv</span> <span class="id" type="keyword">in</span> <span class="id" type="var">HX</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">HX</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">HX'</span> <span class="id" type="var">Harith</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">contra</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">HP</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">HP</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">contra</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">random_fact_1</span>. <span class="id" type="tactic">subst</span> <span class="id" type="var">x</span>. <span class="id" type="tactic">assumption</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "Z set to 0".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_asgn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">HX</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span>. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">update_neq</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">update_eq</span>. <span class="id" type="tactic">reflexivity</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "assignment of X".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_asgn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">update_eq</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab437"></a><h4 class="section">Exercise: 3 stars (sqrt_informal)</h4>
 Write an informal decorated program corresponding to this formal
    correctness proof. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab438"></a><h2 class="section">Exercise: Factorial</h2>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">Factorial</span>.<br/>

<br/>
</div>

<div class="doc">
Recall the mathematical factorial function... 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">real_fact</span> (<span class="id" type="var">n</span>:<span class="id" type="var">nat</span>) : <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">n</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">O</span> =&gt; 1<br/>
&nbsp;&nbsp;| <span class="id" type="var">S</span> <span class="id" type="var">n'</span> =&gt; <span class="id" type="var">n</span> * (<span class="id" type="var">real_fact</span> <span class="id" type="var">n'</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
... and the Imp program that we wrote to calculate factorials: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">fact_body</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">AMult</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>);<br/>
&nbsp;&nbsp;<span class="id" type="var">Z</span> ::= <span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>) (<span class="id" type="var">ANum</span> 1).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">fact_loop</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>) (<span class="id" type="var">ANum</span> 0)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">fact_body</span><br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">fact_com</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">Z</span> ::= (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>);<br/>
&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">ANum</span> 1;<br/>
&nbsp;&nbsp;<span class="id" type="var">fact_loop</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab439"></a><h4 class="section">Exercise: 3 stars, optional (fact_informal)</h4>
 Decorate the <span class="inlinecode"><span class="id" type="var">fact_com</span></span> program to show that it satisfies the
    specification given by the pre and postconditions below.  As
    usual, feel free to elide the algebraic reasoning about
    arithmetic, the less-than relation, etc., that is formally
    required by the rule of consequence:

<div class="paragraph"> </div>

<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;}}<br/>
&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>;<br/>
&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;1;<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">Z</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;*&nbsp;<span class="id" type="var">Z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;1<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">real_fact</span>&nbsp;<span class="id" type="var">x</span>&nbsp;}}
<div class="paragraph"> </div>

</div>
 <font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab440"></a><h4 class="section">Exercise: 4 stars, optional (fact_formal)</h4>
 Prove formally that fact_com satisfies this specification,
    using your informal proof as a guide.  You may want to state
    the loop invariant separately (as we did in the examples). 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">fact_com_correct</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span>,<br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">x</span>}} <span class="id" type="var">fact_com</span><br/>
&nbsp;&nbsp;{{<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">Y</span> = <span class="id" type="var">real_fact</span> <span class="id" type="var">x</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">Factorial</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab441"></a><h1 class="section">Formalizing Decorated Programs (Optional)</h1>

<div class="paragraph"> </div>

 The informal conventions for decorated programs amount to a way of
    displaying Hoare triples in which commands are annotated with
    enough embedded assertions that checking the validity of the
    triple is reduced to simple logical and algebraic calculations
    showing that some assertions imply others.

<div class="paragraph"> </div>

    In this optional section, we show that this informal presentation
    style can actually be made completely formal.  
<div class="paragraph"> </div>

<a name="lab442"></a><h2 class="section">Syntax</h2>

<div class="paragraph"> </div>

 The first thing we need to do is to formalize a variant of the
    syntax of commands with embedded assertions.  We call the new
    commands <i>decorated commands</i>, or <span class="inlinecode"><span class="id" type="var">dcom</span></span>s. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">dcom</span> : <span class="id" type="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">DCSkip</span> :  <span class="id" type="var">Assertion</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">dcom</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCSeq</span> : <span class="id" type="var">dcom</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">dcom</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">dcom</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCAsgn</span> : <span class="id" type="var">id</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span>  <span class="id" type="var">Assertion</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">dcom</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCIf</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span>  <span class="id" type="var">Assertion</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">dcom</span> <span style="font-family: arial;">&rarr;</span>  <span class="id" type="var">Assertion</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">dcom</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Assertion</span><span style="font-family: arial;">&rarr;</span> <span class="id" type="var">dcom</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCWhile</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Assertion</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">dcom</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Assertion</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">dcom</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCPre</span> : <span class="id" type="var">Assertion</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">dcom</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">dcom</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCPost</span> : <span class="id" type="var">dcom</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Assertion</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">dcom</span>.<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "dcom_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "Skip" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "Seq" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "Asgn"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "If" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "While"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "Pre" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "Post" ].<br/>

<br/>
<span class="id" type="keyword">Notation</span> "'SKIP' {{ P }}" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= (<span class="id" type="var">DCSkip</span> <span class="id" type="var">P</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 10) : <span class="id" type="var">dcom_scope</span>.<br/>
<span class="id" type="keyword">Notation</span> "l '::=' a {{ P }}" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= (<span class="id" type="var">DCAsgn</span> <span class="id" type="var">l</span> <span class="id" type="var">a</span> <span class="id" type="var">P</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 60, <span class="id" type="var">a</span> <span class="id" type="tactic">at</span> <span class="id" type="var">next</span> <span class="id" type="var">level</span>) : <span class="id" type="var">dcom_scope</span>.<br/>
<span class="id" type="keyword">Notation</span> "'WHILE' b 'DO' {{ Pbody }} d 'END' {{ Ppost }}" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= (<span class="id" type="var">DCWhile</span> <span class="id" type="var">b</span> <span class="id" type="var">Pbody</span> <span class="id" type="var">d</span> <span class="id" type="var">Ppost</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>) : <span class="id" type="var">dcom_scope</span>.<br/>
<span class="id" type="keyword">Notation</span> "'IFB' b 'THEN' {{ P }} d 'ELSE' {{ P' }} d' 'FI' {{ Q }}" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= (<span class="id" type="var">DCIf</span> <span class="id" type="var">b</span> <span class="id" type="var">P</span> <span class="id" type="var">d</span> <span class="id" type="var">P'</span> <span class="id" type="var">d'</span> <span class="id" type="var">Q</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>)  : <span class="id" type="var">dcom_scope</span>.<br/>
<span class="id" type="keyword">Notation</span> "'=&gt;' {{ P }} d" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= (<span class="id" type="var">DCPre</span> <span class="id" type="var">P</span> <span class="id" type="var">d</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 90, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>)  : <span class="id" type="var">dcom_scope</span>.<br/>
<span class="id" type="keyword">Notation</span> "{{ P }} d" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= (<span class="id" type="var">DCPre</span> <span class="id" type="var">P</span> <span class="id" type="var">d</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 90)  : <span class="id" type="var">dcom_scope</span>.<br/>
<span class="id" type="keyword">Notation</span> "d '=&gt;' {{ P }}" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= (<span class="id" type="var">DCPost</span> <span class="id" type="var">d</span> <span class="id" type="var">P</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 91, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>)  : <span class="id" type="var">dcom_scope</span>.<br/>
<span class="id" type="keyword">Notation</span> " d ; d' " <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= (<span class="id" type="var">DCSeq</span> <span class="id" type="var">d</span> <span class="id" type="var">d'</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>)  : <span class="id" type="var">dcom_scope</span>.<br/>

<br/>
<span class="id" type="keyword">Delimit</span> <span class="id" type="keyword">Scope</span> <span class="id" type="var">dcom_scope</span> <span class="id" type="keyword">with</span> <span class="id" type="var">dcom</span>.<br/>

<br/>
</div>

<div class="doc">
To avoid clashing with the existing <span class="inlinecode"><span class="id" type="keyword">Notation</span></span> definitions
    for ordinary <span class="inlinecode"><span class="id" type="var">com</span></span>mands, we introduce these notations in a special
    scope called <span class="inlinecode"><span class="id" type="var">dcom_scope</span></span>, and we wrap examples with the
    declaration <span class="inlinecode">%</span> <span class="inlinecode"><span class="id" type="var">dcom</span></span> to signal that we want the notations to be
    interpreted in this scope.  

<div class="paragraph"> </div>

    Careful readers will note that we've defined two notations for the
    <span class="inlinecode"><span class="id" type="var">DCPre</span></span> constructor, one with and one without a <span class="inlinecode">=&gt;</span>.  The
    "without" version is intended to be used to supply the initial
    precondition at the very top of the program. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">dec_while</span> : <span class="id" type="var">dcom</span> := (<br/>
&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">True</span> }}<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> (<span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0))) <br/>
&nbsp;&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">True</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">bassn</span> (<span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0))) <span class="id" type="var">st</span>}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= (<span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span> }}<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">True</span> <span style="font-family: arial;">&and;</span> ~<span class="id" type="var">bassn</span> (<span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0))) <span class="id" type="var">st</span>}} =&gt;<br/>
&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = 0 }}<br/>
) % <span class="id" type="var">dcom</span>.<br/>

<br/>
</div>

<div class="doc">
It is easy to go from a <span class="inlinecode"><span class="id" type="var">dcom</span></span> to a <span class="inlinecode"><span class="id" type="var">com</span></span> by erasing all
    annotations. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">extract</span> (<span class="id" type="var">d</span>:<span class="id" type="var">dcom</span>) : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">d</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCSkip</span> <span class="id" type="var">_</span>           =&gt; <span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCSeq</span> <span class="id" type="var">d1</span> <span class="id" type="var">d2</span>        =&gt; (<span class="id" type="var">extract</span> <span class="id" type="var">d1</span> ; <span class="id" type="var">extract</span> <span class="id" type="var">d2</span>) <br/>
&nbsp;&nbsp;| <span class="id" type="var">DCAsgn</span> <span class="id" type="var">X</span> <span class="id" type="var">a</span> <span class="id" type="var">_</span>       =&gt; <span class="id" type="var">X</span> ::= <span class="id" type="var">a</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCIf</span> <span class="id" type="var">b</span> <span class="id" type="var">_</span> <span class="id" type="var">d1</span> <span class="id" type="var">_</span> <span class="id" type="var">d2</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">IFB</span> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> <span class="id" type="var">extract</span> <span class="id" type="var">d1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">extract</span> <span class="id" type="var">d2</span> <span class="id" type="var">FI</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCWhile</span> <span class="id" type="var">b</span> <span class="id" type="var">_</span> <span class="id" type="var">d</span> <span class="id" type="var">_</span>    =&gt; <span class="id" type="var">WHILE</span> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <span class="id" type="var">extract</span> <span class="id" type="var">d</span> <span class="id" type="var">END</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCPre</span> <span class="id" type="var">_</span> <span class="id" type="var">d</span>          =&gt; <span class="id" type="var">extract</span> <span class="id" type="var">d</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCPost</span> <span class="id" type="var">d</span> <span class="id" type="var">_</span>         =&gt; <span class="id" type="var">extract</span> <span class="id" type="var">d</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
The choice of exactly where to put assertions in the definition of
    <span class="inlinecode"><span class="id" type="var">dcom</span></span> is a bit subtle.  The simplest thing to do would be to
    annotate every <span class="inlinecode"><span class="id" type="var">dcom</span></span> with a precondition and postcondition.  But
    this would result in very verbose programs with a lot of repeated
    annotations: for example, a program like <span class="inlinecode"><span class="id" type="var">SKIP</span>;<span class="id" type="var">SKIP</span></span> would have to
    be annotated as

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{<span class="id" type="var">P</span>}}&nbsp;({{<span class="id" type="var">P</span>}}&nbsp;<span class="id" type="var">SKIP</span>&nbsp;{{<span class="id" type="var">P</span>}})&nbsp;;&nbsp;({{<span class="id" type="var">P</span>}}&nbsp;<span class="id" type="var">SKIP</span>&nbsp;{{<span class="id" type="var">P</span>}})&nbsp;{{<span class="id" type="var">P</span>}},
<div class="paragraph"> </div>

</div>
    with pre- and post-conditions on each <span class="inlinecode"><span class="id" type="var">SKIP</span></span>, plus identical pre-
    and post-conditions on the semicolon!  

<div class="paragraph"> </div>

    Instead, the rule we've followed is this:

<div class="paragraph"> </div>

<ul class="doclist">
<li> The <i>post</i>-condition expected by each <span class="inlinecode"><span class="id" type="var">dcom</span></span> <span class="inlinecode"><span class="id" type="var">d</span></span> is embedded in <span class="inlinecode"><span class="id" type="var">d</span></span>

<div class="paragraph"> </div>


</li>
<li> The <i>pre</i>-condition is supplied by the context. 
</li>
</ul>

<div class="paragraph"> </div>

 In other words, the invariant of the representation is that a
    <span class="inlinecode"><span class="id" type="var">dcom</span></span> <span class="inlinecode"><span class="id" type="var">d</span></span> together with a precondition <span class="inlinecode"><span class="id" type="var">P</span></span> determines a Hoare
    triple <span class="inlinecode">{{<span class="id" type="var">P</span>}}</span> <span class="inlinecode">(<span class="id" type="var">extract</span></span> <span class="inlinecode"><span class="id" type="var">d</span>)</span> <span class="inlinecode">{{<span class="id" type="var">post</span></span> <span class="inlinecode"><span class="id" type="var">d</span>}}</span>, where <span class="inlinecode"><span class="id" type="var">post</span></span> is defined as
    follows: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">post</span> (<span class="id" type="var">d</span>:<span class="id" type="var">dcom</span>) : <span class="id" type="var">Assertion</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">d</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCSkip</span> <span class="id" type="var">P</span>                =&gt; <span class="id" type="var">P</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCSeq</span> <span class="id" type="var">d1</span> <span class="id" type="var">d2</span>             =&gt; <span class="id" type="var">post</span> <span class="id" type="var">d2</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCAsgn</span> <span class="id" type="var">X</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span>            =&gt; <span class="id" type="var">Q</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCIf</span>  <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">d1</span> <span class="id" type="var">_</span> <span class="id" type="var">d2</span> <span class="id" type="var">Q</span>     =&gt; <span class="id" type="var">Q</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCWhile</span> <span class="id" type="var">b</span> <span class="id" type="var">Pbody</span> <span class="id" type="var">c</span> <span class="id" type="var">Ppost</span> =&gt; <span class="id" type="var">Ppost</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCPre</span> <span class="id" type="var">_</span> <span class="id" type="var">d</span>               =&gt; <span class="id" type="var">post</span> <span class="id" type="var">d</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCPost</span> <span class="id" type="var">c</span> <span class="id" type="var">Q</span>              =&gt; <span class="id" type="var">Q</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
We can define a similar function that extracts the "initial
    precondition" from a decorated program. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">pre</span> (<span class="id" type="var">d</span>:<span class="id" type="var">dcom</span>) : <span class="id" type="var">Assertion</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">d</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCSkip</span> <span class="id" type="var">P</span>                =&gt; <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCSeq</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>             =&gt; <span class="id" type="var">pre</span> <span class="id" type="var">c1</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCAsgn</span> <span class="id" type="var">X</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span>            =&gt; <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCIf</span>  <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">t</span> <span class="id" type="var">_</span> <span class="id" type="var">e</span> <span class="id" type="var">_</span>       =&gt; <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCWhile</span> <span class="id" type="var">b</span> <span class="id" type="var">Pbody</span> <span class="id" type="var">c</span> <span class="id" type="var">Ppost</span> =&gt; <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCPre</span> <span class="id" type="var">P</span> <span class="id" type="var">c</span>               =&gt; <span class="id" type="var">P</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCPost</span> <span class="id" type="var">c</span> <span class="id" type="var">Q</span>              =&gt; <span class="id" type="var">pre</span> <span class="id" type="var">c</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
This function is not doing anything sophisticated like calculating
    a weakest precondition; it just recursively searches for an
    explicit annotation at the very beginning of the program,
    returning default answers for programs that lack an explicit
    precondition (like a bare assignment or <span class="inlinecode"><span class="id" type="var">SKIP</span></span>).  

<div class="paragraph"> </div>

    Using <span class="inlinecode"><span class="id" type="var">pre</span></span> and <span class="inlinecode"><span class="id" type="var">post</span></span>, and assuming that we adopt the convention
    of always supplying an explicit precondition annotation at the
    very beginning of our decorated programs, we can express what it
    means for a decorated program to be correct as follows: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">dec_correct</span> (<span class="id" type="var">d</span>:<span class="id" type="var">dcom</span>) := <br/>
&nbsp;&nbsp;{{<span class="id" type="var">pre</span> <span class="id" type="var">d</span>}} (<span class="id" type="var">extract</span> <span class="id" type="var">d</span>) {{<span class="id" type="var">post</span> <span class="id" type="var">d</span>}}.<br/>

<br/>
</div>

<div class="doc">
To check whether this Hoare triple is <i>valid</i>, we need a way to
    extract the "proof obligations" from a decorated program.  These
    obligations are often called <i>verification conditions</i>, because
    they are the facts that must be verified to see that the
    decorations are logically consistent and thus add up to a complete
    proof of correctness. 
<div class="paragraph"> </div>

<a name="lab443"></a><h2 class="section">Extracting Verification Conditions</h2>

<div class="paragraph"> </div>

 The function <span class="inlinecode"><span class="id" type="var">verification_conditions</span></span> takes a <span class="inlinecode"><span class="id" type="var">dcom</span></span> <span class="inlinecode"><span class="id" type="var">d</span></span> together
    with a precondition <span class="inlinecode"><span class="id" type="var">P</span></span> and returns a <i>proposition</i> that, if it
    can be proved, implies that the triple <span class="inlinecode">{{<span class="id" type="var">P</span>}}</span> <span class="inlinecode">(<span class="id" type="var">extract</span></span> <span class="inlinecode"><span class="id" type="var">d</span>)</span> <span class="inlinecode">{{<span class="id" type="var">post</span></span> <span class="inlinecode"><span class="id" type="var">d</span>}}</span>
    is valid.  It does this by walking over <span class="inlinecode"><span class="id" type="var">d</span></span> and generating a big
    conjunction including all the "local checks" that we listed when
    we described the informal rules for decorated programs.
    (Strictly speaking, we need to massage the informal rules a little
    bit to add some uses of the rule of consequence, but the
    correspondence should be clear.) 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">verification_conditions</span> (<span class="id" type="var">P</span> : <span class="id" type="var">Assertion</span>) (<span class="id" type="var">d</span>:<span class="id" type="var">dcom</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">d</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCSkip</span> <span class="id" type="var">Q</span>          =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">P</span> <span style="font-family: arial;">&#8669;</span> <span class="id" type="var">Q</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">DCSeq</span> <span class="id" type="var">d1</span> <span class="id" type="var">d2</span>      =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">verification_conditions</span> <span class="id" type="var">P</span> <span class="id" type="var">d1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <span class="id" type="var">verification_conditions</span> (<span class="id" type="var">post</span> <span class="id" type="var">d1</span>) <span class="id" type="var">d2</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCAsgn</span> <span class="id" type="var">X</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span>      =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">P</span> <span style="font-family: arial;">&#8669;</span> <span class="id" type="var">assn_sub</span> <span class="id" type="var">X</span> <span class="id" type="var">a</span> <span class="id" type="var">Q</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">DCIf</span> <span class="id" type="var">b</span> <span class="id" type="var">P1</span> <span class="id" type="var">d1</span> <span class="id" type="var">P2</span> <span class="id" type="var">d2</span> <span class="id" type="var">Q</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">bassn</span> <span class="id" type="var">b</span> <span class="id" type="var">st</span>) <span style="font-family: arial;">&#8669;</span> <span class="id" type="var">P1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> ((<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">P</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> ~ (<span class="id" type="var">bassn</span> <span class="id" type="var">b</span> <span class="id" type="var">st</span>)) <span style="font-family: arial;">&#8669;</span> <span class="id" type="var">P2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span class="id" type="var">Q</span> = <span class="id" type="var">post</span> <span class="id" type="var">d1</span>) <span style="font-family: arial;">&and;</span> (<span class="id" type="var">Q</span> = <span class="id" type="var">post</span> <span class="id" type="var">d2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <span class="id" type="var">verification_conditions</span> <span class="id" type="var">P1</span> <span class="id" type="var">d1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <span class="id" type="var">verification_conditions</span> <span class="id" type="var">P2</span> <span class="id" type="var">d2</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCWhile</span> <span class="id" type="var">b</span> <span class="id" type="var">Pbody</span> <span class="id" type="var">d</span> <span class="id" type="var">Ppost</span>      =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;post&nbsp;d&nbsp;is&nbsp;the&nbsp;loop&nbsp;invariant&nbsp;and&nbsp;the&nbsp;initial&nbsp;precondition&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">P</span> <span style="font-family: arial;">&#8669;</span> <span class="id" type="var">post</span> <span class="id" type="var">d</span>)  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span class="id" type="var">Pbody</span> = (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">post</span> <span class="id" type="var">d</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">bassn</span> <span class="id" type="var">b</span> <span class="id" type="var">st</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> (<span class="id" type="var">Ppost</span> = (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">post</span> <span class="id" type="var">d</span> <span class="id" type="var">st</span> <span style="font-family: arial;">&and;</span> ~(<span class="id" type="var">bassn</span> <span class="id" type="var">b</span> <span class="id" type="var">st</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <span class="id" type="var">verification_conditions</span> <span class="id" type="var">Pbody</span> <span class="id" type="var">d</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCPre</span> <span class="id" type="var">P'</span> <span class="id" type="var">d</span>         =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">P</span> <span style="font-family: arial;">&#8669;</span> <span class="id" type="var">P'</span>) <span style="font-family: arial;">&and;</span> <span class="id" type="var">verification_conditions</span> <span class="id" type="var">P'</span> <span class="id" type="var">d</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">DCPost</span> <span class="id" type="var">d</span> <span class="id" type="var">Q</span>        =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">verification_conditions</span> <span class="id" type="var">P</span> <span class="id" type="var">d</span> <span style="font-family: arial;">&and;</span> (<span class="id" type="var">post</span> <span class="id" type="var">d</span> <span style="font-family: arial;">&#8669;</span> <span class="id" type="var">Q</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
And now, the key theorem, which captures the claim that the
    <span class="inlinecode"><span class="id" type="var">verification_conditions</span></span> function does its job correctly.  Not
    surprisingly, we need all of the Hoare Logic rules in the
    proof.  We have used <i>in</i> variants of several tactics before to
    apply them to values in the context rather than the goal. An
    extension of this idea is the syntax <span class="inlinecode"><span class="id" type="var">tactic</span></span> <span class="inlinecode"><span class="id" type="keyword">in</span></span> <span class="inlinecode">*</span>, which applies
    <span class="inlinecode"><span class="id" type="var">tactic</span></span> in the goal and every hypothesis in the context.  We most
    commonly use this facility in conjunction with the <span class="inlinecode"><span class="id" type="tactic">simpl</span></span> tactic,
    as below. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">verification_correct</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">d</span> <span class="id" type="var">P</span>, <br/>
&nbsp;&nbsp;<span class="id" type="var">verification_conditions</span> <span class="id" type="var">P</span> <span class="id" type="var">d</span> <span style="font-family: arial;">&rarr;</span> {{<span class="id" type="var">P</span>}} (<span class="id" type="var">extract</span> <span class="id" type="var">d</span>) {{<span class="id" type="var">post</span> <span class="id" type="var">d</span>}}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">dcom_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">d</span>) <span class="id" type="var">Case</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Skip".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_skip</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Seq".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]. <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_seq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHd2</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHd1</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H1</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Asgn".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_asgn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "If".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">HPre1</span> [<span class="id" type="var">HPre2</span> [<span class="id" type="var">Hd1</span> [<span class="id" type="var">Hd2</span> [<span class="id" type="var">HThen</span> <span class="id" type="var">HElse</span>]]]]]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_if</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">IHd1</span>. <span class="id" type="var">eassumption</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hd2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">IHd2</span>. <span class="id" type="var">eassumption</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "While".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">Hpre</span> [<span class="id" type="var">Hbody</span> [<span class="id" type="var">Hpost</span> <span class="id" type="var">Hd</span>]]]; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">hoare_while</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">P</span> := <span class="id" type="var">post</span> <span class="id" type="var">d</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHd</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Hd</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Pre".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">HP</span> <span class="id" type="var">Hd</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_pre</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">IHd</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Hd</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "Post".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">Hd</span> <span class="id" type="var">HQ</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">hoare_consequence_post</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">IHd</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Hd</span>. <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab444"></a><h2 class="section">Examples</h2>

<div class="paragraph"> </div>

 The propositions generated by <span class="inlinecode"><span class="id" type="var">verification_conditions</span></span> are fairly
    big, and they contain many conjuncts that are essentially trivial. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Eval</span> <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> (<span class="id" type="var">verification_conditions</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">True</span>) <span class="id" type="var">dec_while</span>).<br/>
<span class="comment">(*&nbsp;====&gt;<br/>
&nbsp;=&nbsp;(((fun&nbsp;_&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True)&nbsp;~~&gt;&nbsp;(fun&nbsp;_&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True))&nbsp;/\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;((fun&nbsp;_&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True)&nbsp;~~&gt;&nbsp;(fun&nbsp;_&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True))&nbsp;/\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(fun&nbsp;st&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True&nbsp;/\&nbsp;bassn&nbsp;(BNot&nbsp;(BEq&nbsp;(AId&nbsp;X)&nbsp;(ANum&nbsp;0)))&nbsp;st)&nbsp;=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(fun&nbsp;st&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True&nbsp;/\&nbsp;bassn&nbsp;(BNot&nbsp;(BEq&nbsp;(AId&nbsp;X)&nbsp;(ANum&nbsp;0)))&nbsp;st)&nbsp;/\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(fun&nbsp;st&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True&nbsp;/\&nbsp;~&nbsp;bassn&nbsp;(BNot&nbsp;(BEq&nbsp;(AId&nbsp;X)&nbsp;(ANum&nbsp;0)))&nbsp;st)&nbsp;=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(fun&nbsp;st&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True&nbsp;/\&nbsp;~&nbsp;bassn&nbsp;(BNot&nbsp;(BEq&nbsp;(AId&nbsp;X)&nbsp;(ANum&nbsp;0)))&nbsp;st)&nbsp;/\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(fun&nbsp;st&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True&nbsp;/\&nbsp;bassn&nbsp;(BNot&nbsp;(BEq&nbsp;(AId&nbsp;X)&nbsp;(ANum&nbsp;0)))&nbsp;st)&nbsp;~~&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;assn_sub&nbsp;X&nbsp;(AMinus&nbsp;(AId&nbsp;X)&nbsp;(ANum&nbsp;1))&nbsp;(fun&nbsp;_&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True))&nbsp;/\<br/>
&nbsp;&nbsp;&nbsp;(fun&nbsp;st&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True&nbsp;/\&nbsp;~&nbsp;bassn&nbsp;(BNot&nbsp;(BEq&nbsp;(AId&nbsp;X)&nbsp;(ANum&nbsp;0)))&nbsp;st)&nbsp;~~&gt;<br/>
&nbsp;&nbsp;&nbsp;(fun&nbsp;st&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;st&nbsp;X&nbsp;=&nbsp;0)&nbsp;*)</span><br/>

<br/>
</div>

<div class="doc">
We can certainly work with them using just the tactics we have so
    far, but we can make things much smoother with a bit of
    automation.  We first define a custom <span class="inlinecode"><span class="id" type="var">verify</span></span> tactic that applies
    splitting repeatedly to turn all the conjunctions into separate
    subgoals and then uses <span class="inlinecode"><span class="id" type="tactic">omega</span></span> and <span class="inlinecode"><span class="id" type="tactic">eauto</span></span> (a handy
    general-purpose automation tactic that we'll discuss in detail
    later) to deal with as many of them as possible. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Tactic Notation</span> "verify" :=<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">verification_correct</span>; <br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">assert_implies</span>; <br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bassn</span> <span class="id" type="keyword">in</span> *; <span class="id" type="tactic">unfold</span> <span class="id" type="var">beval</span> <span class="id" type="keyword">in</span> *; <span class="id" type="tactic">unfold</span> <span class="id" type="var">aeval</span> <span class="id" type="keyword">in</span> *;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assn_sub</span>; <span class="id" type="tactic">intros</span>;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">update_eq</span>;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> (<span class="id" type="tactic">rewrite</span> <span class="id" type="var">update_neq</span>; [| <span class="id" type="tactic">reflexivity</span>]);<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *; <br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> <span class="id" type="keyword">match</span> <span class="id" type="var">goal</span> <span class="id" type="keyword">with</span> [<span class="id" type="var">H</span> : <span class="id" type="var">_</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">_</span> <span style="font-family: arial;">&#8866;</span> <span class="id" type="var">_</span>] =&gt; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span> <span class="id" type="keyword">end</span>;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">not_true_iff_false</span> <span class="id" type="keyword">in</span> *;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">not_false_iff_true</span> <span class="id" type="keyword">in</span> *;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">negb_true_iff</span> <span class="id" type="keyword">in</span> *;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">negb_false_iff</span> <span class="id" type="keyword">in</span> *;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">beq_nat_true_iff</span> <span class="id" type="keyword">in</span> *;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">beq_nat_false_iff</span> <span class="id" type="keyword">in</span> *;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">eauto</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">omega</span>.<br/>

<br/>
</div>

<div class="doc">
What's left after <span class="inlinecode"><span class="id" type="var">verify</span></span> does its thing is "just the interesting
    parts" of checking that the decorations are correct. For very
    simple examples <span class="inlinecode"><span class="id" type="var">verify</span></span> immediately solves the goal (provided
    that the annotations are correct). 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">dec_while_correct</span> :<br/>
&nbsp;&nbsp;<span class="id" type="var">dec_correct</span> <span class="id" type="var">dec_while</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="var">verify</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Another example (formalizing a decorated program we've seen
    before): 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">subtract_slowly_dec</span> (<span class="id" type="var">x</span>:<span class="id" type="var">nat</span>) (<span class="id" type="var">z</span>:<span class="id" type="var">nat</span>) : <span class="id" type="var">dcom</span> := (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">x</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">st</span> <span class="id" type="var">Z</span> = <span class="id" type="var">z</span> }}<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0))<br/>
&nbsp;&nbsp;<span class="id" type="var">DO</span>   {{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">Z</span> - <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">z</span> - <span class="id" type="var">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> <span class="id" type="var">bassn</span> (<span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0))) <span class="id" type="var">st</span> }}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span> ::= <span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>) (<span class="id" type="var">ANum</span> 1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">Z</span> - (<span class="id" type="var">st</span> <span class="id" type="var">X</span> - 1) = <span class="id" type="var">z</span> - <span class="id" type="var">x</span> }} ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">Z</span> - <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">z</span> - <span class="id" type="var">x</span> }}<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt;   <span class="id" type="var">st</span> <span class="id" type="var">Z</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id" type="var">st</span> <span class="id" type="var">X</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= <span class="id" type="var">z</span> - <span class="id" type="var">x</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&and;</span> ~ <span class="id" type="var">bassn</span> (<span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0))) <span class="id" type="var">st</span> }}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">Z</span> = <span class="id" type="var">z</span> - <span class="id" type="var">x</span> }}<br/>
) % <span class="id" type="var">dcom</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">subtract_slowly_dec_correct</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">z</span>, <br/>
&nbsp;&nbsp;<span class="id" type="var">dec_correct</span> (<span class="id" type="var">subtract_slowly_dec</span> <span class="id" type="var">x</span> <span class="id" type="var">z</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">z</span>. <span class="id" type="var">verify</span>. <span class="comment">(*&nbsp;this&nbsp;grinds&nbsp;for&nbsp;a&nbsp;bit!&nbsp;*)</span> <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab445"></a><h4 class="section">Exercise: 3 stars, optional (slow_assignment_dec)</h4>

<div class="paragraph"> </div>

 A roundabout way of assigning a number currently stored in <span class="inlinecode"><span class="id" type="var">X</span></span> to
   the variable <span class="inlinecode"><span class="id" type="var">Y</span></span> is to start <span class="inlinecode"><span class="id" type="var">Y</span></span> at <span class="inlinecode">0</span>, then decrement <span class="inlinecode"><span class="id" type="var">X</span></span> until it
   hits <span class="inlinecode">0</span>, incrementing <span class="inlinecode"><span class="id" type="var">Y</span></span> at each step.

<div class="paragraph"> </div>

   Here is an informal decorated program that implements this idea
   given a parameter <span class="inlinecode"><span class="id" type="var">x</span></span>: 
<div class="paragraph"> </div>


<div class="paragraph"> </div>


<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">True</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;0&nbsp;}}&nbsp;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&lt;&gt;&nbsp;0&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;&gt;&nbsp;0&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;-&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;}}&nbsp;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;}}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{&nbsp;<span class="id" type="var">Y</span>&nbsp;=&nbsp;<span class="id" type="var">x</span>&nbsp;<span style="font-family: arial;">&and;</span>&nbsp;<span class="id" type="var">X</span>&nbsp;=&nbsp;0&nbsp;}}
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

 Write a corresponding formal decorated program (parametrized by x)
    and prove it correct. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">slow_assignment_dec</span> (<span class="id" type="var">x</span>:<span class="id" type="var">nat</span>) : <span class="id" type="var">dcom</span> :=<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">admit</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">slow_assignment_dec_correct</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">dec_correct</span> (<span class="id" type="var">slow_assignment_dec</span> <span class="id" type="var">x</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab446"></a><h4 class="section">Exercise: 4 stars, optional (factorial_dec)</h4>
 Remember the factorial function we worked with before: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">real_fact</span> (<span class="id" type="var">n</span>:<span class="id" type="var">nat</span>) : <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">n</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">O</span> =&gt; 1<br/>
&nbsp;&nbsp;| <span class="id" type="var">S</span> <span class="id" type="var">n'</span> =&gt; <span class="id" type="var">n</span> * (<span class="id" type="var">real_fact</span> <span class="id" type="var">n'</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
Following the pattern of <span class="inlinecode"><span class="id" type="var">subtract_slowly_dec</span></span>, write a decorated
    Imp program that implements the factorial function, and prove it
    correct. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">div_mod_dec</span> (<span class="id" type="var">a</span> <span class="id" type="var">b</span> : <span class="id" type="var">nat</span>) : <span class="id" type="var">dcom</span> := (<br/>
{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">True</span> }} =&gt;<br/>
&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">b</span> * 0 + <span class="id" type="var">a</span> = <span class="id" type="var">a</span> }}<br/>
&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">ANum</span> <span class="id" type="var">a</span><br/>
&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">b</span> * 0 + <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">a</span> }};<br/>
&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">ANum</span> 0<br/>
&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">b</span> * <span class="id" type="var">st</span> <span class="id" type="var">Y</span> + <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">a</span> }};<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> (<span class="id" type="var">BLe</span> (<span class="id" type="var">ANum</span> <span class="id" type="var">b</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">b</span> * <span class="id" type="var">st</span> <span class="id" type="var">Y</span> + <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">a</span> <span style="font-family: arial;">&and;</span> (<span class="id" type="var">bassn</span> (<span class="id" type="var">BLe</span> (<span class="id" type="var">ANum</span> <span class="id" type="var">b</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>)) <span class="id" type="var">st</span>) }} =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">b</span> * (<span class="id" type="var">st</span> <span class="id" type="var">Y</span> + 1) + (<span class="id" type="var">st</span> <span class="id" type="var">X</span> - <span class="id" type="var">b</span>) = <span class="id" type="var">a</span> }}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> <span class="id" type="var">b</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">b</span> * (<span class="id" type="var">st</span> <span class="id" type="var">Y</span> + 1) + <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">a</span> }};<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>) (<span class="id" type="var">ANum</span> 1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">b</span> * <span class="id" type="var">st</span> <span class="id" type="var">Y</span> + <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">a</span> }}<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span><br/>
&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">b</span> * <span class="id" type="var">st</span> <span class="id" type="var">Y</span> + <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">a</span> <span style="font-family: arial;">&and;</span> ~(<span class="id" type="var">bassn</span> (<span class="id" type="var">BLe</span> (<span class="id" type="var">ANum</span> <span class="id" type="var">b</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>)) <span class="id" type="var">st</span>) }} =&gt;<br/>
&nbsp;&nbsp;{{ <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">b</span> * <span class="id" type="var">st</span> <span class="id" type="var">Y</span> + <span class="id" type="var">st</span> <span class="id" type="var">X</span> = <span class="id" type="var">a</span> <span style="font-family: arial;">&and;</span> (<span class="id" type="var">st</span> <span class="id" type="var">X</span> &lt; <span class="id" type="var">b</span>) }}<br/>
)%<span class="id" type="var">dcom</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">div_mod_dec_correct</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">a</span> <span class="id" type="var">b</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">dec_correct</span> (<span class="id" type="var">div_mod_dec</span> <span class="id" type="var">a</span> <span class="id" type="var">b</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">a</span> <span class="id" type="var">b</span>. <span class="id" type="var">verify</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "1". <span class="id" type="tactic">apply</span> <span class="id" type="var">ble_nat_true</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">mult_plus_distr_l</span>. <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "2". <span class="id" type="tactic">apply</span> <span class="id" type="var">ble_nat_false</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>. <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;more&nbsp;automation&nbsp;would&nbsp;help&nbsp;&nbsp;here&nbsp;*)</span><br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a><hr/>This page has been generated by <a href="http://www.lix.polytechnique.fr/coq/">coqdoc</a>
</div>

</div>

</body>
</html>