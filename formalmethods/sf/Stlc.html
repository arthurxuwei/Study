<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
<link href="coqdoc.css" rel="stylesheet" type="text/css"/>
<title>Stlc: The Simply Typed Lambda-Calculus</title>
</head>

<script>
<!--
  function toggleDisplay(id)
  {
     var elt = document.getElementById(id);
     if (elt.style.display == 'none') {
       elt.style.display = 'block';
     } else {
       elt.style.display = 'none';
     }
  }
  function hideAll(cls)
  {
    var testClass = new RegExp("(^|s)" + cls + "(s|$)");
    var tag = tag || "*";
    var elements = document.getElementsByTagName("div");
    var current;
    var length = elements.length;
    for(var i=0; i<length; i++){
      current = elements[i];
      if(testClass.test(current.className)) {
        current.style.display = 'none';
      }
    }
  }
// --> 
</script>

<body onLoad="hideAll('proofscript')">
<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Stlc<span class="subtitle">The Simply Typed Lambda-Calculus</span></h1>

<div class="code code-tight">
</div>

<div class="doc">

</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;$Date:&nbsp;2012-07-25&nbsp;16:43:16&nbsp;-0400&nbsp;(Wed,&nbsp;25&nbsp;Jul&nbsp;2012)&nbsp;$&nbsp;*)</span><br/>

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Export</span> <span class="id" type="keyword">Types</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab548"></a><h1 class="section">The Simply Typed Lambda-Calculus</h1>

<div class="paragraph"> </div>

 The simply typed lambda-calculus (STLC) is a tiny core calculus
    embodying the key concept of <i>functional abstraction</i>, which shows
    up in pretty much every real-world programming language in some
    form (functions, procedures, methods, etc.).

<div class="paragraph"> </div>

    We will follow exactly the same pattern as in the previous
    chapter when formalizing this calculus (syntax, small-step
    semantics, typing rules) and its main properties (progress and
    preservation).  The new technical challenges (which will take some
    work to deal with) all arise from the mechanisms of <i>variable
    binding</i> and <i>substitution</i>. 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab549"></a><h2 class="section">Overview</h2>

<div class="paragraph"> </div>

 The STLC is built on some collection of <i>base types</i> &mdash; booleans,
    numbers, strings, etc.  The exact choice of base types doesn't
    matter &mdash; the construction of the language and its theoretical
    properties work out pretty much the same &mdash; so for the sake of
    brevity let's take just <span class="inlinecode"><span class="id" type="var">Bool</span></span> for the moment.  At the end of the
    chapter we'll see how to add more base types, and in later
    chapters we'll enrich the pure STLC with other useful constructs
    like pairs, records, subtyping, and mutable state.

<div class="paragraph"> </div>

    Starting from the booleans, we add three things:

<div class="paragraph"> </div>

<ul class="doclist">
<li> variables

</li>
<li> function abstractions

</li>
<li> application

</li>
</ul>

<div class="paragraph"> </div>

    This gives us the following collection of abstract syntax
    constructors (written out here in informal BNF notation &mdash; we'll
    formalize it below).

<div class="paragraph"> </div>


<div class="paragraph"> </div>

 Informal concrete syntax: 
<pre>
       t ::= x                       variable
           | \x:T.t1                 abstraction
           | t1 t2                   application
           | true                    constant true
           | false                   constant false
           | if t1 then t2 else t3   conditional
</pre>

<div class="paragraph"> </div>

 The <span class="inlinecode">\</span> symbol in a function abstraction <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">T.t1</span></span> is often
    written as a greek "lambda" (hence the name of the calculus).  The
    variable <span class="inlinecode"><span class="id" type="var">x</span></span> is called the <i>parameter</i> to the function; the term
    <span class="inlinecode"><span class="id" type="var">t1</span></span> is its <i>body</i>.  The annotation <span class="inlinecode">:<span class="id" type="var">T</span></span> specifies the type of
    arguments that the function can be applied to.

<div class="paragraph"> </div>

    Some examples:

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span>

<div class="paragraph"> </div>

        The identity function for booleans.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">(\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span>)</span> <span class="inlinecode"><span class="id" type="var">true</span></span>

<div class="paragraph"> </div>

        The identity function for booleans, applied to the boolean <span class="inlinecode"><span class="id" type="var">true</span></span>.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="keyword">if</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="keyword">then</span></span> <span class="inlinecode"><span class="id" type="var">false</span></span> <span class="inlinecode"><span class="id" type="keyword">else</span></span> <span class="inlinecode"><span class="id" type="var">true</span></span>

<div class="paragraph"> </div>

        The boolean "not" function.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">true</span></span>

<div class="paragraph"> </div>

        The constant function that takes every (boolean) argument to
        <span class="inlinecode"><span class="id" type="var">true</span></span>.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span>

<div class="paragraph"> </div>

        A two-argument function that takes two booleans and returns
        the first one.  (Note that, as in Coq, a two-argument function
        is really a one-argument function whose body is also a
        one-argument function.)

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">(\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span>)</span> <span class="inlinecode"><span class="id" type="var">false</span></span> <span class="inlinecode"><span class="id" type="var">true</span></span>

<div class="paragraph"> </div>

        A two-argument function that takes two booleans and returns
        the first one, applied to the booleans <span class="inlinecode"><span class="id" type="var">false</span></span> and <span class="inlinecode"><span class="id" type="var">true</span></span>.
        Note that, as in Coq, application associates to the left &mdash;
        i.e., this expression is parsed as <span class="inlinecode">((\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span>)</span>
        <span class="inlinecode"><span class="id" type="var">false</span>)</span> <span class="inlinecode"><span class="id" type="var">true</span></span>.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">\<span class="id" type="var">f</span>:<span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">f</span></span> <span class="inlinecode">(<span class="id" type="var">f</span></span> <span class="inlinecode"><span class="id" type="var">true</span>)</span>

<div class="paragraph"> </div>

        A higher-order function that takes a <i>function</i> <span class="inlinecode"><span class="id" type="var">f</span></span> (from
        booleans to booleans) as an argument, applies <span class="inlinecode"><span class="id" type="var">f</span></span> to <span class="inlinecode"><span class="id" type="var">true</span></span>,
        and applies <span class="inlinecode"><span class="id" type="var">f</span></span> again to the result.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">(\<span class="id" type="var">f</span>:<span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">f</span></span> <span class="inlinecode">(<span class="id" type="var">f</span></span> <span class="inlinecode"><span class="id" type="var">true</span>))</span> <span class="inlinecode">(\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">false</span>)</span>

<div class="paragraph"> </div>

        The same higher-order function, applied to the constantly
        <span class="inlinecode"><span class="id" type="var">false</span></span> function. 
</li>
</ul>

<div class="paragraph"> </div>

 As the last several examples show, the STLC is a language of
    <i>higher-order</i> functions: we can write down functions that take
    other functions as arguments and/or return other functions as
    results.  

<div class="paragraph"> </div>

    Another point to note is that the STLC doesn't provide any
    primitive syntax for defining <i>named</i> functions &mdash; all functions
    are "anonymous."  We'll see in chapter <span class="inlinecode"><span class="id" type="var">MoreStlc</span></span> that it is easy
    to add named functions to what we've got &mdash; indeed, the
    fundamental naming and binding mechanisms are exactly the same.  

<div class="paragraph"> </div>

    The <i>types</i> of the STLC include <span class="inlinecode"><span class="id" type="var">Bool</span></span>, which classifies the
    boolean constants <span class="inlinecode"><span class="id" type="var">true</span></span> and <span class="inlinecode"><span class="id" type="var">false</span></span> as well as more complex
    computations that yield booleans, plus <i>arrow types</i> that classify
    functions. 
<div class="paragraph"> </div>

<pre>
      T ::= Bool
          | T1 -&gt; T2
</pre>
    For example:

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">false</span></span> has type <span class="inlinecode"><span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span> has type <span class="inlinecode"><span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">(\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span>)</span> <span class="inlinecode"><span class="id" type="var">true</span></span> has type <span class="inlinecode"><span class="id" type="var">Bool</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span> has type <span class="inlinecode"><span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span></span> (i.e. <span class="inlinecode"><span class="id" type="var">Bool</span></span> <span class="inlinecode"><span style="font-family: arial;">&rarr;</span></span> <span class="inlinecode">(<span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span>)</span>)

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">(\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span>)</span> <span class="inlinecode"><span class="id" type="var">false</span></span> has type <span class="inlinecode"><span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">(\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span>)</span> <span class="inlinecode"><span class="id" type="var">false</span></span> <span class="inlinecode"><span class="id" type="var">true</span></span> has type <span class="inlinecode"><span class="id" type="var">Bool</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">\<span class="id" type="var">f</span>:<span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">f</span></span> <span class="inlinecode">(<span class="id" type="var">f</span></span> <span class="inlinecode"><span class="id" type="var">true</span>)</span> has type <span class="inlinecode">(<span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span>)</span> <span class="inlinecode"><span style="font-family: arial;">&rarr;</span></span> <span class="inlinecode"><span class="id" type="var">Bool</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">(\<span class="id" type="var">f</span>:<span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">f</span></span> <span class="inlinecode">(<span class="id" type="var">f</span></span> <span class="inlinecode"><span class="id" type="var">true</span>))</span> <span class="inlinecode">(\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">false</span>)</span> has type <span class="inlinecode"><span class="id" type="var">Bool</span></span>

</li>
</ul>

</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab550"></a><h2 class="section">Syntax</h2>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">STLC</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab551"></a><h3 class="section">Types</h3>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">ty</span> : <span class="id" type="keyword">Type</span> := <br/>
&nbsp;&nbsp;| <span class="id" type="var">TBool</span>  : <span class="id" type="var">ty</span> <br/>
&nbsp;&nbsp;| <span class="id" type="var">TArrow</span> : <span class="id" type="var">ty</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">ty</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">ty</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab552"></a><h3 class="section">Terms</h3>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">tm</span> : <span class="id" type="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">tvar</span> : <span class="id" type="var">id</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">tapp</span> : <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">tabs</span> : <span class="id" type="var">id</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">ty</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">ttrue</span> : <span class="id" type="var">tm</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">tfalse</span> : <span class="id" type="var">tm</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">tif</span> : <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span>.<br/>

<br/>
<div class="togglescript" id="proofcontrol1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')"><span class="show"></span></div>
<div class="proofscript" id="proof1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')">
<span class="id" type="keyword">Tactic Notation</span> "t_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "tvar" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "tapp" <br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "tabs" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "ttrue" <br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "tfalse" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "tif" ].<br/>
</div>

<br/>
</div>

<div class="doc">
Note that an abstraction <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">T.t</span></span> (formally, <span class="inlinecode"><span class="id" type="var">tabs</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">T</span></span> <span class="inlinecode"><span class="id" type="var">t</span></span>) is
    always annotated with the type <span class="inlinecode"><span class="id" type="var">T</span></span> of its parameter, in contrast
    to Coq (and other functional languages like ML, Haskell, etc.),
    which use <i>type inference</i> to fill in missing annotations.  We're
    not considering type inference here, to keep things simple. 
<div class="paragraph"> </div>

 Some examples... 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">x</span> := (<span class="id" type="var">Id</span> 0).<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">y</span> := (<span class="id" type="var">Id</span> 1).<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">z</span> := (<span class="id" type="var">Id</span> 2).<br/>
<div class="togglescript" id="proofcontrol2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')"><span class="show"></span></div>
<div class="proofscript" id="proof2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')">
<span class="id" type="keyword">Hint</span> <span class="id" type="keyword">Unfold</span> <span class="id" type="var">x</span>.<br/>
<span class="id" type="keyword">Hint</span> <span class="id" type="keyword">Unfold</span> <span class="id" type="var">y</span>.<br/>
<span class="id" type="keyword">Hint</span> <span class="id" type="keyword">Unfold</span> <span class="id" type="var">z</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" type="var">idB</span></span> <span class="inlinecode">=</span> <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span> 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Notation</span> <span class="id" type="var">idB</span> := <br/>
&nbsp;&nbsp;(<span class="id" type="var">tabs</span> <span class="id" type="var">x</span> <span class="id" type="var">TBool</span> (<span class="id" type="var">tvar</span> <span class="id" type="var">x</span>)).<br/>

<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" type="var">idBB</span></span> <span class="inlinecode">=</span> <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span> 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Notation</span> <span class="id" type="var">idBB</span> := <br/>
&nbsp;&nbsp;(<span class="id" type="var">tabs</span> <span class="id" type="var">x</span> (<span class="id" type="var">TArrow</span> <span class="id" type="var">TBool</span> <span class="id" type="var">TBool</span>) (<span class="id" type="var">tvar</span> <span class="id" type="var">x</span>)).<br/>

<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" type="var">idBBBB</span></span> <span class="inlinecode">=</span> <span class="inlinecode">\<span class="id" type="var">x</span>:(<span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span>)-&gt;(<span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span>).</span> <span class="inlinecode"><span class="id" type="var">x</span></span> 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Notation</span> <span class="id" type="var">idBBBB</span> :=<br/>
&nbsp;&nbsp;(<span class="id" type="var">tabs</span> <span class="id" type="var">x</span> (<span class="id" type="var">TArrow</span> (<span class="id" type="var">TArrow</span> <span class="id" type="var">TBool</span> <span class="id" type="var">TBool</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">TArrow</span> <span class="id" type="var">TBool</span> <span class="id" type="var">TBool</span>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tvar</span> <span class="id" type="var">x</span>)).<br/>

<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" type="var">k</span></span> <span class="inlinecode">=</span> <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span> 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Notation</span> <span class="id" type="var">k</span> := (<span class="id" type="var">tabs</span> <span class="id" type="var">x</span> <span class="id" type="var">TBool</span> (<span class="id" type="var">tabs</span> <span class="id" type="var">y</span> <span class="id" type="var">TBool</span> (<span class="id" type="var">tvar</span> <span class="id" type="var">x</span>))).<br/>

<br/>
</div>

<div class="doc">
(We write these as <span class="inlinecode"><span class="id" type="keyword">Notation</span></span>s rather than <span class="inlinecode"><span class="id" type="keyword">Definition</span></span>s to make
    things easier for <span class="inlinecode"><span class="id" type="tactic">auto</span></span>.) 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab553"></a><h2 class="section">Operational Semantics</h2>

<div class="paragraph"> </div>

 To define the small-step semantics of STLC terms, we begin &mdash; as
    always &mdash; by defining the set of values.  Next, we define the
    critical notions of <i>free variables</i> and <i>substitution</i>, which are
    used in the reduction rule for application expressions.  And
    finally we give the small-step relation itself. 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab554"></a><h3 class="section">Values</h3>

<div class="paragraph"> </div>

 To define the values of the STLC, we have a few cases to consider.

<div class="paragraph"> </div>

    First, for the boolean part of the language, the situation is
    clear: <span class="inlinecode"><span class="id" type="var">true</span></span> and <span class="inlinecode"><span class="id" type="var">false</span></span> are the only values.  (An <span class="inlinecode"><span class="id" type="keyword">if</span></span>
    expression is never a value.)

<div class="paragraph"> </div>

    Second, an application is clearly not a value: It represents a
    function being invoked on some argument, which clearly still has
    work left to do.

<div class="paragraph"> </div>

    Third, for abstractions, we have a choice:

<div class="paragraph"> </div>

<ul class="doclist">
<li> We can say that <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">T.t1</span></span> is a value only when <span class="inlinecode"><span class="id" type="var">t1</span></span> is a
        value &mdash; i.e., only if the function's body has been
        reduced (as much as it can be without knowing what argument it
        is going to be applied to).

<div class="paragraph"> </div>


</li>
<li> Or we can say that <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">T.t1</span></span> is always a value, no matter
        whether <span class="inlinecode"><span class="id" type="var">t1</span></span> is one or not &mdash; in other words, we can say that
        reduction stops at abstractions.

</li>
</ul>

<div class="paragraph"> </div>

    Coq (in its built-in functional programming langauge) makes the
    first choice &mdash; for example,

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Eval</span>&nbsp;<span class="id" type="tactic">simpl</span>&nbsp;<span class="id" type="keyword">in</span>&nbsp;(<span class="id" type="keyword">fun</span>&nbsp;<span class="id" type="var">x</span>:<span class="id" type="var">bool</span>&nbsp;=&gt;&nbsp;3&nbsp;+&nbsp;4)
<div class="paragraph"> </div>

</div>
    yields <span class="inlinecode"><span class="id" type="keyword">fun</span></span> <span class="inlinecode"><span class="id" type="var">x</span>:<span class="id" type="var">bool</span></span> <span class="inlinecode">=&gt;</span> <span class="inlinecode">7</span>.  But most real-world functional
    programming languages make the second choice &mdash; reduction of a
    function's body only begins when the function is actually applied
    to an argument.  We also make the second choice here.

<div class="paragraph"> </div>

    Finally, having made the choice not to reduce under abstractions,
    we don't need to worry about whether variables are values, since
    we'll always be reducing programs "from the outside in," and that
    means the <span class="inlinecode"><span class="id" type="var">step</span></span> relation will always be working with closed
    terms (ones with no free variables).  
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">value</span> : <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">v_abs</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">T</span> <span class="id" type="var">t</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">value</span> (<span class="id" type="var">tabs</span> <span class="id" type="var">x</span> <span class="id" type="var">T</span> <span class="id" type="var">t</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">t_true</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">value</span> <span class="id" type="var">ttrue</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">t_false</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">value</span> <span class="id" type="var">tfalse</span>.<br/>

<br/>
<span class="id" type="keyword">Hint</span> <span class="id" type="var">Constructors</span> <span class="id" type="var">value</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab555"></a><h3 class="section">Free Variables and Substitution</h3>

<div class="paragraph"> </div>

 Now we come to the heart of the matter: the operation of
    substituting one term for a variable in another term.

<div class="paragraph"> </div>

    This operation will be used below to define the operational
    semantics of function application, where we will need to
    substitute the argument term for the function parameter in the
    function's body.  For example, we reduce

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>. <span class="id" type="keyword">if</span>&nbsp;<span class="id" type="var">x</span>&nbsp;<span class="id" type="keyword">then</span>&nbsp;<span class="id" type="var">true</span>&nbsp;<span class="id" type="keyword">else</span>&nbsp;<span class="id" type="var">x</span>)&nbsp;<span class="id" type="var">false</span>
<div class="paragraph"> </div>

</div>
    to <span class="inlinecode"><span class="id" type="var">false</span></span> by substituting <span class="inlinecode"><span class="id" type="var">false</span></span> for the parameter <span class="inlinecode"><span class="id" type="var">x</span></span> in the
    body of the function.  In general, we need to be able to
    substitute some given term <span class="inlinecode"><span class="id" type="var">s</span></span> for occurrences of some variable
    <span class="inlinecode"><span class="id" type="var">x</span></span> in another term <span class="inlinecode"><span class="id" type="var">t</span></span>.  In informal discussions, this is usually
    written <span class="inlinecode"></span> <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">s</span>]<span class="id" type="var">t</span></span> <span class="inlinecode"></span> and pronounced "substitute <span class="inlinecode"><span class="id" type="var">x</span></span> with <span class="inlinecode"><span class="id" type="var">s</span></span> in <span class="inlinecode"><span class="id" type="var">t</span></span>."

<div class="paragraph"> </div>

    Here are some examples:

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">true</span>]</span> <span class="inlinecode">(<span class="id" type="keyword">if</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="keyword">then</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="keyword">else</span></span> <span class="inlinecode"><span class="id" type="var">false</span>)</span> yields <span class="inlinecode"><span class="id" type="keyword">if</span></span> <span class="inlinecode"><span class="id" type="var">true</span></span> <span class="inlinecode"><span class="id" type="keyword">then</span></span> <span class="inlinecode"><span class="id" type="var">true</span></span> <span class="inlinecode"><span class="id" type="keyword">else</span></span> <span class="inlinecode"><span class="id" type="var">false</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">true</span>]</span> <span class="inlinecode"><span class="id" type="var">x</span></span> yields <span class="inlinecode"><span class="id" type="var">true</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">true</span>]</span> <span class="inlinecode">(<span class="id" type="keyword">if</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="keyword">then</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="keyword">else</span></span> <span class="inlinecode"><span class="id" type="var">y</span>)</span> yields <span class="inlinecode"><span class="id" type="keyword">if</span></span> <span class="inlinecode"><span class="id" type="var">true</span></span> <span class="inlinecode"><span class="id" type="keyword">then</span></span> <span class="inlinecode"><span class="id" type="var">true</span></span> <span class="inlinecode"><span class="id" type="keyword">else</span></span> <span class="inlinecode"><span class="id" type="var">y</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">true</span>]</span> <span class="inlinecode"><span class="id" type="var">y</span></span> yields <span class="inlinecode"><span class="id" type="var">y</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">true</span>]</span> <span class="inlinecode"><span class="id" type="var">false</span></span> yields <span class="inlinecode"><span class="id" type="var">false</span></span> (vacuous substitution)

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">true</span>]</span> <span class="inlinecode">(\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="keyword">if</span></span> <span class="inlinecode"><span class="id" type="var">y</span></span> <span class="inlinecode"><span class="id" type="keyword">then</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="keyword">else</span></span> <span class="inlinecode"><span class="id" type="var">false</span>)</span> yields <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="keyword">if</span></span> <span class="inlinecode"><span class="id" type="var">y</span></span> <span class="inlinecode"><span class="id" type="keyword">then</span></span> <span class="inlinecode"><span class="id" type="var">true</span></span> <span class="inlinecode"><span class="id" type="keyword">else</span></span> <span class="inlinecode"><span class="id" type="var">false</span></span>

</li>
<li> <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">true</span>]</span> <span class="inlinecode">(\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span>)</span> yields <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">true</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">true</span>]</span> <span class="inlinecode">(\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">y</span>)</span> yields <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">y</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">true</span>]</span> <span class="inlinecode">(\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span>)</span> yields <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span>

</li>
</ul>

<div class="paragraph"> </div>

    The last example is very important: substituting <span class="inlinecode"><span class="id" type="var">x</span></span> with <span class="inlinecode"><span class="id" type="var">true</span></span> in
    <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span> does <i>not</i> yield <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">true</span></span>!  The reason for
    this is that the <span class="inlinecode"><span class="id" type="var">x</span></span> in the body of <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span> is <i>bound</i> by the
    abstraction: it is a new, local name that just happens to be
    spelled the same as some global name <span class="inlinecode"><span class="id" type="var">x</span></span>. 
<div class="paragraph"> </div>

 Here is the definition, informally...

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;[<span class="id" type="var">x</span>:=<span class="id" type="var">s</span>]<span class="id" type="var">x</span>&nbsp;=&nbsp;<span class="id" type="var">s</span><br/>
&nbsp;&nbsp;&nbsp;[<span class="id" type="var">x</span>:=<span class="id" type="var">s</span>]<span class="id" type="var">y</span>&nbsp;=&nbsp;<span class="id" type="var">y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span>&nbsp;<span class="id" type="var">x</span>&nbsp;&lt;&gt;&nbsp;<span class="id" type="var">y</span><br/>
&nbsp;&nbsp;&nbsp;[<span class="id" type="var">x</span>:=<span class="id" type="var">s</span>](\<span class="id" type="var">x</span>:<span class="id" type="var">T11.t12</span>)&nbsp;&nbsp;&nbsp;=&nbsp;\<span class="id" type="var">x</span>:<span class="id" type="var">T11</span>. <span class="id" type="var">t12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;[<span class="id" type="var">x</span>:=<span class="id" type="var">s</span>](\<span class="id" type="var">y</span>:<span class="id" type="var">T11.t12</span>)&nbsp;&nbsp;&nbsp;=&nbsp;\<span class="id" type="var">y</span>:<span class="id" type="var">T11</span>. [<span class="id" type="var">x</span>:=<span class="id" type="var">s</span>]<span class="id" type="var">t12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span>&nbsp;<span class="id" type="var">x</span>&nbsp;&lt;&gt;&nbsp;<span class="id" type="var">y</span><br/>
&nbsp;&nbsp;&nbsp;[<span class="id" type="var">x</span>:=<span class="id" type="var">s</span>](<span class="id" type="var">t1</span>&nbsp;<span class="id" type="var">t2</span>)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;([<span class="id" type="var">x</span>:=<span class="id" type="var">s</span>]<span class="id" type="var">t1</span>)&nbsp;([<span class="id" type="var">x</span>:=<span class="id" type="var">s</span>]<span class="id" type="var">t2</span>)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;[<span class="id" type="var">x</span>:=<span class="id" type="var">s</span>]<span class="id" type="var">true</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;<span class="id" type="var">true</span><br/>
&nbsp;&nbsp;&nbsp;[<span class="id" type="var">x</span>:=<span class="id" type="var">s</span>]<span class="id" type="var">false</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;<span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;[<span class="id" type="var">x</span>:=<span class="id" type="var">s</span>](<span class="id" type="keyword">if</span>&nbsp;<span class="id" type="var">t1</span>&nbsp;<span class="id" type="keyword">then</span>&nbsp;<span class="id" type="var">t2</span>&nbsp;<span class="id" type="keyword">else</span>&nbsp;<span class="id" type="var">t3</span>)&nbsp;=&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span>&nbsp;[<span class="id" type="var">x</span>:=<span class="id" type="var">s</span>]<span class="id" type="var">t1</span>&nbsp;<span class="id" type="keyword">then</span>&nbsp;[<span class="id" type="var">x</span>:=<span class="id" type="var">s</span>]<span class="id" type="var">t2</span>&nbsp;<span class="id" type="keyword">else</span>&nbsp;[<span class="id" type="var">x</span>:=<span class="id" type="var">s</span>]<span class="id" type="var">t3</span>
<div class="paragraph"> </div>

</div>
    ... and formally: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="tactic">subst</span> (<span class="id" type="var">x</span>:<span class="id" type="var">id</span>) (<span class="id" type="var">s</span>:<span class="id" type="var">tm</span>) (<span class="id" type="var">t</span>:<span class="id" type="var">tm</span>) : <span class="id" type="var">tm</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">tvar</span> <span class="id" type="var">x'</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">beq_id</span> <span class="id" type="var">x</span> <span class="id" type="var">x'</span> <span class="id" type="keyword">then</span> <span class="id" type="var">s</span> <span class="id" type="keyword">else</span> <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">tabs</span> <span class="id" type="var">x'</span> <span class="id" type="var">T</span> <span class="id" type="var">t1</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">tabs</span> <span class="id" type="var">x'</span> <span class="id" type="var">T</span> (<span class="id" type="keyword">if</span> <span class="id" type="var">beq_id</span> <span class="id" type="var">x</span> <span class="id" type="var">x'</span> <span class="id" type="keyword">then</span> <span class="id" type="var">t1</span> <span class="id" type="keyword">else</span> (<span class="id" type="tactic">subst</span> <span class="id" type="var">x</span> <span class="id" type="var">s</span> <span class="id" type="var">t1</span>)) <br/>
&nbsp;&nbsp;| <span class="id" type="var">tapp</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">tapp</span> (<span class="id" type="tactic">subst</span> <span class="id" type="var">x</span> <span class="id" type="var">s</span> <span class="id" type="var">t1</span>) (<span class="id" type="tactic">subst</span> <span class="id" type="var">x</span> <span class="id" type="var">s</span> <span class="id" type="var">t2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">ttrue</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ttrue</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">tfalse</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">tfalse</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">tif</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">tif</span> (<span class="id" type="tactic">subst</span> <span class="id" type="var">x</span> <span class="id" type="var">s</span> <span class="id" type="var">t1</span>) (<span class="id" type="tactic">subst</span> <span class="id" type="var">x</span> <span class="id" type="var">s</span> <span class="id" type="var">t2</span>) (<span class="id" type="tactic">subst</span> <span class="id" type="var">x</span> <span class="id" type="var">s</span> <span class="id" type="var">t3</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Notation</span> "'[' x ':=' s ']' t" := (<span class="id" type="tactic">subst</span> <span class="id" type="var">x</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 20).<br/>

<br/>
</div>

<div class="doc">
<i>Technical note</i>: Substitution becomes trickier to define if we
    consider the case where <span class="inlinecode"><span class="id" type="var">s</span></span>, the term being substituted for a
    variable in some other term, may itself contain free variables.
    Since we are only interested here in defining the <span class="inlinecode"><span class="id" type="var">step</span></span> relation
    on closed terms (i.e., terms like <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">y</span></span> that mention
    variables are not bound by some enclosing lambda), we can avoid
    this extra complexity here. 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab556"></a><h3 class="section">Reduction</h3>

<div class="paragraph"> </div>

 The small-step reduction relation for STLC now follows the same
    pattern as the ones we have seen before.  Intuitively, to reduce a
    function application, we first reduce its left-hand side until it
    becomes a literal function; then we reduce its right-hand
    side (the argument) until it is also a value; and finally we
    substitute the argument for the bound variable in the body of the
    function.  This last rule, written informally as

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(\<span class="id" type="var">x</span>:<span class="id" type="var">T.t12</span>)&nbsp;<span class="id" type="var">v2</span>&nbsp;<span style="font-family: arial;">&rArr;</span>&nbsp;[<span class="id" type="var">x</span>:=<span class="id" type="var">v2</span>]<span class="id" type="var">t12</span>
<div class="paragraph"> </div>

</div>
    is traditionally called "beta-reduction". 
<div class="paragraph"> </div>

 <center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">value&nbsp;v2</td>
  <td class="infrulenamecol" rowspan="3">
    (ST_AppAbs) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">(\x:T.t12)&nbsp;v2&nbsp;<span style="font-family: arial;">&rArr;</span>&nbsp;[x:=v2]t12</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">t1&nbsp;<span style="font-family: arial;">&rArr;</span>&nbsp;t1'</td>
  <td class="infrulenamecol" rowspan="3">
    (ST_App1) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">t1&nbsp;t2&nbsp;<span style="font-family: arial;">&rArr;</span>&nbsp;t1'&nbsp;t2</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">value&nbsp;v1</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">t2&nbsp;<span style="font-family: arial;">&rArr;</span>&nbsp;t2'</td>
  <td class="infrulenamecol" rowspan="3">
    (ST_App2) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">v1&nbsp;t2&nbsp;<span style="font-family: arial;">&rArr;</span>&nbsp;v1&nbsp;t2'</td>
  <td></td>
</td>
</table></center> ... plus the usual rules for booleans:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (ST_IfTrue) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">(if&nbsp;true&nbsp;then&nbsp;t1&nbsp;else&nbsp;t2)&nbsp;<span style="font-family: arial;">&rArr;</span>&nbsp;t1</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (ST_IfFalse) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">(if&nbsp;false&nbsp;then&nbsp;t1&nbsp;else&nbsp;t2)&nbsp;<span style="font-family: arial;">&rArr;</span>&nbsp;t2</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">t1&nbsp;<span style="font-family: arial;">&rArr;</span>&nbsp;t1'</td>
  <td class="infrulenamecol" rowspan="3">
    (ST_If) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">(if&nbsp;t1&nbsp;then&nbsp;t2&nbsp;else&nbsp;t3)&nbsp;<span style="font-family: arial;">&rArr;</span>&nbsp;(if&nbsp;t1'&nbsp;then&nbsp;t2&nbsp;else&nbsp;t3)</td>
  <td></td>
</td>
</table></center>
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Reserved Notation</span> "t1 '<span style="font-family: arial;">&rArr;</span>' t2" (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 40).<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">step</span> : <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">ST_AppAbs</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">T</span> <span class="id" type="var">t12</span> <span class="id" type="var">v2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">value</span> <span class="id" type="var">v2</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tapp</span> (<span class="id" type="var">tabs</span> <span class="id" type="var">x</span> <span class="id" type="var">T</span> <span class="id" type="var">t12</span>) <span class="id" type="var">v2</span>) <span style="font-family: arial;">&rArr;</span> [<span class="id" type="var">x</span>:=<span class="id" type="var">v2</span>]<span class="id" type="var">t12</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">ST_App1</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">t1</span> <span class="id" type="var">t1'</span> <span class="id" type="var">t2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">t1</span> <span style="font-family: arial;">&rArr;</span> <span class="id" type="var">t1'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">tapp</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span style="font-family: arial;">&rArr;</span> <span class="id" type="var">tapp</span> <span class="id" type="var">t1'</span> <span class="id" type="var">t2</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">ST_App2</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">v1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t2'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">value</span> <span class="id" type="var">v1</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">t2</span> <span style="font-family: arial;">&rArr;</span> <span class="id" type="var">t2'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">tapp</span> <span class="id" type="var">v1</span> <span class="id" type="var">t2</span> <span style="font-family: arial;">&rArr;</span> <span class="id" type="var">tapp</span> <span class="id" type="var">v1</span>  <span class="id" type="var">t2'</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">ST_IfTrue</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">t1</span> <span class="id" type="var">t2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tif</span> <span class="id" type="var">ttrue</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) <span style="font-family: arial;">&rArr;</span> <span class="id" type="var">t1</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">ST_IfFalse</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">t1</span> <span class="id" type="var">t2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tif</span> <span class="id" type="var">tfalse</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) <span style="font-family: arial;">&rArr;</span> <span class="id" type="var">t2</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">ST_If</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">t1</span> <span class="id" type="var">t1'</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">t1</span> <span style="font-family: arial;">&rArr;</span> <span class="id" type="var">t1'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tif</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>) <span style="font-family: arial;">&rArr;</span> (<span class="id" type="var">tif</span> <span class="id" type="var">t1'</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>)<br/>
<br/>
<span class="id" type="keyword">where</span> "t1 '<span style="font-family: arial;">&rArr;</span>' t2" := (<span class="id" type="var">step</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>).<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "step_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "ST_AppAbs" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "ST_App1" <br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "ST_App2" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "ST_IfTrue" <br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "ST_IfFalse" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "ST_If" ].<br/>

<br/>
<span class="id" type="keyword">Hint</span> <span class="id" type="var">Constructors</span> <span class="id" type="var">step</span>.<br/>

<br/>
<span class="id" type="keyword">Notation</span> <span class="id" type="var">multistep</span> := (<span class="id" type="var">multi</span> <span class="id" type="var">step</span>).<br/>
<span class="id" type="keyword">Notation</span> "t1 '<span style="font-family: arial;">&rArr;*</span>' t2" := (<span class="id" type="var">multistep</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 40).<br/>

<br/>
</div>

<div class="doc">
<a name="lab557"></a><h3 class="section">Examples</h3>

<div class="paragraph"> </div>

 Example:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;((\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span>. <span class="id" type="var">x</span>)&nbsp;(\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>. <span class="id" type="var">x</span>))&nbsp;<span style="font-family: arial;">&rArr;*</span>&nbsp;(\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>. <span class="id" type="var">x</span>)
<div class="paragraph"> </div>

</div>
i.e.

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">idBB</span>&nbsp;<span class="id" type="var">idB</span>)&nbsp;<span style="font-family: arial;">&rArr;*</span>&nbsp;<span class="id" type="var">idB</span>
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">step_example1</span> :<br/>
&nbsp;&nbsp;(<span class="id" type="var">tapp</span> <span class="id" type="var">idBB</span> <span class="id" type="var">idB</span>) <span style="font-family: arial;">&rArr;*</span> <span class="id" type="var">idB</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">multi_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ST_AppAbs</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">v_abs</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">multi_refl</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
A more automatic proof 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">step_example1'</span> :<br/>
&nbsp;&nbsp;(<span class="id" type="var">tapp</span> <span class="id" type="var">idBB</span> <span class="id" type="var">idB</span>) <span style="font-family: arial;">&rArr;*</span> <span class="id" type="var">idB</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="var">normalize</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">step_example2</span> :<br/>
&nbsp;&nbsp;(<span class="id" type="var">tapp</span> <span class="id" type="var">idBB</span> (<span class="id" type="var">tapp</span> <span class="id" type="var">idBB</span> <span class="id" type="var">idB</span>)) <span style="font-family: arial;">&rArr;*</span> <span class="id" type="var">idB</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">multi_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ST_App2</span>. <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ST_AppAbs</span>. <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">multi_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ST_AppAbs</span>. <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">multi_refl</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Again, we can use the <span class="inlinecode"><span class="id" type="var">normalize</span></span> tactic from above to simplify
    the proof. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">step_example2'</span> :<br/>
&nbsp;&nbsp;(<span class="id" type="var">tapp</span> <span class="id" type="var">idBB</span> (<span class="id" type="var">tapp</span> <span class="id" type="var">idBB</span> <span class="id" type="var">idB</span>)) <span style="font-family: arial;">&rArr;*</span> <span class="id" type="var">idB</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">normalize</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab558"></a><h4 class="section">Exercise: 2 stars (step_example3)</h4>
 Try to do this one both with and without <span class="inlinecode"><span class="id" type="var">normalize</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">step_example3</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tapp</span> (<span class="id" type="var">tapp</span> <span class="id" type="var">idBBBB</span> <span class="id" type="var">idBB</span>) <span class="id" type="var">idB</span>)<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&rArr;*</span> <span class="id" type="var">idB</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab559"></a><h2 class="section">Typing</h2>

</div>
<div class="code code-space">

<br/>
</div>

<div class="doc">
<a name="lab560"></a><h3 class="section">Contexts</h3>

<div class="paragraph"> </div>

 <i>Question</i>: What is the type of the term "<span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">y</span></span>"?

<div class="paragraph"> </div>

    <i>Answer</i>: It depends on the types of <span class="inlinecode"><span class="id" type="var">x</span></span> and <span class="inlinecode"><span class="id" type="var">y</span></span>!  

<div class="paragraph"> </div>

    I.e., in order to assign a type to a term, we need to know
    what assumptions we should make about the types of its free
    variables.

<div class="paragraph"> </div>

    This leads us to a three-place "typing judgment", informally
    written <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>, where <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> is a
    "typing context" &mdash; a mapping from variables to their types. 
<div class="paragraph"> </div>

 We hide the definition of partial maps in a module since it is
    actually defined in <span class="inlinecode"><span class="id" type="var">SfLib</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">PartialMap</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">partial_map</span> (<span class="id" type="var">A</span>:<span class="id" type="keyword">Type</span>) := <span class="id" type="var">id</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">option</span> <span class="id" type="var">A</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">empty</span> {<span class="id" type="var">A</span>:<span class="id" type="keyword">Type</span>} : <span class="id" type="var">partial_map</span> <span class="id" type="var">A</span> := (<span class="id" type="keyword">fun</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">None</span>).<br/>

<br/>
</div>

<div class="doc">
Informally, we'll write <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span>,</span> <span class="inlinecode"><span class="id" type="var">x</span>:<span class="id" type="var">T</span></span> for "extend the partial
    function <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> to also map <span class="inlinecode"><span class="id" type="var">x</span></span> to <span class="inlinecode"><span class="id" type="var">T</span></span>."  Formally, we use the
    function <span class="inlinecode"><span class="id" type="var">extend</span></span> to add a binding to a partial map. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">extend</span> {<span class="id" type="var">A</span>:<span class="id" type="keyword">Type</span>} (<span style="font-family: serif; font-size:85%;">&Gamma;</span> : <span class="id" type="var">partial_map</span> <span class="id" type="var">A</span>) (<span class="id" type="var">x</span>:<span class="id" type="var">id</span>) (<span class="id" type="var">T</span> : <span class="id" type="var">A</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">x'</span> =&gt; <span class="id" type="keyword">if</span> <span class="id" type="var">beq_id</span> <span class="id" type="var">x</span> <span class="id" type="var">x'</span> <span class="id" type="keyword">then</span> <span class="id" type="var">Some</span> <span class="id" type="var">T</span> <span class="id" type="keyword">else</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">x'</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">extend_eq</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">A</span> (<span class="id" type="var">ctxt</span>: <span class="id" type="var">partial_map</span> <span class="id" type="var">A</span>) <span class="id" type="var">x</span> <span class="id" type="var">T</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">extend</span> <span class="id" type="var">ctxt</span> <span class="id" type="var">x</span> <span class="id" type="var">T</span>) <span class="id" type="var">x</span> = <span class="id" type="var">Some</span> <span class="id" type="var">T</span>.<br/>
<div class="togglescript" id="proofcontrol3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')"><span class="show"></span></div>
<div class="proofscript" id="proof3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">extend</span>. <span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">beq_id_refl</span>. <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">extend_neq</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">A</span> (<span class="id" type="var">ctxt</span>: <span class="id" type="var">partial_map</span> <span class="id" type="var">A</span>) <span class="id" type="var">x1</span> <span class="id" type="var">T</span> <span class="id" type="var">x2</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">beq_id</span> <span class="id" type="var">x2</span> <span class="id" type="var">x1</span> = <span class="id" type="var">false</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;(<span class="id" type="var">extend</span> <span class="id" type="var">ctxt</span> <span class="id" type="var">x2</span> <span class="id" type="var">T</span>) <span class="id" type="var">x1</span> = <span class="id" type="var">ctxt</span> <span class="id" type="var">x1</span>.<br/>
<div class="togglescript" id="proofcontrol4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')"><span class="show"></span></div>
<div class="proofscript" id="proof4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">extend</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">PartialMap</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">context</span> := <span class="id" type="var">partial_map</span> <span class="id" type="var">ty</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab561"></a><h3 class="section">Typing Relation</h3>

<div class="paragraph"> </div>

 <center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;x&nbsp;=&nbsp;T</td>
  <td class="infrulenamecol" rowspan="3">
    (T_Var) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;x&nbsp;:&nbsp;T</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;,&nbsp;x:T11&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;t12&nbsp;:&nbsp;T12</td>
  <td class="infrulenamecol" rowspan="3">
    (T_Abs) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;\x:T11.t12&nbsp;:&nbsp;T11->T12</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;t1&nbsp;:&nbsp;T11->T12</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;t2&nbsp;:&nbsp;T11</td>
  <td class="infrulenamecol" rowspan="3">
    (T_App) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;t1&nbsp;t2&nbsp;:&nbsp;T12</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (T_True) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;true&nbsp;:&nbsp;Bool</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (T_False) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;false&nbsp;:&nbsp;Bool</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;t1&nbsp;:&nbsp;Bool&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;t2&nbsp;:&nbsp;T&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;t3&nbsp;:&nbsp;T</td>
  <td class="infrulenamecol" rowspan="3">
    (T_If) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;if&nbsp;t1&nbsp;then&nbsp;t2&nbsp;else&nbsp;t3&nbsp;:&nbsp;T</td>
  <td></td>
</td>
</table></center>
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">has_type</span> : <span class="id" type="var">context</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">ty</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">T_Var</span> : <span style="font-family: arial;">&forall;</span><span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">x</span> <span class="id" type="var">T</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">x</span> = <span class="id" type="var">Some</span> <span class="id" type="var">T</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> (<span class="id" type="var">tvar</span> <span class="id" type="var">x</span>) <span class="id" type="var">T</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">T_Abs</span> : <span style="font-family: arial;">&forall;</span><span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">x</span> <span class="id" type="var">T11</span> <span class="id" type="var">T12</span> <span class="id" type="var">t12</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> (<span class="id" type="var">extend</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">x</span> <span class="id" type="var">T11</span>) <span class="id" type="var">t12</span> <span class="id" type="var">T12</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> (<span class="id" type="var">tabs</span> <span class="id" type="var">x</span> <span class="id" type="var">T11</span> <span class="id" type="var">t12</span>) (<span class="id" type="var">TArrow</span> <span class="id" type="var">T11</span> <span class="id" type="var">T12</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">T_App</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">T11</span> <span class="id" type="var">T12</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">t1</span> (<span class="id" type="var">TArrow</span> <span class="id" type="var">T11</span> <span class="id" type="var">T12</span>) <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">t2</span> <span class="id" type="var">T11</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> (<span class="id" type="var">tapp</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) <span class="id" type="var">T12</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">T_True</span> : <span style="font-family: arial;">&forall;</span><span style="font-family: serif; font-size:85%;">&Gamma;</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">ttrue</span> <span class="id" type="var">TBool</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">T_False</span> : <span style="font-family: arial;">&forall;</span><span style="font-family: serif; font-size:85%;">&Gamma;</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">tfalse</span> <span class="id" type="var">TBool</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">T_If</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span> <span class="id" type="var">T</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">t1</span> <span class="id" type="var">TBool</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">t2</span> <span class="id" type="var">T</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">t3</span> <span class="id" type="var">T</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> (<span class="id" type="var">tif</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>) <span class="id" type="var">T</span>.<br/>

<br/>
<div class="togglescript" id="proofcontrol5" onclick="toggleDisplay('proof5');toggleDisplay('proofcontrol5')"><span class="show"></span></div>
<div class="proofscript" id="proof5" onclick="toggleDisplay('proof5');toggleDisplay('proofcontrol5')">
<span class="id" type="keyword">Tactic Notation</span> "has_type_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "T_Var" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "T_Abs" <br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "T_App" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "T_True" <br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "T_False" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "T_If" ].<br/>

<br/>
<span class="id" type="keyword">Hint</span> <span class="id" type="var">Constructors</span> <span class="id" type="var">has_type</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<a name="lab562"></a><h3 class="section">Examples</h3>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">typing_example_1</span> :<br/>
&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span class="id" type="var">empty</span> (<span class="id" type="var">tabs</span> <span class="id" type="var">x</span> <span class="id" type="var">TBool</span> (<span class="id" type="var">tvar</span> <span class="id" type="var">x</span>)) (<span class="id" type="var">TArrow</span> <span class="id" type="var">TBool</span> <span class="id" type="var">TBool</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">T_Abs</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">T_Var</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Note that since we added the <span class="inlinecode"><span class="id" type="var">has_type</span></span> constructors to the hints
    database, auto can actually solve this one immediately. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">typing_example_1'</span> :<br/>
&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span class="id" type="var">empty</span> (<span class="id" type="var">tabs</span> <span class="id" type="var">x</span> <span class="id" type="var">TBool</span> (<span class="id" type="var">tvar</span> <span class="id" type="var">x</span>)) (<span class="id" type="var">TArrow</span> <span class="id" type="var">TBool</span> <span class="id" type="var">TBool</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">auto</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Hint</span> <span class="id" type="keyword">Unfold</span> <span class="id" type="var">beq_id</span> <span class="id" type="var">beq_nat</span> <span class="id" type="var">extend</span>.<br/>

<br/>
</div>

<div class="doc">
Another example:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">empty</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;\<span class="id" type="var">x</span>:<span class="id" type="var">A</span>. \<span class="id" type="var">y</span>:<span class="id" type="var">A</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">A</span>. <span class="id" type="var">y</span>&nbsp;(<span class="id" type="var">y</span>&nbsp;<span class="id" type="var">x</span>))&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;<span class="id" type="var">A</span>&nbsp;<span style="font-family: arial;">&rarr;</span>&nbsp;(<span class="id" type="var">A</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">A</span>)&nbsp;<span style="font-family: arial;">&rarr;</span>&nbsp;<span class="id" type="var">A</span>.
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<div class="togglescript" id="proofcontrol6" onclick="toggleDisplay('proof6');toggleDisplay('proofcontrol6')"><span class="show"></span></div>
<div class="proofscript" id="proof6" onclick="toggleDisplay('proof6');toggleDisplay('proofcontrol6')">
<span class="id" type="keyword">Example</span> <span class="id" type="var">typing_example_2</span> :<br/>
&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span class="id" type="var">empty</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tabs</span> <span class="id" type="var">x</span> <span class="id" type="var">TBool</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tabs</span> <span class="id" type="var">y</span> (<span class="id" type="var">TArrow</span> <span class="id" type="var">TBool</span> <span class="id" type="var">TBool</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tapp</span> (<span class="id" type="var">tvar</span> <span class="id" type="var">y</span>) (<span class="id" type="var">tapp</span> (<span class="id" type="var">tvar</span> <span class="id" type="var">y</span>) (<span class="id" type="var">tvar</span> <span class="id" type="var">x</span>)))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">TArrow</span> <span class="id" type="var">TBool</span> (<span class="id" type="var">TArrow</span> (<span class="id" type="var">TArrow</span> <span class="id" type="var">TBool</span> <span class="id" type="var">TBool</span>) <span class="id" type="var">TBool</span>)).<br/>
<span class="id" type="keyword">Proof</span> <span class="id" type="keyword">with</span> <span class="id" type="tactic">auto</span> <span class="id" type="keyword">using</span> <span class="id" type="var">extend_eq</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">T_Abs</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">T_Abs</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">T_App</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">T_Var</span>...<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">T_App</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">T_Var</span>...<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">T_Var</span>...<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<a name="lab563"></a><h4 class="section">Exercise: 2 stars, optional (typing_example_2_full)</h4>
 Prove the same result without using <span class="inlinecode"><span class="id" type="tactic">auto</span></span>, <span class="inlinecode"><span class="id" type="tactic">eauto</span></span>, or
    <span class="inlinecode"><span class="id" type="tactic">eapply</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">typing_example_2_full</span> :<br/>
&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span class="id" type="var">empty</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tabs</span> <span class="id" type="var">x</span> <span class="id" type="var">TBool</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tabs</span> <span class="id" type="var">y</span> (<span class="id" type="var">TArrow</span> <span class="id" type="var">TBool</span> <span class="id" type="var">TBool</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tapp</span> (<span class="id" type="var">tvar</span> <span class="id" type="var">y</span>) (<span class="id" type="var">tapp</span> (<span class="id" type="var">tvar</span> <span class="id" type="var">y</span>) (<span class="id" type="var">tvar</span> <span class="id" type="var">x</span>)))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">TArrow</span> <span class="id" type="var">TBool</span> (<span class="id" type="var">TArrow</span> (<span class="id" type="var">TArrow</span> <span class="id" type="var">TBool</span> <span class="id" type="var">TBool</span>) <span class="id" type="var">TBool</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab564"></a><h4 class="section">Exercise: 2 stars (typing_example_3)</h4>
 Formally prove the following typing derivation holds:  
<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;<span class="id" type="var">empty</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;(\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">B</span>. \<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span>. \<span class="id" type="var">z</span>:<span class="id" type="var">Bool</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">y</span>&nbsp;(<span class="id" type="var">x</span>&nbsp;<span class="id" type="var">z</span>))&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;<span class="id" type="var">T</span>.
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<div class="togglescript" id="proofcontrol7" onclick="toggleDisplay('proof7');toggleDisplay('proofcontrol7')"><span class="show"></span></div>
<div class="proofscript" id="proof7" onclick="toggleDisplay('proof7');toggleDisplay('proofcontrol7')">
<span class="id" type="keyword">Example</span> <span class="id" type="var">typing_example_3</span> :<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span><span class="id" type="var">T</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span class="id" type="var">empty</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tabs</span> <span class="id" type="var">x</span> (<span class="id" type="var">TArrow</span> <span class="id" type="var">TBool</span> <span class="id" type="var">TBool</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tabs</span> <span class="id" type="var">y</span> (<span class="id" type="var">TArrow</span> <span class="id" type="var">TBool</span> <span class="id" type="var">TBool</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tabs</span> <span class="id" type="var">z</span> <span class="id" type="var">TBool</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tapp</span> (<span class="id" type="var">tvar</span> <span class="id" type="var">y</span>) (<span class="id" type="var">tapp</span> (<span class="id" type="var">tvar</span> <span class="id" type="var">x</span>) (<span class="id" type="var">tvar</span> <span class="id" type="var">z</span>))))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">T</span>.<br/>

<br/>
<span class="id" type="keyword">Proof</span> <span class="id" type="keyword">with</span> <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

 We can also show that terms are <i>not</i> typable.  For example, let's
    formally check that there is no typing derivation assigning a type
    to the term <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span>,</span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">y</span></span> &mdash; i.e.,

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;~&nbsp;<span style="font-family: arial;">&exist;</span>&nbsp;<span class="id" type="var">T</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">empty</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;(\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>. \<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span>,&nbsp;<span class="id" type="var">x</span>&nbsp;<span class="id" type="var">y</span>)&nbsp;:&nbsp;<span class="id" type="var">T</span>.
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<div class="togglescript" id="proofcontrol8" onclick="toggleDisplay('proof8');toggleDisplay('proofcontrol8')"><span class="show"></span></div>
<div class="proofscript" id="proof8" onclick="toggleDisplay('proof8');toggleDisplay('proofcontrol8')">
<span class="id" type="keyword">Example</span> <span class="id" type="var">typing_nonexample_1</span> :<br/>
&nbsp;&nbsp;~ <span style="font-family: arial;">&exist;</span><span class="id" type="var">T</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span class="id" type="var">empty</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tabs</span> <span class="id" type="var">x</span> <span class="id" type="var">TBool</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tabs</span> <span class="id" type="var">y</span> <span class="id" type="var">TBool</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tapp</span> (<span class="id" type="var">tvar</span> <span class="id" type="var">x</span>) (<span class="id" type="var">tvar</span> <span class="id" type="var">y</span>))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">T</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">Hc</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hc</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;<span class="inlinecode"><span class="id" type="tactic">clear</span></span>&nbsp;tactic&nbsp;is&nbsp;useful&nbsp;here&nbsp;for&nbsp;tidying&nbsp;away&nbsp;bits&nbsp;of<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;context&nbsp;that&nbsp;we're&nbsp;not&nbsp;going&nbsp;to&nbsp;need&nbsp;again.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H5</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">H5</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H4</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">H4</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H2</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">H2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H5</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">H5</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;rewrite&nbsp;extend_neq&nbsp;in&nbsp;H1.&nbsp;rewrite&nbsp;extend_eq&nbsp;in&nbsp;H1.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<a name="lab565"></a><h4 class="section">Exercise: 3 stars (typing_nonexample_3)</h4>
 Another nonexample:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;~&nbsp;(<span style="font-family: arial;">&exist;</span>&nbsp;<span class="id" type="var">S</span>,&nbsp;<span style="font-family: arial;">&exist;</span>&nbsp;<span class="id" type="var">T</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">empty</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;(\<span class="id" type="var">x</span>:<span class="id" type="var">S</span>. <span class="id" type="var">x</span>&nbsp;<span class="id" type="var">x</span>)&nbsp;:&nbsp;<span class="id" type="var">T</span>).
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">typing_nonexample_3</span> :<br/>
&nbsp;&nbsp;~ (<span style="font-family: arial;">&exist;</span><span class="id" type="var">S</span>, <span style="font-family: arial;">&exist;</span><span class="id" type="var">T</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span class="id" type="var">empty</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tabs</span> <span class="id" type="var">x</span> <span class="id" type="var">S</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">tapp</span> (<span class="id" type="var">tvar</span> <span class="id" type="var">x</span>) (<span class="id" type="var">tvar</span> <span class="id" type="var">x</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">T</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab566"></a><h4 class="section">Exercise: 1 star, optional (typing_statements)</h4>

<div class="paragraph"> </div>

 Which of the following propositions are provable? 

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" type="var">y</span>:<span class="id" type="var">Bool</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool.x</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span style="font-family: arial;">&exist;</span></span> <span class="inlinecode"><span class="id" type="var">T</span>,</span>  <span class="inlinecode"><span class="id" type="var">empty</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode">(\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span>.</span> <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">y</span></span> <span class="inlinecode"><span class="id" type="var">x</span>)</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span style="font-family: arial;">&exist;</span></span> <span class="inlinecode"><span class="id" type="var">T</span>,</span>  <span class="inlinecode"><span class="id" type="var">empty</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode">(\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span>.</span> <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">y</span>)</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span style="font-family: arial;">&exist;</span></span> <span class="inlinecode"><span class="id" type="var">S</span>,</span> <span class="inlinecode"><span class="id" type="var">x</span>:<span class="id" type="var">S</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode">(\<span class="id" type="var">y</span>:<span class="id" type="var">Bool</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">Bool</span>.</span> <span class="inlinecode"><span class="id" type="var">y</span>)</span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">S</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span style="font-family: arial;">&exist;</span></span> <span class="inlinecode"><span class="id" type="var">S</span>,</span> <span class="inlinecode"><span style="font-family: arial;">&exist;</span></span> <span class="inlinecode"><span class="id" type="var">T</span>,</span>  <span class="inlinecode"><span class="id" type="var">x</span>:<span class="id" type="var">S</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode">(<span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">x</span>)</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>

</li>
</ul>

<div class="paragraph"> </div>

<font size=-2>&#9744;</font>

<div class="paragraph"> </div>

<a name="lab567"></a><h4 class="section">Exercise: 1 star (more_typing_statements)</h4>

<div class="paragraph"> </div>

 Which of the following propositions are provable?  For the
    ones that are, give witnesses for the existentially bound
    variables.

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span style="font-family: arial;">&exist;</span></span> <span class="inlinecode"><span class="id" type="var">T</span>,</span>  <span class="inlinecode"><span class="id" type="var">empty</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode">(\<span class="id" type="var">y</span>:<span class="id" type="var">B</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">B</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">B</span>.</span> <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">B</span>,</span> <span class="inlinecode"><span class="id" type="var">y</span></span> <span class="inlinecode"><span class="id" type="var">x</span>)</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span style="font-family: arial;">&exist;</span></span> <span class="inlinecode"><span class="id" type="var">T</span>,</span>  <span class="inlinecode"><span class="id" type="var">empty</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode">(\<span class="id" type="var">x</span>:<span class="id" type="var">A</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">B</span>,</span> <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">B</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">C</span>,</span> <span class="inlinecode">\<span class="id" type="var">z</span>:<span class="id" type="var">A</span>,</span> <span class="inlinecode"><span class="id" type="var">y</span></span> <span class="inlinecode">(<span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">z</span>)):<span class="id" type="var">T</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span style="font-family: arial;">&exist;</span></span> <span class="inlinecode"><span class="id" type="var">S</span>,</span> <span class="inlinecode"><span style="font-family: arial;">&exist;</span></span> <span class="inlinecode"><span class="id" type="var">U</span>,</span> <span class="inlinecode"><span style="font-family: arial;">&exist;</span></span> <span class="inlinecode"><span class="id" type="var">T</span>,</span>  <span class="inlinecode"><span class="id" type="var">x</span>:<span class="id" type="var">S</span>,</span> <span class="inlinecode"><span class="id" type="var">y</span>:<span class="id" type="var">U</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode">\<span class="id" type="var">z</span>:<span class="id" type="var">A</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">(<span class="id" type="var">y</span></span> <span class="inlinecode"><span class="id" type="var">z</span>)</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span style="font-family: arial;">&exist;</span></span> <span class="inlinecode"><span class="id" type="var">S</span>,</span> <span class="inlinecode"><span style="font-family: arial;">&exist;</span></span> <span class="inlinecode"><span class="id" type="var">T</span>,</span>  <span class="inlinecode"><span class="id" type="var">x</span>:<span class="id" type="var">S</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">A</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">(<span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">y</span>)</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span style="font-family: arial;">&exist;</span></span> <span class="inlinecode"><span class="id" type="var">S</span>,</span> <span class="inlinecode"><span style="font-family: arial;">&exist;</span></span> <span class="inlinecode"><span class="id" type="var">U</span>,</span> <span class="inlinecode"><span style="font-family: arial;">&exist;</span></span> <span class="inlinecode"><span class="id" type="var">T</span>,</span>  <span class="inlinecode"><span class="id" type="var">x</span>:<span class="id" type="var">S</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">(\<span class="id" type="var">z</span>:<span class="id" type="var">U</span>.</span> <span class="inlinecode"><span class="id" type="var">z</span></span> <span class="inlinecode"><span class="id" type="var">x</span>)</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>

</li>
</ul>

<div class="paragraph"> </div>

<font size=-2>&#9744;</font>

</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab568"></a><h2 class="section">Properties</h2>

</div>
<div class="code code-space">

<br/>
</div>

<div class="doc">
<a name="lab569"></a><h3 class="section">Progress</h3>

<div class="paragraph"> </div>

 The <i>progress</i> theorem tells us that closed, well-typed
    terms are not stuck: either a well-typed term is a value, or
    it can take an evaluation step. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="tactic">progress</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">t</span> <span class="id" type="var">T</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span class="id" type="var">empty</span> <span class="id" type="var">t</span> <span class="id" type="var">T</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">value</span> <span class="id" type="var">t</span> <span style="font-family: arial;">&or;</span> <span style="font-family: arial;">&exist;</span><span class="id" type="var">t'</span>, <span class="id" type="var">t</span> <span style="font-family: arial;">&rArr;</span> <span class="id" type="var">t'</span>.<br/>

<br/>
</div>

<div class="doc">
<i>Proof</i>: by induction on the derivation of <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>.

<div class="paragraph"> </div>

<ul class="doclist">
<li> The last rule of the derivation cannot be <span class="inlinecode"><span class="id" type="var">T_Var</span></span>, since a
      variable is never well typed in an empty context.

<div class="paragraph"> </div>


</li>
<li> The <span class="inlinecode"><span class="id" type="var">T_True</span></span>, <span class="inlinecode"><span class="id" type="var">T_False</span></span>, and <span class="inlinecode"><span class="id" type="var">T_Abs</span></span> cases are trivial, since in
      each of these cases we know immediately that <span class="inlinecode"><span class="id" type="var">t</span></span> is a value.

<div class="paragraph"> </div>


</li>
<li> If the last rule of the derivation was <span class="inlinecode"><span class="id" type="var">T_App</span></span>, then <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">t1</span></span>
      <span class="inlinecode"><span class="id" type="var">t2</span></span>, and we know that <span class="inlinecode"><span class="id" type="var">t1</span></span> and <span class="inlinecode"><span class="id" type="var">t2</span></span> are also well typed in the
      empty context; in particular, there exists a type <span class="inlinecode"><span class="id" type="var">T2</span></span> such that
      <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t1</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T2</span></span> <span class="inlinecode"><span style="font-family: arial;">&rarr;</span></span> <span class="inlinecode"><span class="id" type="var">T</span></span> and <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T2</span></span>.  By the induction
      hypothesis, either <span class="inlinecode"><span class="id" type="var">t1</span></span> is a value or it can take an evaluation
      step.

<div class="paragraph"> </div>

<ul class="doclist">
<li> If <span class="inlinecode"><span class="id" type="var">t1</span></span> is a value, we now consider <span class="inlinecode"><span class="id" type="var">t2</span></span>, which by the other
          induction hypothesis must also either be a value or take an
          evaluation step.

<div class="paragraph"> </div>

<ul class="doclist">
<li> Suppose <span class="inlinecode"><span class="id" type="var">t2</span></span> is a value.  Since <span class="inlinecode"><span class="id" type="var">t1</span></span> is a value with an
              arrow type, it must be a lambda abstraction; hence <span class="inlinecode"><span class="id" type="var">t1</span></span>
              <span class="inlinecode"><span class="id" type="var">t2</span></span> can take a step by <span class="inlinecode"><span class="id" type="var">ST_AppAbs</span></span>.

<div class="paragraph"> </div>


</li>
<li> Otherwise, <span class="inlinecode"><span class="id" type="var">t2</span></span> can take a step, and hence so can <span class="inlinecode"><span class="id" type="var">t1</span></span>
              <span class="inlinecode"><span class="id" type="var">t2</span></span> by <span class="inlinecode"><span class="id" type="var">ST_App2</span></span>.

<div class="paragraph"> </div>


</li>
</ul>

</li>
<li> If <span class="inlinecode"><span class="id" type="var">t1</span></span> can take a step, then so can <span class="inlinecode"><span class="id" type="var">t1</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span> by <span class="inlinecode"><span class="id" type="var">ST_App1</span></span>.

<div class="paragraph"> </div>


</li>
</ul>

</li>
<li> If the last rule of the derivation was <span class="inlinecode"><span class="id" type="var">T_If</span></span>, then <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="keyword">if</span></span> <span class="inlinecode"><span class="id" type="var">t1</span></span>
      <span class="inlinecode"><span class="id" type="keyword">then</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span> <span class="inlinecode"><span class="id" type="keyword">else</span></span> <span class="inlinecode"><span class="id" type="var">t3</span></span>, where <span class="inlinecode"><span class="id" type="var">t1</span></span> has type <span class="inlinecode"><span class="id" type="var">Bool</span></span>.  By the IH, <span class="inlinecode"><span class="id" type="var">t1</span></span>
      is either a value or takes a step.

<div class="paragraph"> </div>

<ul class="doclist">
<li> If <span class="inlinecode"><span class="id" type="var">t1</span></span> is a value, then since it has type <span class="inlinecode"><span class="id" type="var">Bool</span></span> it must be
          either <span class="inlinecode"><span class="id" type="var">true</span></span> or <span class="inlinecode"><span class="id" type="var">false</span></span>.  If it is <span class="inlinecode"><span class="id" type="var">true</span></span>, then <span class="inlinecode"><span class="id" type="var">t</span></span> steps
          to <span class="inlinecode"><span class="id" type="var">t2</span></span>; otherwise it steps to <span class="inlinecode"><span class="id" type="var">t3</span></span>.

<div class="paragraph"> </div>


</li>
<li> Otherwise, <span class="inlinecode"><span class="id" type="var">t1</span></span> takes a step, and therefore so does <span class="inlinecode"><span class="id" type="var">t</span></span> (by
          <span class="inlinecode"><span class="id" type="var">ST_If</span></span>).

</li>
</ul>

</li>
</ul>

<div class="paragraph"> </div>


</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Proof</span> <span class="id" type="keyword">with</span> <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">T</span> <span class="id" type="var">Ht</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (@<span class="id" type="var">empty</span> <span class="id" type="var">ty</span>) <span class="id" type="keyword">as</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">has_type_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">Ht</span>) <span class="id" type="var">Case</span>; <span class="id" type="tactic">subst</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span>...<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "T_Var".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;contradictory:&nbsp;variables&nbsp;cannot&nbsp;be&nbsp;typed&nbsp;in&nbsp;an&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;empty&nbsp;context&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "T_App".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;<span class="inlinecode"><span class="id" type="var">t</span></span>&nbsp;=&nbsp;<span class="inlinecode"><span class="id" type="var">t1</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span>.&nbsp;&nbsp;Proceed&nbsp;by&nbsp;cases&nbsp;on&nbsp;whether&nbsp;<span class="inlinecode"><span class="id" type="var">t1</span></span>&nbsp;is&nbsp;a&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value&nbsp;or&nbsp;steps...&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">right</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">IHHt1</span>...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "t1 is a value".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">IHHt2</span>...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "t2 is also a value".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Since&nbsp;<span class="inlinecode"><span class="id" type="var">t1</span></span>&nbsp;is&nbsp;a&nbsp;value&nbsp;and&nbsp;has&nbsp;an&nbsp;arrow&nbsp;type,&nbsp;it<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;must&nbsp;be&nbsp;an&nbsp;abs.&nbsp;Sometimes&nbsp;this&nbsp;is&nbsp;proved&nbsp;separately&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;called&nbsp;a&nbsp;"canonical&nbsp;forms"&nbsp;lemma.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>. <span style="font-family: arial;">&exist;</span>([<span class="id" type="var">x0</span>:=<span class="id" type="var">t2</span>]<span class="id" type="var">t</span>)...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">solve</span> <span class="id" type="tactic">by</span> <span class="id" type="tactic">inversion</span>. <span class="id" type="var">solve</span> <span class="id" type="tactic">by</span> <span class="id" type="tactic">inversion</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "t2 steps".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t2'</span> <span class="id" type="var">Hstp</span>]. <span style="font-family: arial;">&exist;</span>(<span class="id" type="var">tapp</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2'</span>)...<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "t1 steps".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1'</span> <span class="id" type="var">Hstp</span>]. <span style="font-family: arial;">&exist;</span>(<span class="id" type="var">tapp</span> <span class="id" type="var">t1'</span> <span class="id" type="var">t2</span>)...<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "T_If".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">right</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">IHHt1</span>...<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "t1 is a value".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Since&nbsp;<span class="inlinecode"><span class="id" type="var">t1</span></span>&nbsp;is&nbsp;a&nbsp;value&nbsp;of&nbsp;boolean&nbsp;type,&nbsp;it&nbsp;must<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;be&nbsp;true&nbsp;or&nbsp;false&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>. <span class="id" type="var">solve</span> <span class="id" type="tactic">by</span> <span class="id" type="tactic">inversion</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "t1 = true". <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "t1 = false". <span class="id" type="tactic">eauto</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "t1 also steps".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1'</span> <span class="id" type="var">Hstp</span>]. <span style="font-family: arial;">&exist;</span>(<span class="id" type="var">tif</span> <span class="id" type="var">t1'</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>)...<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab570"></a><h4 class="section">Exercise: 3 stars, optional (progress_from_term_ind)</h4>
 Show that progress can also be proved by induction on terms
    instead of induction on typing derivations. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">progress'</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">t</span> <span class="id" type="var">T</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span class="id" type="var">empty</span> <span class="id" type="var">t</span> <span class="id" type="var">T</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">value</span> <span class="id" type="var">t</span> <span style="font-family: arial;">&or;</span> <span style="font-family: arial;">&exist;</span><span class="id" type="var">t'</span>, <span class="id" type="var">t</span> <span style="font-family: arial;">&rArr;</span> <span class="id" type="var">t'</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">t_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">t</span>) <span class="id" type="var">Case</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">T</span> <span class="id" type="var">Ht</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab571"></a><h3 class="section">Free Occurrences</h3>

<div class="paragraph"> </div>

 A variable <span class="inlinecode"><span class="id" type="var">x</span></span> <i>appears free in</i> a term <i>t</i> if <span class="inlinecode"><span class="id" type="var">t</span></span> contains some
    occurrence of <span class="inlinecode"><span class="id" type="var">x</span></span> that is not under an abstraction labeled <span class="inlinecode"><span class="id" type="var">x</span></span>.  For example: 

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" type="var">y</span></span> appears free, but <span class="inlinecode"><span class="id" type="var">x</span></span> does not, in <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">T</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">U</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">y</span></span> 

</li>
<li> both <span class="inlinecode"><span class="id" type="var">x</span></span> and <span class="inlinecode"><span class="id" type="var">y</span></span> appear free in <span class="inlinecode">(\<span class="id" type="var">x</span>:<span class="id" type="var">T</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">U</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">y</span>)</span> <span class="inlinecode"><span class="id" type="var">x</span></span> 

</li>
<li> no variables appear free in <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">T</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">U</span>.</span> <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">T</span>.</span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">y</span></span>  
</li>
</ul>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">appears_free_in</span> : <span class="id" type="var">id</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">afi_var</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">appears_free_in</span> <span class="id" type="var">x</span> (<span class="id" type="var">tvar</span> <span class="id" type="var">x</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">afi_app1</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">appears_free_in</span> <span class="id" type="var">x</span> <span class="id" type="var">t1</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">appears_free_in</span> <span class="id" type="var">x</span> (<span class="id" type="var">tapp</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">afi_app2</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">appears_free_in</span> <span class="id" type="var">x</span> <span class="id" type="var">t2</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">appears_free_in</span> <span class="id" type="var">x</span> (<span class="id" type="var">tapp</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">afi_abs</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">T11</span> <span class="id" type="var">t12</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">y</span> &lt;&gt; <span class="id" type="var">x</span>  <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">appears_free_in</span> <span class="id" type="var">x</span> <span class="id" type="var">t12</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">appears_free_in</span> <span class="id" type="var">x</span> (<span class="id" type="var">tabs</span> <span class="id" type="var">y</span> <span class="id" type="var">T11</span> <span class="id" type="var">t12</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">afi_if1</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">appears_free_in</span> <span class="id" type="var">x</span> <span class="id" type="var">t1</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">appears_free_in</span> <span class="id" type="var">x</span> (<span class="id" type="var">tif</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">afi_if2</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">appears_free_in</span> <span class="id" type="var">x</span> <span class="id" type="var">t2</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">appears_free_in</span> <span class="id" type="var">x</span> (<span class="id" type="var">tif</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">afi_if3</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">appears_free_in</span> <span class="id" type="var">x</span> <span class="id" type="var">t3</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">appears_free_in</span> <span class="id" type="var">x</span> (<span class="id" type="var">tif</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>).<br/>

<br/>
<div class="togglescript" id="proofcontrol9" onclick="toggleDisplay('proof9');toggleDisplay('proofcontrol9')"><span class="show"></span></div>
<div class="proofscript" id="proof9" onclick="toggleDisplay('proof9');toggleDisplay('proofcontrol9')">
<span class="id" type="keyword">Tactic Notation</span> "afi_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "afi_var"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "afi_app1" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "afi_app2" <br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "afi_abs" <br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "afi_if1" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "afi_if2" <br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "afi_if3" ].<br/>

<br/>
<span class="id" type="keyword">Hint</span> <span class="id" type="var">Constructors</span> <span class="id" type="var">appears_free_in</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
A term in which no variables appear free is said to be <i>closed</i>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">closed</span> (<span class="id" type="var">t</span>:<span class="id" type="var">tm</span>) :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span>, ~ <span class="id" type="var">appears_free_in</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab572"></a><h3 class="section">Substitution</h3>

<div class="paragraph"> </div>

 We first need a technical lemma connecting free variables and
    typing contexts.  If a variable <span class="inlinecode"><span class="id" type="var">x</span></span> appears free in a term <span class="inlinecode"><span class="id" type="var">t</span></span>,
    and if we know <span class="inlinecode"><span class="id" type="var">t</span></span> is well typed in context <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span>, then it must
    be the case that <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> assigns a type to <span class="inlinecode"><span class="id" type="var">x</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">free_in_context</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span> <span class="id" type="var">t</span> <span class="id" type="var">T</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span>,<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">appears_free_in</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">t</span> <span class="id" type="var">T</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span><span class="id" type="var">T'</span>, <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">x</span> = <span class="id" type="var">Some</span> <span class="id" type="var">T'</span>.<br/>

<br/>
</div>

<div class="doc">
<i>Proof</i>: We show, by induction on the proof that <span class="inlinecode"><span class="id" type="var">x</span></span> appears free
      in <span class="inlinecode"><span class="id" type="var">t</span></span>, that, for all contexts <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span>, if <span class="inlinecode"><span class="id" type="var">t</span></span> is well typed
      under <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span>, then <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> assigns some type to <span class="inlinecode"><span class="id" type="var">x</span></span>.

<div class="paragraph"> </div>

<ul class="doclist">
<li> If the last rule used was <span class="inlinecode"><span class="id" type="var">afi_var</span></span>, then <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">x</span></span>, and from
        the assumption that <span class="inlinecode"><span class="id" type="var">t</span></span> is well typed under <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> we have
        immediately that <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> assigns a type to <span class="inlinecode"><span class="id" type="var">x</span></span>.

<div class="paragraph"> </div>


</li>
<li> If the last rule used was <span class="inlinecode"><span class="id" type="var">afi_app1</span></span>, then <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">t1</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span> and <span class="inlinecode"><span class="id" type="var">x</span></span>
        appears free in <span class="inlinecode"><span class="id" type="var">t1</span></span>.  Since <span class="inlinecode"><span class="id" type="var">t</span></span> is well typed under <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span>,
        we can see from the typing rules that <span class="inlinecode"><span class="id" type="var">t1</span></span> must also be, and
        the IH then tells us that <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> assigns <span class="inlinecode"><span class="id" type="var">x</span></span> a type.

<div class="paragraph"> </div>


</li>
<li> Almost all the other cases are similar: <span class="inlinecode"><span class="id" type="var">x</span></span> appears free in a
        subterm of <span class="inlinecode"><span class="id" type="var">t</span></span>, and since <span class="inlinecode"><span class="id" type="var">t</span></span> is well typed under <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span>, we
        know the subterm of <span class="inlinecode"><span class="id" type="var">t</span></span> in which <span class="inlinecode"><span class="id" type="var">x</span></span> appears is well typed
        under <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> as well, and the IH gives us exactly the
        conclusion we want.

<div class="paragraph"> </div>


</li>
<li> The only remaining case is <span class="inlinecode"><span class="id" type="var">afi_abs</span></span>.  In this case <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">=</span>
        <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">T11.t12</span></span>, and <span class="inlinecode"><span class="id" type="var">x</span></span> appears free in <span class="inlinecode"><span class="id" type="var">t12</span></span>; we also know that
        <span class="inlinecode"><span class="id" type="var">x</span></span> is different from <span class="inlinecode"><span class="id" type="var">y</span></span>.  The difference from the previous
        cases is that whereas <span class="inlinecode"><span class="id" type="var">t</span></span> is well typed under <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span>, its
        body <span class="inlinecode"><span class="id" type="var">t12</span></span> is well typed under <span class="inlinecode">(<span style="font-family: serif; font-size:85%;">&Gamma;</span>,</span> <span class="inlinecode"><span class="id" type="var">y</span>:<span class="id" type="var">T11</span>)</span>, so the IH
        allows us to conclude that <span class="inlinecode"><span class="id" type="var">x</span></span> is assigned some type by the
        extended context <span class="inlinecode">(<span style="font-family: serif; font-size:85%;">&Gamma;</span>,</span> <span class="inlinecode"><span class="id" type="var">y</span>:<span class="id" type="var">T11</span>)</span>.  To conclude that <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span>
        assigns a type to <span class="inlinecode"><span class="id" type="var">x</span></span>, we appeal to lemma <span class="inlinecode"><span class="id" type="var">extend_neq</span></span>, noting
        that <span class="inlinecode"><span class="id" type="var">x</span></span> and <span class="inlinecode"><span class="id" type="var">y</span></span> are different variables. 
</li>
</ul>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span> <span class="id" type="var">T</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">H</span> <span class="id" type="var">H0</span>. <span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">T</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">afi_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">H</span>) <span class="id" type="var">Case</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">try</span> <span class="id" type="var">solve</span> [<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">eauto</span>].<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "afi_abs".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHappears_free_in</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H7</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">not_eq_beq_id_false</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">extend_neq</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H7</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Next, we'll need the fact that any term <span class="inlinecode"><span class="id" type="var">t</span></span> which is well typed in
    the empty context is closed &mdash; that is, it has no free variables. 
<div class="paragraph"> </div>

<a name="lab573"></a><h4 class="section">Exercise: 2 stars (typable_empty__closed)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Corollary</span> <span class="id" type="var">typable_empty__closed</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">t</span> <span class="id" type="var">T</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span class="id" type="var">empty</span> <span class="id" type="var">t</span> <span class="id" type="var">T</span>  <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">closed</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

 Sometimes, when we have a proof <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>, we will need to
    replace <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> by a different context <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span></span>.  When is it safe
    to do this?  Intuitively, it must at least be the case that
    <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span></span> assigns the same types as <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> to all the variables
    that appear free in <span class="inlinecode"><span class="id" type="var">t</span></span>. In fact, this is the only condition that
    is needed. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">context_invariance</span> : <span style="font-family: arial;">&forall;</span><span style="font-family: serif; font-size:85%;">&Gamma;</span> <span style="font-family: serif; font-size:85%;">&Gamma;'</span> <span class="id" type="var">t</span> <span class="id" type="var">T</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">t</span> <span class="id" type="var">T</span>  <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span style="font-family: arial;">&forall;</span><span class="id" type="var">x</span>, <span class="id" type="var">appears_free_in</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span> <span style="font-family: arial;">&rarr;</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">x</span> = <span style="font-family: serif; font-size:85%;">&Gamma;'</span> <span class="id" type="var">x</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span style="font-family: serif; font-size:85%;">&Gamma;'</span> <span class="id" type="var">t</span> <span class="id" type="var">T</span>.<br/>

<br/>
</div>

<div class="doc">
<i>Proof</i>: By induction on the derivation of <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>.

<div class="paragraph"> </div>

<ul class="doclist">
<li> If the last rule in the derivation was <span class="inlinecode"><span class="id" type="var">T_Var</span></span>, then <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">x</span></span>
        and <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">T</span></span>.  By assumption, <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">T</span></span> as well, and
        hence <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span> by <span class="inlinecode"><span class="id" type="var">T_Var</span></span>.

<div class="paragraph"> </div>


</li>
<li> If the last rule was <span class="inlinecode"><span class="id" type="var">T_Abs</span></span>, then <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">=</span> <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">T11</span>.</span> <span class="inlinecode"><span class="id" type="var">t12</span></span>, with <span class="inlinecode"><span class="id" type="var">T</span></span>
        <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">T11</span></span> <span class="inlinecode"><span style="font-family: arial;">&rarr;</span></span> <span class="inlinecode"><span class="id" type="var">T12</span></span> and <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span>,</span> <span class="inlinecode"><span class="id" type="var">y</span>:<span class="id" type="var">T11</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t12</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T12</span></span>.  The induction
        hypothesis is that for any context <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;''</span></span>, if <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span>,</span>
        <span class="inlinecode"><span class="id" type="var">y</span>:<span class="id" type="var">T11</span></span> and <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;''</span></span> assign the same types to all the free
        variables in <span class="inlinecode"><span class="id" type="var">t12</span></span>, then <span class="inlinecode"><span class="id" type="var">t12</span></span> has type <span class="inlinecode"><span class="id" type="var">T12</span></span> under <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;''</span></span>.
        Let <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span></span> be a context which agrees with <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> on the
        free variables in <span class="inlinecode"><span class="id" type="var">t</span></span>; we must show <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">T11</span>.</span> <span class="inlinecode"><span class="id" type="var">t12</span></span> <span class="inlinecode">:</span>
        <span class="inlinecode"><span class="id" type="var">T11</span></span> <span class="inlinecode"><span style="font-family: arial;">&rarr;</span></span> <span class="inlinecode"><span class="id" type="var">T12</span></span>.

<div class="paragraph"> </div>

        By <span class="inlinecode"><span class="id" type="var">T_Abs</span></span>, it suffices to show that <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span>,</span> <span class="inlinecode"><span class="id" type="var">y</span>:<span class="id" type="var">T11</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t12</span></span> <span class="inlinecode">:</span>
        <span class="inlinecode"><span class="id" type="var">T12</span></span>.  By the IH (setting <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;''</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span>,</span> <span class="inlinecode"><span class="id" type="var">y</span>:<span class="id" type="var">T11</span></span>), it
        suffices to show that <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span>,</span> <span class="inlinecode"><span class="id" type="var">y</span>:<span class="id" type="var">T11</span></span> and <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span>,</span> <span class="inlinecode"><span class="id" type="var">y</span>:<span class="id" type="var">T11</span></span> agree
        on all the variables that appear free in <span class="inlinecode"><span class="id" type="var">t12</span></span>.  

<div class="paragraph"> </div>

        Any variable occurring free in <span class="inlinecode"><span class="id" type="var">t12</span></span> must either be <span class="inlinecode"><span class="id" type="var">y</span></span>, or
        some other variable.  <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span>,</span> <span class="inlinecode"><span class="id" type="var">y</span>:<span class="id" type="var">T11</span></span> and <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span>,</span> <span class="inlinecode"><span class="id" type="var">y</span>:<span class="id" type="var">T11</span></span>
        clearly agree on <span class="inlinecode"><span class="id" type="var">y</span></span>.  Otherwise, we note that any variable
        other than <span class="inlinecode"><span class="id" type="var">y</span></span> which occurs free in <span class="inlinecode"><span class="id" type="var">t12</span></span> also occurs free in
        <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">=</span> <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">T11</span>.</span> <span class="inlinecode"><span class="id" type="var">t12</span></span>, and by assumption <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> and <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span></span>
        agree on all such variables, and hence so do <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span>,</span> <span class="inlinecode"><span class="id" type="var">y</span>:<span class="id" type="var">T11</span></span>
        and <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span>,</span> <span class="inlinecode"><span class="id" type="var">y</span>:<span class="id" type="var">T11</span></span>.

<div class="paragraph"> </div>


</li>
<li> If the last rule was <span class="inlinecode"><span class="id" type="var">T_App</span></span>, then <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">t1</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span>, with <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span>
        <span class="inlinecode"><span class="id" type="var">t1</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T2</span></span> <span class="inlinecode"><span style="font-family: arial;">&rarr;</span></span> <span class="inlinecode"><span class="id" type="var">T</span></span> and <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T2</span></span>.  One induction
        hypothesis states that for all contexts <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span></span>, if <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span></span>
        agrees with <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> on the free variables in <span class="inlinecode"><span class="id" type="var">t1</span></span>, then <span class="inlinecode"><span class="id" type="var">t1</span></span>
        has type <span class="inlinecode"><span class="id" type="var">T2</span></span> <span class="inlinecode"><span style="font-family: arial;">&rarr;</span></span> <span class="inlinecode"><span class="id" type="var">T</span></span> under <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span></span>; there is a similar IH for
        <span class="inlinecode"><span class="id" type="var">t2</span></span>.  We must show that <span class="inlinecode"><span class="id" type="var">t1</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span> also has type <span class="inlinecode"><span class="id" type="var">T</span></span> under
        <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span></span>, given the assumption that <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span></span> agrees with
        <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> on all the free variables in <span class="inlinecode"><span class="id" type="var">t1</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span>.  By <span class="inlinecode"><span class="id" type="var">T_App</span></span>, it
        suffices to show that <span class="inlinecode"><span class="id" type="var">t1</span></span> and <span class="inlinecode"><span class="id" type="var">t2</span></span> each have the same type
        under <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span></span> as under <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span>.  However, we note that all
        free variables in <span class="inlinecode"><span class="id" type="var">t1</span></span> are also free in <span class="inlinecode"><span class="id" type="var">t1</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span>, and similarly
        for free variables in <span class="inlinecode"><span class="id" type="var">t2</span></span>; hence the desired result follows
        by the two IHs.

</li>
</ul>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Proof</span> <span class="id" type="keyword">with</span> <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span style="font-family: serif; font-size:85%;">&Gamma;'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">has_type_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">H</span>) <span class="id" type="var">Case</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "T_Var".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">T_Var</span>. <span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">H0</span>...<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "T_Abs".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">T_Abs</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHhas_type</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">x1</span> <span class="id" type="var">Hafi</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;the&nbsp;only&nbsp;tricky&nbsp;step...&nbsp;the&nbsp;<span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span></span>&nbsp;we&nbsp;use&nbsp;to&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instantiate&nbsp;is&nbsp;<span class="inlinecode"><span class="id" type="var">extend</span></span> <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">T11</span></span>&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">extend</span>. <span class="id" type="var">remember</span> (<span class="id" type="var">beq_id</span> <span class="id" type="var">x0</span> <span class="id" type="var">x1</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">e</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">e</span>...<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "T_App".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">T_App</span> <span class="id" type="keyword">with</span> <span class="id" type="var">T11</span>...<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Now we come to the conceptual heart of the proof that reduction
    preserves types &mdash; namely, the observation that <i>substitution</i>
    preserves types.

<div class="paragraph"> </div>

    Formally, the so-called <i>Substitution Lemma</i> says this: suppose we
    have a term <span class="inlinecode"><span class="id" type="var">t</span></span> with a free variable <span class="inlinecode"><span class="id" type="var">x</span></span>, and suppose we've been
    able to assign a type <span class="inlinecode"><span class="id" type="var">T</span></span> to <span class="inlinecode"><span class="id" type="var">t</span></span> under the assumption that <span class="inlinecode"><span class="id" type="var">x</span></span> has
    some type <span class="inlinecode"><span class="id" type="var">U</span></span>.  Also, suppose that we have some other term <span class="inlinecode"><span class="id" type="var">v</span></span> and
    that we've shown that <span class="inlinecode"><span class="id" type="var">v</span></span> has type <span class="inlinecode"><span class="id" type="var">U</span></span>.  Then, since <span class="inlinecode"><span class="id" type="var">v</span></span> satisfies
    the assumption we made about <span class="inlinecode"><span class="id" type="var">x</span></span> when typing <span class="inlinecode"><span class="id" type="var">t</span></span>, we should be
    able to substitute <span class="inlinecode"><span class="id" type="var">v</span></span> for each of the occurrences of <span class="inlinecode"><span class="id" type="var">x</span></span> in <span class="inlinecode"><span class="id" type="var">t</span></span>
    and obtain a new term that still has type <span class="inlinecode"><span class="id" type="var">T</span></span>. 
<div class="paragraph"> </div>

 <i>Lemma</i>: If <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span>,<span class="id" type="var">x</span>:<span class="id" type="var">U</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span> and <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">v</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">U</span></span>, then <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span>
    <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">v</span>]<span class="id" type="var">t</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">substitution_preserves_typing</span> : <span style="font-family: arial;">&forall;</span><span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">x</span> <span class="id" type="var">U</span> <span class="id" type="var">t</span> <span class="id" type="var">t'</span> <span class="id" type="var">T</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> (<span class="id" type="var">extend</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">x</span> <span class="id" type="var">U</span>) <span class="id" type="var">t</span> <span class="id" type="var">T</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span class="id" type="var">empty</span> <span class="id" type="var">t'</span> <span class="id" type="var">U</span>   <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> ([<span class="id" type="var">x</span>:=<span class="id" type="var">t'</span>]<span class="id" type="var">t</span>) <span class="id" type="var">T</span>.<br/>

<br/>
</div>

<div class="doc">
One technical subtlety in the statement of the lemma is that we
    assign <span class="inlinecode"><span class="id" type="var">t'</span></span> the type <span class="inlinecode"><span class="id" type="var">U</span></span> in the <i>empty</i> context &mdash; in other words,
    we assume <span class="inlinecode"><span class="id" type="var">t'</span></span> is closed.  This assumption considerably simplifies
    the <span class="inlinecode"><span class="id" type="var">T_Abs</span></span> case of the proof (compared to assuming <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t'</span></span> <span class="inlinecode">:</span>
    <span class="inlinecode"><span class="id" type="var">U</span></span>, which would be the other reasonable assumption at this point)
    because the context invariance lemma then tells us that <span class="inlinecode"><span class="id" type="var">t'</span></span> has
    type <span class="inlinecode"><span class="id" type="var">U</span></span> in any context at all &mdash; we don't have to worry about
    free variables in <span class="inlinecode"><span class="id" type="var">t'</span></span> clashing with the variable being introduced
    into the context by <span class="inlinecode"><span class="id" type="var">T_Abs</span></span>.

<div class="paragraph"> </div>

    <i>Proof</i>: We prove, by induction on <span class="inlinecode"><span class="id" type="var">t</span></span>, that, for all <span class="inlinecode"><span class="id" type="var">T</span></span> and
    <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span>, if <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span>,<span class="id" type="var">x</span>:<span class="id" type="var">U</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span> and <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t'</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">U</span></span>, then <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span>
    <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">t'</span>]<span class="id" type="var">t</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>.

<div class="paragraph"> </div>

<ul class="doclist">
<li> If <span class="inlinecode"><span class="id" type="var">t</span></span> is a variable, there are two cases to consider, depending
        on whether <span class="inlinecode"><span class="id" type="var">t</span></span> is <span class="inlinecode"><span class="id" type="var">x</span></span> or some other variable.

<div class="paragraph"> </div>

<ul class="doclist">
<li> If <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">x</span></span>, then from the fact that <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span>,</span> <span class="inlinecode"><span class="id" type="var">x</span>:<span class="id" type="var">U</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span> we
            conclude that <span class="inlinecode"><span class="id" type="var">U</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">T</span></span>.  We must show that <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">t'</span>]<span class="id" type="var">x</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">t'</span></span> has
            type <span class="inlinecode"><span class="id" type="var">T</span></span> under <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span>, given the assumption that <span class="inlinecode"><span class="id" type="var">t'</span></span> has
            type <span class="inlinecode"><span class="id" type="var">U</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">T</span></span> under the empty context.  This follows from
            context invariance: if a closed term has type <span class="inlinecode"><span class="id" type="var">T</span></span> in the
            empty context, it has that type in any context.

<div class="paragraph"> </div>


</li>
<li> If <span class="inlinecode"><span class="id" type="var">t</span></span> is some variable <span class="inlinecode"><span class="id" type="var">y</span></span> that is not equal to <span class="inlinecode"><span class="id" type="var">x</span></span>, then
            we need only note that <span class="inlinecode"><span class="id" type="var">y</span></span> has the same type under <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span>,</span>
            <span class="inlinecode"><span class="id" type="var">x</span>:<span class="id" type="var">U</span></span> as under <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span>.

<div class="paragraph"> </div>


</li>
</ul>

</li>
<li> If <span class="inlinecode"><span class="id" type="var">t</span></span> is an abstraction <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">T11</span>.</span> <span class="inlinecode"><span class="id" type="var">t12</span></span>, then the IH tells us,
        for all <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span></span> and <span class="inlinecode"><span class="id" type="var">T'</span></span>, that if <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span>,<span class="id" type="var">x</span>:<span class="id" type="var">U</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t12</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T'</span></span>
        and <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t'</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">U</span></span>, then <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;'</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">t'</span>]<span class="id" type="var">t12</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T'</span></span>.

<div class="paragraph"> </div>

        The substitution in the conclusion behaves differently,
        depending on whether <span class="inlinecode"><span class="id" type="var">x</span></span> and <span class="inlinecode"><span class="id" type="var">y</span></span> are the same variable name.

<div class="paragraph"> </div>

        First, suppose <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">y</span></span>.  Then, by the definition of
        substitution, <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">t'</span>]<span class="id" type="var">t</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">t</span></span>, so we just need to show <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span>
        <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>.  But we know <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span>,<span class="id" type="var">x</span>:<span class="id" type="var">U</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>, and since the
        variable <span class="inlinecode"><span class="id" type="var">y</span></span> does not appear free in <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">T11</span>.</span> <span class="inlinecode"><span class="id" type="var">t12</span></span>, the
        context invariance lemma yields <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>.

<div class="paragraph"> </div>

        Second, suppose <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">&lt;&gt;</span> <span class="inlinecode"><span class="id" type="var">y</span></span>.  We know <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span>,<span class="id" type="var">x</span>:<span class="id" type="var">U</span>,<span class="id" type="var">y</span>:<span class="id" type="var">T11</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t12</span></span> <span class="inlinecode">:</span>
        <span class="inlinecode"><span class="id" type="var">T12</span></span> by inversion of the typing relation, and <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span>,<span class="id" type="var">y</span>:<span class="id" type="var">T11</span>,<span class="id" type="var">x</span>:<span class="id" type="var">U</span></span>
        <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t12</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T12</span></span> follows from this by the context invariance
        lemma, so the IH applies, giving us <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span>,<span class="id" type="var">y</span>:<span class="id" type="var">T11</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">t'</span>]<span class="id" type="var">t12</span></span> <span class="inlinecode">:</span>
        <span class="inlinecode"><span class="id" type="var">T12</span></span>.  By <span class="inlinecode"><span class="id" type="var">T_Abs</span></span>, <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">T11</span>.</span> <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">t'</span>]<span class="id" type="var">t12</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T11</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">T12</span></span>, and
        by the definition of substitution (noting that <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">&lt;&gt;</span> <span class="inlinecode"><span class="id" type="var">y</span></span>),
        <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode">\<span class="id" type="var">y</span>:<span class="id" type="var">T11</span>.</span> <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">t'</span>]<span class="id" type="var">t12</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T11</span><span style="font-family: arial;">&rarr;</span><span class="id" type="var">T12</span></span> as required. 

<div class="paragraph"> </div>


</li>
<li> If <span class="inlinecode"><span class="id" type="var">t</span></span> is an application <span class="inlinecode"><span class="id" type="var">t1</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span>, the result follows
        straightforwardly from the definition of substitution and the
        induction hypotheses.

<div class="paragraph"> </div>


</li>
<li> The remaining cases are similar to the application case.

</li>
</ul>

<div class="paragraph"> </div>

    Another technical note: This proof is a rare case where an
    induction on terms, rather than typing derivations, yields a
    simpler argument.  The reason for this is that the assumption
    <span class="inlinecode"><span class="id" type="var">has_type</span></span> <span class="inlinecode">(<span class="id" type="var">extend</span></span> <span class="inlinecode"><span style="font-family: serif; font-size:85%;">&Gamma;</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">U</span>)</span> <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode"><span class="id" type="var">T</span></span> is not completely generic, in
    the sense that one of the "slots" in the typing relation &mdash; namely
    the context &mdash; is not just a variable, and this means that Coq's
    native induction tactic does not give us the induction hypothesis
    that we want.  It is possible to work around this, but the needed
    generalization is a little tricky.  The term <span class="inlinecode"><span class="id" type="var">t</span></span>, on the other
    hand, <i>is</i> completely generic. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Proof</span> <span class="id" type="keyword">with</span> <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">x</span> <span class="id" type="var">U</span> <span class="id" type="var">t</span> <span class="id" type="var">t'</span> <span class="id" type="var">T</span> <span class="id" type="var">Ht</span> <span class="id" type="var">Ht'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span>. <span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">T</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">t_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">t</span>) <span class="id" type="var">Case</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">T</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span> <span class="id" type="var">H</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;in&nbsp;each&nbsp;case,&nbsp;we'll&nbsp;want&nbsp;to&nbsp;get&nbsp;at&nbsp;the&nbsp;derivation&nbsp;of&nbsp;H&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>...<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "tvar".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rename</span> <span class="id" type="var">i</span> <span class="id" type="var">into</span> <span class="id" type="var">y</span>. <span class="id" type="var">remember</span> (<span class="id" type="var">beq_id</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">e</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "x=y".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">beq_id_eq</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqe</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">extend_eq</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">context_invariance</span>... <span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">Hcontra</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">free_in_context</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">T</span> <span class="id" type="var">empty</span> <span class="id" type="var">Hcontra</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">T'</span> <span class="id" type="var">HT'</span>]...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">HT'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "x&lt;&gt;y".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">T_Var</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">extend_neq</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>...<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "tabs".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rename</span> <span class="id" type="var">i</span> <span class="id" type="var">into</span> <span class="id" type="var">y</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">T_Abs</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">beq_id</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">e</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "x=y".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">context_invariance</span>...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">beq_id_eq</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqe</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">Hafi</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">extend</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">beq_id</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>)...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "x&lt;&gt;y".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHt</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">context_invariance</span>...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">Hafi</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">extend</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">beq_id</span> <span class="id" type="var">y</span> <span class="id" type="var">z</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">e0</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">e0</span>...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">beq_id_eq</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqe0</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">Heqe</span>...<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
The substitution lemma can be viewed as a kind of "commutation"
    property.  Intuitively, it says that substitution and typing can
    be done in either order: we can either assign types to the terms
    <span class="inlinecode"><span class="id" type="var">t</span></span> and <span class="inlinecode"><span class="id" type="var">v</span></span> separately (under suitable contexts) and then combine
    them using substitution, or we can substitute first and then
    assign a type to <span class="inlinecode"></span> <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">v</span>]</span> <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode"></span> &mdash; the result is the same either
    way. 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab574"></a><h3 class="section">Preservation</h3>

<div class="paragraph"> </div>

 We now have the tools we need to prove <i>preservation</i>: if a closed
    term <span class="inlinecode"><span class="id" type="var">t</span></span> has type <span class="inlinecode"><span class="id" type="var">T</span></span>, and takes an evaluation step to <span class="inlinecode"><span class="id" type="var">t'</span></span>, then <span class="inlinecode"><span class="id" type="var">t'</span></span>
    is also a closed term with type <span class="inlinecode"><span class="id" type="var">T</span></span>.  In other words, the small-step
    evaluation relation preserves types.

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">preservation</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">t</span> <span class="id" type="var">t'</span> <span class="id" type="var">T</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span class="id" type="var">empty</span> <span class="id" type="var">t</span> <span class="id" type="var">T</span>  <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">t</span> <span style="font-family: arial;">&rArr;</span> <span class="id" type="var">t'</span>  <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span class="id" type="var">empty</span> <span class="id" type="var">t'</span> <span class="id" type="var">T</span>.<br/>

<br/>
</div>

<div class="doc">
<i>Proof</i>: by induction on the derivation of <span class="inlinecode"><span style="font-family: arial;">&#8866;</span></span> <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">T</span></span>.

<div class="paragraph"> </div>

<ul class="doclist">
<li> We can immediately rule out <span class="inlinecode"><span class="id" type="var">T_Var</span></span>, <span class="inlinecode"><span class="id" type="var">T_Abs</span></span>, <span class="inlinecode"><span class="id" type="var">T_True</span></span>, and
      <span class="inlinecode"><span class="id" type="var">T_False</span></span> as the final rules in the derivation, since in each of
      these cases <span class="inlinecode"><span class="id" type="var">t</span></span> cannot take a step.

<div class="paragraph"> </div>


</li>
<li> If the last rule in the derivation was <span class="inlinecode"><span class="id" type="var">T_App</span></span>, then <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">t1</span></span>
      <span class="inlinecode"><span class="id" type="var">t2</span></span>.  There are three cases to consider, one for each rule that
      could have been used to show that <span class="inlinecode"><span class="id" type="var">t1</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span> takes a step to <span class="inlinecode"><span class="id" type="var">t'</span></span>.

<div class="paragraph"> </div>

<ul class="doclist">
<li> If <span class="inlinecode"><span class="id" type="var">t1</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span> takes a step by <span class="inlinecode"><span class="id" type="var">ST_App1</span></span>, with <span class="inlinecode"><span class="id" type="var">t1</span></span> stepping to
          <span class="inlinecode"><span class="id" type="var">t1'</span></span>, then by the IH <span class="inlinecode"><span class="id" type="var">t1'</span></span> has the same type as <span class="inlinecode"><span class="id" type="var">t1</span></span>, and
          hence <span class="inlinecode"><span class="id" type="var">t1'</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span> has the same type as <span class="inlinecode"><span class="id" type="var">t1</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span>.

<div class="paragraph"> </div>


</li>
<li> The <span class="inlinecode"><span class="id" type="var">ST_App2</span></span> case is similar.

<div class="paragraph"> </div>


</li>
<li> If <span class="inlinecode"><span class="id" type="var">t1</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span> takes a step by <span class="inlinecode"><span class="id" type="var">ST_AppAbs</span></span>, then <span class="inlinecode"><span class="id" type="var">t1</span></span> <span class="inlinecode">=</span>
          <span class="inlinecode">\<span class="id" type="var">x</span>:<span class="id" type="var">T11.t12</span></span> and <span class="inlinecode"><span class="id" type="var">t1</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span> steps to <span class="inlinecode">[<span class="id" type="var">x</span>:=<span class="id" type="var">t2</span>]<span class="id" type="var">t12</span></span>; the
          desired result now follows from the fact that substitution
          preserves types.

<div class="paragraph"> </div>


</li>
</ul>

</li>
<li> If the last rule in the derivation was <span class="inlinecode"><span class="id" type="var">T_If</span></span>, then <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="keyword">if</span></span> <span class="inlinecode"><span class="id" type="var">t1</span></span>
      <span class="inlinecode"><span class="id" type="keyword">then</span></span> <span class="inlinecode"><span class="id" type="var">t2</span></span> <span class="inlinecode"><span class="id" type="keyword">else</span></span> <span class="inlinecode"><span class="id" type="var">t3</span></span>, and there are again three cases depending on
      how <span class="inlinecode"><span class="id" type="var">t</span></span> steps.

<div class="paragraph"> </div>

<ul class="doclist">
<li> If <span class="inlinecode"><span class="id" type="var">t</span></span> steps to <span class="inlinecode"><span class="id" type="var">t2</span></span> or <span class="inlinecode"><span class="id" type="var">t3</span></span>, the result is immediate, since
          <span class="inlinecode"><span class="id" type="var">t2</span></span> and <span class="inlinecode"><span class="id" type="var">t3</span></span> have the same type as <span class="inlinecode"><span class="id" type="var">t</span></span>.

<div class="paragraph"> </div>


</li>
<li> Otherwise, <span class="inlinecode"><span class="id" type="var">t</span></span> steps by <span class="inlinecode"><span class="id" type="var">ST_If</span></span>, and the desired conclusion
          follows directly from the induction hypothesis.

</li>
</ul>

</li>
</ul>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Proof</span> <span class="id" type="keyword">with</span> <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (@<span class="id" type="var">empty</span> <span class="id" type="var">ty</span>) <span class="id" type="keyword">as</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t'</span> <span class="id" type="var">T</span> <span class="id" type="var">HT</span>. <span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">t'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">has_type_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">HT</span>) <span class="id" type="var">Case</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t'</span> <span class="id" type="var">HE</span>; <span class="id" type="tactic">subst</span> <span style="font-family: serif; font-size:85%;">&Gamma;</span>; <span class="id" type="tactic">subst</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="var">solve</span> [<span class="id" type="tactic">inversion</span> <span class="id" type="var">HE</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">auto</span>].<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "T_App".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">HE</span>; <span class="id" type="tactic">subst</span>...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Most&nbsp;of&nbsp;the&nbsp;cases&nbsp;are&nbsp;immediate&nbsp;by&nbsp;induction,&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;<span class="inlinecode"><span class="id" type="tactic">eauto</span></span>&nbsp;takes&nbsp;care&nbsp;of&nbsp;them&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "ST_AppAbs".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">substitution_preserves_typing</span> <span class="id" type="keyword">with</span> <span class="id" type="var">T11</span>...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">HT1</span>...<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab575"></a><h4 class="section">Exercise: 2 stars, recommended (subject_expansion_stlc)</h4>
 An exercise in Types.v asked about the subject
    expansion property for the simple language of arithmetic and
    boolean expressions.  Does this property hold for STLC?  That
    is, is it always the case that, if <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode"><span style="font-family: arial;">&rArr;</span></span> <span class="inlinecode"><span class="id" type="var">t'</span></span> and <span class="inlinecode"><span class="id" type="var">has_type</span></span>
    <span class="inlinecode"><span class="id" type="var">t'</span></span> <span class="inlinecode"><span class="id" type="var">T</span></span>, then <span class="inlinecode"><span class="id" type="var">has_type</span></span> <span class="inlinecode"><span class="id" type="var">t</span></span> <span class="inlinecode"><span class="id" type="var">T</span></span>?  If so, prove it.  If not, give a
    counter-example.

<div class="paragraph"> </div>

<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
<font size=-2>&#9744;</font>

</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab576"></a><h3 class="section">Type Soundness</h3>

<div class="paragraph"> </div>

<a name="lab577"></a><h4 class="section">Exercise: 2 stars, optional (type_soundness)</h4>

<div class="paragraph"> </div>

 Put progress and preservation together and show that a well-typed
    term can <i>never</i> reach a stuck state.  
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">stuck</span> (<span class="id" type="var">t</span>:<span class="id" type="var">tm</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;(<span class="id" type="var">normal_form</span> <span class="id" type="var">step</span>) <span class="id" type="var">t</span> <span style="font-family: arial;">&and;</span> ~ <span class="id" type="var">value</span> <span class="id" type="var">t</span>.<br/>

<br/>
<span class="id" type="keyword">Corollary</span> <span class="id" type="var">soundness</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">t</span> <span class="id" type="var">t'</span> <span class="id" type="var">T</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">has_type</span> <span class="id" type="var">empty</span> <span class="id" type="var">t</span> <span class="id" type="var">T</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;<span class="id" type="var">t</span> <span style="font-family: arial;">&rArr;*</span> <span class="id" type="var">t'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;~(<span class="id" type="var">stuck</span> <span class="id" type="var">t'</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t'</span> <span class="id" type="var">T</span> <span class="id" type="var">Hhas_type</span> <span class="id" type="var">Hmulti</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">stuck</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> [<span class="id" type="var">Hnf</span> <span class="id" type="var">Hnot_val</span>]. <span class="id" type="tactic">unfold</span> <span class="id" type="var">normal_form</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hnf</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">Hmulti</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab578"></a><h3 class="section">Uniqueness of Types</h3>

<div class="paragraph"> </div>

<a name="lab579"></a><h4 class="section">Exercise: 3 stars (types_unique)</h4>
 Another pleasant property of the STLC is that types are
    unique: a given term (in a given context) has at most one
    type.  Formalize this statement and prove it. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab580"></a><h2 class="section">Additional Exercises</h2>

<div class="paragraph"> </div>

<a name="lab581"></a><h4 class="section">Exercise: 1 star (progress_preservation_statement)</h4>
 Without peeking, write down the progress and preservation
    theorems for the simply typed lambda-calculus.  <font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab582"></a><h4 class="section">Exercise: 2 stars (stlc_variation1)</h4>
 Suppose we add a new term <span class="inlinecode"><span class="id" type="var">zap</span></span> with the following reduction rule:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (ST_Zap) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">t&nbsp;<span style="font-family: arial;">&rArr;</span>&nbsp;zap</td>
  <td></td>
</td>
</table></center>and the following typing rule:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (T_Zap) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;zap&nbsp;:&nbsp;T</td>
  <td></td>
</td>
</table></center>    Which of the following properties of the STLC remain true in
    the presence of this rule?  For each one, write either
    "remains true" or else "becomes false." If a property becomes
    false, give a counterexample.

<div class="paragraph"> </div>

<ul class="doclist">
<li> Determinism of <span class="inlinecode"><span class="id" type="var">step</span></span>

<div class="paragraph"> </div>


</li>
<li> Progress

<div class="paragraph"> </div>


</li>
<li> Preservation

</li>
</ul>

<div class="paragraph"> </div>

<font size=-2>&#9744;</font>

<div class="paragraph"> </div>

<a name="lab583"></a><h4 class="section">Exercise: 2 stars (stlc_variation2)</h4>
 Suppose instead that we add a new term <span class="inlinecode"><span class="id" type="var">foo</span></span> with the following reduction rules:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (ST_Foo1) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">(\x:A.&nbsp;x)&nbsp;<span style="font-family: arial;">&rArr;</span>&nbsp;foo</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (ST_Foo2) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">foo&nbsp;<span style="font-family: arial;">&rArr;</span>&nbsp;true</td>
  <td></td>
</td>
</table></center>    Which of the following properties of the STLC remain true in
    the presence of this rule?  For each one, write either
    "remains true" or else "becomes false." If a property becomes
    false, give a counterexample.

<div class="paragraph"> </div>

<ul class="doclist">
<li> Determinism of <span class="inlinecode"><span class="id" type="var">step</span></span>

<div class="paragraph"> </div>


</li>
<li> Progress

<div class="paragraph"> </div>


</li>
<li> Preservation

</li>
</ul>

<div class="paragraph"> </div>

<font size=-2>&#9744;</font>

<div class="paragraph"> </div>

<a name="lab584"></a><h4 class="section">Exercise: 2 stars (stlc_variation3)</h4>
 Suppose instead that we remove the rule <span class="inlinecode"><span class="id" type="var">ST_App1</span></span> from the <span class="inlinecode"><span class="id" type="var">step</span></span>
    relation. Which of the following properties of the STLC remain
    true in the presence of this rule?  For each one, write either
    "remains true" or else "becomes false." If a property becomes
    false, give a counterexample.

<div class="paragraph"> </div>

<ul class="doclist">
<li> Determinism of <span class="inlinecode"><span class="id" type="var">step</span></span>

<div class="paragraph"> </div>


</li>
<li> Progress

<div class="paragraph"> </div>


</li>
<li> Preservation

</li>
</ul>

<div class="paragraph"> </div>

<font size=-2>&#9744;</font>

<div class="paragraph"> </div>

<a name="lab585"></a><h4 class="section">Exercise: 2 stars (stlc_variation4)</h4>
 Suppose instead that we add the following new rule to the reduction relation:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (ST_FunnyIfTrue) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">(if&nbsp;true&nbsp;then&nbsp;t1&nbsp;else&nbsp;t2)&nbsp;<span style="font-family: arial;">&rArr;</span>&nbsp;true</td>
  <td></td>
</td>
</table></center>    Which of the following properties of the STLC remain true in
    the presence of this rule?  For each one, write either
    "remains true" or else "becomes false." If a property becomes
    false, give a counterexample.

<div class="paragraph"> </div>

<ul class="doclist">
<li> Determinism of <span class="inlinecode"><span class="id" type="var">step</span></span>

<div class="paragraph"> </div>


</li>
<li> Progress

<div class="paragraph"> </div>


</li>
<li> Preservation

</li>
</ul>

<div class="paragraph"> </div>


<div class="paragraph"> </div>

<a name="lab586"></a><h4 class="section">Exercise: 2 stars (stlc_variation5)</h4>
 Suppose instead that we add the following new rule to the typing relation:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;t1&nbsp;:&nbsp;Bool->Bool->Bool</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;t2&nbsp;:&nbsp;Bool</td>
  <td class="infrulenamecol" rowspan="3">
    (T_FunnyApp) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;t1&nbsp;t2&nbsp;:&nbsp;Bool</td>
  <td></td>
</td>
</table></center>    Which of the following properties of the STLC remain true in
    the presence of this rule?  For each one, write either
    "remains true" or else "becomes false." If a property becomes
    false, give a counterexample.

<div class="paragraph"> </div>

<ul class="doclist">
<li> Determinism of <span class="inlinecode"><span class="id" type="var">step</span></span>

<div class="paragraph"> </div>


</li>
<li> Progress

<div class="paragraph"> </div>


</li>
<li> Preservation

</li>
</ul>

<div class="paragraph"> </div>


<div class="paragraph"> </div>

<a name="lab587"></a><h4 class="section">Exercise: 2 stars (stlc_variation6)</h4>
 Suppose instead that we add the following new rule to the typing relation:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;t1&nbsp;:&nbsp;Bool</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;t2&nbsp;:&nbsp;Bool</td>
  <td class="infrulenamecol" rowspan="3">
    (T_FunnyApp') &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: serif; font-size:85%;">&Gamma;</span>&nbsp;<span style="font-family: arial;">&#8866;</span>&nbsp;t1&nbsp;t2&nbsp;:&nbsp;Bool</td>
  <td></td>
</td>
</table></center>    Which of the following properties of the STLC remain true in
    the presence of this rule?  For each one, write either
    "remains true" or else "becomes false." If a property becomes
    false, give a counterexample.

<div class="paragraph"> </div>

<ul class="doclist">
<li> Determinism of <span class="inlinecode"><span class="id" type="var">step</span></span>

<div class="paragraph"> </div>


</li>
<li> Progress

<div class="paragraph"> </div>


</li>
<li> Preservation

</li>
</ul>

<div class="paragraph"> </div>


<div class="paragraph"> </div>

<a name="lab588"></a><h4 class="section">Exercise: 2 stars (stlc_variation7)</h4>
 Suppose we add the following new rule to the typing
    relation of the STLC:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (T_FunnyAbs) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: arial;">&#8866;</span>&nbsp;\x:Bool.t&nbsp;:&nbsp;Bool</td>
  <td></td>
</td>
</table></center>    Which of the following properties of the STLC remain true in
    the presence of this rule?  For each one, write either
    "remains true" or else "becomes false." If a property becomes
    false, give a counterexample.

<div class="paragraph"> </div>

<ul class="doclist">
<li> Determinism of <span class="inlinecode"><span class="id" type="var">step</span></span>

<div class="paragraph"> </div>


</li>
<li> Progress

<div class="paragraph"> </div>


</li>
<li> Preservation

</li>
</ul>

<div class="paragraph"> </div>

<font size=-2>&#9744;</font>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">STLC</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab589"></a><h1 class="section">Optional Exercise: STLC with Arithmetic</h1>

<div class="paragraph"> </div>

 To see how the STLC might function as the core of a real
    programming language, let's extend it with a concrete base
    type of numbers and some constants and primitive
    operators. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">STLCArith</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab590"></a><h2 class="section">Syntax and Operational Semantics</h2>

<div class="paragraph"> </div>

 To types, we add a base type of natural numbers (and remove
    booleans, for brevity) 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">ty</span> : <span class="id" type="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">TArrow</span> : <span class="id" type="var">ty</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">ty</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">ty</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">TNat</span>   : <span class="id" type="var">ty</span>.<br/>

<br/>
</div>

<div class="doc">
To terms, we add natural number constants, along with
    successor, predecessor, multiplication, and zero-testing... 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">tm</span> : <span class="id" type="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">tvar</span> : <span class="id" type="var">id</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">tapp</span> : <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">tabs</span> : <span class="id" type="var">id</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">ty</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">tnat</span>  : <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">tsucc</span> : <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">tpred</span> : <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">tmult</span> : <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">tif0</span>  : <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">tm</span>.<br/>

<br/>
<div class="togglescript" id="proofcontrol10" onclick="toggleDisplay('proof10');toggleDisplay('proofcontrol10')"><span class="show"></span></div>
<div class="proofscript" id="proof10" onclick="toggleDisplay('proof10');toggleDisplay('proofcontrol10')">
<span class="id" type="keyword">Tactic Notation</span> "t_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "tvar" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "tapp" <br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "tabs" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "tnat" <br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "tsucc" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "tpred"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "tmult" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "tif0" ].<br/>
</div>

<br/>
</div>

<div class="doc">
<a name="lab591"></a><h4 class="section">Exercise: 4 stars, optional (stlc_arith)</h4>
 Finish formalizing the definition and properties of the STLC extended
    with arithmetic.  Specifically:

<div class="paragraph"> </div>

<ul class="doclist">
<li> Copy the whole development of STLC that we went through above (from
      the definition of values through the Progress theorem), and
      paste it into the file at this point.

<div class="paragraph"> </div>


</li>
<li> Extend the definitions of the <span class="inlinecode"><span class="id" type="tactic">subst</span></span> operation and the <span class="inlinecode"><span class="id" type="var">step</span></span>
      relation to include appropriate clauses for the arithmetic operators.

<div class="paragraph"> </div>


</li>
<li> Extend the proofs of all the properties of the original STLC to deal
      with the new syntactic forms.  Make sure Coq accepts the whole file. 
</li>
</ul>

</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">STLCArith</span>.<br/>

<br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a><hr/>This page has been generated by <a href="http://www.lix.polytechnique.fr/coq/">coqdoc</a>
</div>

</div>

</body>
</html>